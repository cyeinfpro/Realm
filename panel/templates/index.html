{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col">
    <h1 class="h1">控制台</h1>
    <p class="muted">集中管理节点接入与转发策略</p>
  </div>
  <div class="col right">
    <a class="btn" href="/nodes/new">接入节点</a>
  </div>
</div>

<div class="grid">
  {% for n in nodes %}
  <div class="card">
    <div class="row">
      <div class="col">
        <div class="h2">{{ n.name }}</div>
        <div class="muted">{{ n.base_url }}</div>
      </div>
      <div class="col right">
        <a class="btn-secondary" href="/nodes/{{ n.id }}">打开</a>
      </div>
    </div>
    <div class="meta" data-node-id="{{ n.id }}">
      <span class="pill" id="node-{{ n.id }}-state">检测中...</span>
    </div>
  </div>
  {% else %}
  <div class="card">
    <div class="h2">暂无已接入节点</div>
    <p class="muted">请先在目标机器安装 Realm Agent，再回到此处完成接入。</p>
  </div>
  {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
async function pingNode(id){
  try{
    const res = await fetch(`/api/nodes/${id}/ping`);
    const data = await res.json();
    const el = document.getElementById(`node-${id}-state`);
    if(data.ok){
      const latency = (data.latency_ms != null) ? `在线 · ${data.latency_ms} ms` : '在线';
      el.textContent = latency;
      el.className = 'pill ok';
    }else{
      el.textContent = '离线';
      el.className = 'pill bad';
    }
  }catch(e){
    const el = document.getElementById(`node-${id}-state`);
    el.textContent = '离线';
    el.className = 'pill bad';
  }
}

for(const el of document.querySelectorAll('[data-node-id]')){
  const id = el.getAttribute('data-node-id');
  pingNode(id);
}
</script>
{% endblock %}
