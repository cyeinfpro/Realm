{% extends "base.html" %}
{% block content %}
<div id="toast" class="toast" style="display:none;"></div>

<div class="page-head">
  <div class="page-title">
    <h1 class="h1">控制台</h1>
    <div class="meta">
      <span class="meta-item">集中管理节点接入、转发规则与 WSS 配置，状态实时同步。</span>
    </div>
  </div>
  <div class="right">
    <details class="menu">
      <summary class="btn sm secondary" aria-label="备份与恢复">备份与恢复 ▾</summary>
      <div class="menu-pop">
        <a class="menu-item" href="/api/backup/full">全量备份</a>
        <button class="menu-item" type="button" onclick="openRestoreFullModal()">全量恢复</button>
      </div>
    </details>
    <button class="btn sm secondary" type="button" onclick="openAgentUpdateModal()">一键更新 Agent</button>
    <button class="btn sm" type="button" onclick="openAddNodeModal()">接入节点</button>
  </div>
</div>

{% set total_count = nodes|length %}
{% set online_count = nodes|selectattr('online')|list|length %}
{% set offline_count = total_count - online_count %}
<div class="dashboard-toolbar" id="dashboardToolbar">
  <div class="dash-filters" role="tablist" aria-label="节点筛选">
    <button class="chip" type="button" data-filter="all" aria-selected="true">全部 <strong>{{ total_count }}</strong></button>
    <button class="chip" type="button" data-filter="online">在线 <strong>{{ online_count }}</strong></button>
    <button class="chip" type="button" data-filter="offline">离线 <strong>{{ offline_count }}</strong></button>
  </div>

  <div class="dash-search" role="search">
    <span class="dash-search-ico" aria-hidden="true">⌕</span>
    <input id="dashboardSearch" class="dash-search-input" placeholder="搜索节点 / IP" autocomplete="off" />
    <button id="dashboardSearchClear" class="dash-search-clear" type="button" title="清空">×</button>
  </div>
</div>

<div class="grid node-grid" id="dashboardGrid">
  {% for g in (dashboard_groups or []) %}
    <div class="dash-group-head" data-group="{{ g.name or '默认分组' }}"{% if loop.first %} style="margin-top:0;"{% endif %}>
      <div class="dash-group-left">
        <div class="dash-group-name" role="button" tabindex="0" data-group-name="{{ g.name or '默认分组' }}" data-group-order="{{ g.sort_order }}" title="点击设置分组排序 · 当前：{{ g.sort_order }}">{{ g.name or '默认分组' }}</div>
        <div class="dash-group-line" aria-hidden="true"></div>
      </div>
      <div class="dash-group-right">
        <div class="dash-group-count muted sm">在线 <strong>{{ g.online }}</strong>/<strong>{{ g.total }}</strong></div>
        <button class="btn icon xs ghost dash-group-toggle" type="button" data-group-toggle="{{ g.name or '默认分组' }}" title="折叠/展开">▾</button>
      </div>
    </div>

    {% for n in (g.nodes or []) %}
    <div class="card node-tile node-card" data-node-id="{{ n.id }}" data-online="{{ '1' if n.online else '0' }}">
      <div class="node-top">
        <div class="node-left" style="min-width:0;">
          <div class="node-name" title="{{ n.name or ("节点-" ~ n.id) }}">{{ n.name or ("节点-" ~ n.id) }}</div>
          <div class="node-host mono" title="{{ n.display_ip or "-" }}">{{ n.display_ip or "-" }}</div>
        </div>

        <div class="node-right">
          <div class="node-state {{ 'online' if n.online else 'offline' }}" title="{{ '在线' if n.online else '离线' }}">
            <span class="node-dot {{ 'online' if n.online else 'offline' }}"></span>
            <span>{{ '在线' if n.online else '离线' }}</span>
          </div>
          <a class="btn icon xs ghost" href="/nodes/{{ n.id }}?edit=1" title="编辑">✎</a>
          <a class="btn icon xs secondary" href="/nodes/{{ n.id }}" title="进入">↗</a>
        </div>
      </div>

      <div class="node-meta" title="{{ n.last_seen_at or '-' }}{% if n.agent_version %} · {{ n.agent_version }}{% endif %}">
        <div class="node-meta-item">在线 <span class="mono" data-sys="uptime">—</span></div>
        <div class="node-meta-sep" aria-hidden="true">·</div>
        <div class="node-meta-item">心跳 <span class="mono" data-last-seen="{{ n.last_seen_at or '' }}">{{ n.last_seen_at or "-" }}</span></div>
      </div>

      <div class="node-metrics">
        <div class="metric" title="累计流量">
          <span class="k">流量</span>
          <span class="v mono" data-sys="traffic">—</span>
        </div>
        <div class="metric" title="当前速率">
          <span class="k">速率</span>
          <span class="v mono" data-sys="rate">—</span>
        </div>
      </div>

      <div class="node-bars">
        <div class="mbar">
          <div class="head"><span>CPU</span><span class="mono" data-sys="cpuPct">—</span></div>
          <div class="mini-progress"><div class="mini-fill" data-sys-bar="cpu"></div></div>
        </div>
        <div class="mbar">
          <div class="head"><span>内存</span><span class="mono" data-sys="memText">—</span></div>
          <div class="mini-progress"><div class="mini-fill" data-sys-bar="mem"></div></div>
        </div>
        <div class="mbar">
          <div class="head"><span>磁盘</span><span class="mono" data-sys="diskText">—</span></div>
          <div class="mini-progress"><div class="mini-fill" data-sys-bar="disk"></div></div>
        </div>
      </div>

      <div class="muted sm" data-sys="hint" style="margin-top:8px;display:none;">系统信息暂无数据（等待 Agent 上报）</div>
    </div>
    {% endfor %}
  {% else %}
  <div class="card" style="grid-column:1/-1;">
    <div class="card-title">暂无节点</div>
    <div class="card-sub">请先在目标机安装 Agent，再回到此处接入。</div>
  </div>
  {% endfor %}
</div>

<!-- Add Node Modal -->
<div id="addNodeModal" class="modal" style="display:none;">
  <div class="modal-inner" style="max-width:560px;">
    <div class="row" style="align-items:center;">
      <div class="col"><div class="h2">接入节点</div></div>
      <div class="col right"><button class="btn xs ghost" type="button" onclick="closeAddNodeModal()">关闭</button></div>
    </div>

    <div class="form" style="margin-top:10px;">
      <div class="row" style="gap:12px;">
        <div class="col">
          <label class="label">节点名称（可选）</label>
          <input class="input" id="addNodeName" placeholder="例如：香港-01 / US-Edge">
        </div>
        <div class="col" style="max-width:180px;">
          <label class="label">协议</label>
          <select class="select" id="addNodeScheme">
            <option value="http">http</option>
            <option value="https">https</option>
          </select>
        </div>
      </div>

      <label class="label">分组名称</label>
      <input class="input" id="addNodeGroup" placeholder="例如：香港 / 美国 / 客户A" value="默认分组">
      <div class="help">仅用于面板分类；不影响规则与转发。</div>

      <label class="label">IP/域名</label>
      <input class="input" id="addNodeIp" placeholder="例如：1.2.3.4 或 node.example.com">

      <div class="row" style="gap:12px;align-items:center;margin-top:6px;">
        <div class="col">
          <label class="help"><input type="checkbox" id="addNodeVerifyTls" style="transform:translateY(1px);"> 验证 TLS 证书（https 才需要）</label>
        </div>
        <div class="col">
          <label class="help"><input type="checkbox" id="addNodeIsPrivate" style="transform:translateY(1px);"> 内网机器（用于内网穿透出口）</label>
        </div>
      </div>

      <div id="addNodeError" class="muted" style="margin-top:8px;color:#ffb3b3;"></div>

      <div class="row" style="gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn xs ghost" type="button" onclick="closeAddNodeModal()">取消</button>
        <button class="btn xs" id="addNodeSubmit" type="button" onclick="createNodeFromModal()">创建并进入</button>
      </div>
    </div>
  </div>
</div>

<!-- Agent Update Modal -->
<div id="agentUpdateModal" class="modal" style="display:none;">
  <div class="modal-inner modal-pro au-modal">
    <div class="modal-head">
      <div class="title-wrap">
        <div class="h2">一键更新 Agent</div>
        <div class="muted sm">批量下发到全部节点 · 支持离线补更 · 进度实时可视</div>
      </div>
      <button class="btn xs ghost" type="button" onclick="closeAgentUpdateModal()">关闭</button>
    </div>

    <div class="modal-body au-body">

      <div class="card au-hero compact">
        <div class="au-hero-grid">
          <div class="au-hero-left">
            <div class="au-target">
              <div class="muted sm">目标版本</div>
              <div class="au-ver mono" id="agentUpdateTarget">—</div>
            </div>
            <div class="au-summary muted sm" id="agentUpdateSummary">—</div>
          </div>

          <div class="au-hero-right">
            <button class="btn sm" id="agentUpdateStartBtn" type="button" onclick="startAgentUpdateAll()">开始更新</button>
            <div class="au-batch muted sm mono" id="agentUpdateId"></div>
          </div>
        </div>

        <div class="au-progress" aria-label="更新进度">
          <div class="au-progress-fill" id="agentUpdateBar" style="width:0%"></div>
        </div>
        <div class="au-segbar" id="agentUpdateSegBar" aria-hidden="true"></div>

        <div class="au-meta au-meta2">
          <div class="au-stats" id="agentUpdatePills"></div>
          <div class="au-search">
            <input class="input au-search-input" id="agentUpdateSearch" placeholder="搜索节点 / 分组 / 备注…" />
          </div>
        </div>
      </div>

      <div class="card au-list-card compact">
        <div class="au-grid-head" aria-hidden="true">
          <div>节点</div>
          <div class="au-col-r">状态</div>
          <div class="au-col-r">版本</div>
          <div class="au-col-r">心跳 / 备注</div>
        </div>
        <div class="au-list" id="agentUpdateList"></div>
      </div>
    </div>
  </div>
</div>



<!-- Restore Full Modal -->
<div id="restoreFullModal" class="modal" style="display:none;">
  <div class="modal-inner" style="max-width:560px;">
    <div class="row" style="align-items:center;">
      <div class="col"><div class="h2">全量恢复（节点 + 规则）</div></div>
      <div class="col right"><button class="btn xs ghost" type="button" onclick="closeRestoreFullModal()">关闭</button></div>
    </div>

    <p class="muted" style="margin-top:8px;">
      上传 <span class="mono">realm-backup-*.zip</span>（全量备份包）。系统将自动：
      <span class="mono">1)</span> 恢复节点列表；<span class="mono">2)</span> 按节点批量恢复 <span class="mono">rules/</span> 目录下的规则文件。
      若节点暂时离线，将先写入面板期望配置，待 Agent 上报后自动生效。
    </p>

    <div class="form" style="margin-top:10px;">
      <label class="label">选择全量备份包（zip）</label>
      <input class="input" type="file" id="restoreFullFile" accept=".zip,application/zip">
      <div id="restoreFullError" class="muted" style="margin-top:8px;color:#ffb3b3;white-space:pre-wrap;"></div>
      <div class="row" style="gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn xs ghost" type="button" onclick="closeRestoreFullModal()">取消</button>
        <button class="btn xs" id="restoreFullSubmit" type="button" onclick="restoreFullNow()">开始恢复</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="/static/app.js?v=44.0"></script>
{% endblock %}
