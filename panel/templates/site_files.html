{% extends "base.html" %}
{% block content %}
<div class="page-head">
  <div class="page-title">
    <h1 class="h1">文件管理 · {{ site.name }}</h1>
    <div class="meta">
      <span class="meta-item">根目录：<span class="mono" style="overflow-wrap:anywhere;">{{ root }}</span></span>
      <span class="meta-item">当前：<span class="mono" style="overflow-wrap:anywhere;">{{ path or '/' }}</span></span>
    </div>
  </div>
  <div class="right">
    <a class="btn sm ghost" href="/websites/{{ site.id }}">返回站点</a>
  </div>
</div>

{% include "site_nav.html" %}

{% if error %}
  <div class="flash" style="background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.4);">
    {{ error }}
  </div>
{% endif %}

<div class="card fm-card" style="margin-top:12px;">
  <div class="fm-pathbar">
    <div class="fm-crumbs">
      <button class="btn xs ghost" type="button" id="fmUpBtn">上一级</button>
      <div class="file-path fm-crumb-trail">
        {% for name, p in breadcrumbs %}
          <a href="/websites/{{ site.id }}/files?path={{ p }}">{{ name }}</a>
          {% if not loop.last %}<span class="sep">/</span>{% endif %}
        {% endfor %}
      </div>
    </div>
    <div class="fm-path-actions">
      <button class="btn xs ghost" type="button" id="fmRefreshBtn">刷新</button>
    </div>
  </div>

  <div class="fm-toolbar">
    <div class="fm-actions">
      <button class="btn xs" type="button" id="fmPickFiles">上传文件</button>
      <button class="btn xs ghost" type="button" id="fmPickFolder">上传文件夹</button>
      <div class="fm-divider"></div>
      <form method="post" action="/websites/{{ site.id }}/files/mkdir" class="fm-mkdir">
        <input type="hidden" name="path" value="{{ path }}">
        <input class="input sm" name="name" placeholder="新建目录">
        <button class="btn xs ghost" type="submit">创建</button>
      </form>
    </div>
    <div class="fm-tools">
      <div class="fm-search">
        <input class="input sm" id="fmSearch" placeholder="搜索文件/目录">
        <button class="btn xs ghost" type="button" id="fmSearchClear">清空</button>
      </div>
    </div>
  </div>

  <div class="help" style="margin-top:6px;">
    支持选择文件夹批量上传（含子目录）；单文件上限 {{ upload_max_h }}（分片 + 断点续传）。如文件夹上传失败，可尝试弹窗内“兼容上传”或先压缩再上传。
  </div>

  <div class="fm-subbar">
    <div class="muted sm" id="fmStats"></div>
    <div class="muted sm" id="fmSelectInfo"></div>
  </div>

  <div id="uploadPanel" style="margin-top:10px;display:none;">
    <div class="progress"><div class="progress-fill" id="uploadProgressFill"></div></div>
    <div class="muted sm" id="uploadStatus" style="margin-top:6px;"></div>
    <button class="btn xs ghost" type="button" id="uploadRetry" style="margin-top:8px;display:none;">重试上传</button>
  </div>

  <div class="table-wrap fm-table-wrap" style="margin-top:12px;">
    <table class="table no-sticky fm-table">
      <thead>
        <tr>
          <th class="fm-sel">
            <input type="checkbox" id="fmSelectAll" class="fm-check">
          </th>
          <th>名称</th>
          <th>大小</th>
          <th>修改时间</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        {% set ext = "" %}
        {% if (not it.is_dir) and ("." in it.name) %}
          {% set ext = it.name.rsplit(".", 1)[-1] | lower %}
        {% endif %}
        <tr class="fm-row" data-name="{{ it.name|lower }}" data-type="{{ 'dir' if it.is_dir else 'file' }}" data-size="{{ it.size or 0 }}">
          <td class="fm-sel">
            <input type="checkbox" class="fm-check fm-item-check">
          </td>
          <td>
            <div class="fm-name-wrap">
              <span class="fm-badge {{ 'dir' if it.is_dir else 'file' }}">{{ '目录' if it.is_dir else (ext or '文件') }}</span>
              {% if it.is_dir %}
                <a href="/websites/{{ site.id }}/files?path={{ it.path }}" class="fm-link">{{ it.name }}</a>
              {% else %}
                <span>{{ it.name }}</span>
              {% endif %}
            </div>
          </td>
          <td class="mono">{{ it.size_h }}</td>
          <td class="mono">{{ it.mtime or "-" }}</td>
          <td class="fm-actions-cell">
            {% if not it.is_dir %}
              <a class="btn xs ghost" href="/websites/{{ site.id }}/files/edit?path={{ it.path }}">编辑</a>
              <a class="btn xs ghost" href="/websites/{{ site.id }}/files/download?path={{ it.path }}">下载</a>
              {% if it.name.endswith('.zip') %}
                <form method="post" action="/websites/{{ site.id }}/files/unzip" style="display:inline;">
                  <input type="hidden" name="path" value="{{ it.path }}">
                  <input type="hidden" name="dest" value="{{ path }}">
                  <button class="btn xs ghost" type="submit">解压</button>
                </form>
              {% endif %}
            {% endif %}
            <form method="post" action="/websites/{{ site.id }}/files/delete" style="display:inline;">
              <input type="hidden" name="path" value="{{ it.path }}">
              <button class="btn xs ghost" type="submit">删除</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr id="fmEmptyRow">
          <td colspan="5" class="muted">当前目录为空</td>
        </tr>
        {% endfor %}
        {% if items %}
        <tr id="fmSearchEmptyRow" style="display:none;">
          <td colspan="5" class="muted">没有匹配的文件或目录</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div id="fmUploadModal" class="modal" style="display:none;">
  <div class="modal-inner modal-pro fm-upload-modal">
    <div class="modal-head">
      <div class="title-wrap">
        <div class="h2">上传</div>
        <div class="muted sm" id="fmModalSub">选择文件或文件夹后确认上传</div>
      </div>
      <button class="btn xs ghost" type="button" id="fmModalCloseTop">关闭</button>
    </div>
    <div class="modal-body fm-upload-body">
      <div class="fm-upload-mode">
        <button class="btn xs ghost fm-mode-btn" type="button" id="fmModeFiles">文件</button>
        <button class="btn xs ghost fm-mode-btn" type="button" id="fmModeFolder">文件夹</button>
      </div>
      <div class="fm-upload-row">
        <button class="btn xs" type="button" id="fmModalPick">选择文件</button>
        <input type="file" id="fmModalFilesInput" class="fm-file-input" multiple>
        <input type="file" id="fmModalFolderInput" class="fm-file-input" webkitdirectory directory mozdirectory multiple>
        <div class="muted sm" id="fmModalHint">未选择</div>
      </div>
      <div class="fm-upload-list" id="fmModalFileList">未选择</div>
      <div class="fm-upload-stats muted sm" id="fmModalStats"></div>
      <div id="fmModalProgress" style="margin-top:10px;display:none;">
        <div class="progress"><div class="progress-fill" id="fmModalProgressFill"></div></div>
        <div class="muted sm" id="fmModalStatus" style="margin-top:6px;"></div>
        <button class="btn xs ghost" type="button" id="fmModalRetry" style="margin-top:8px;display:none;">重试上传</button>
      </div>
      <div class="row" style="justify-content:flex-end;gap:10px;margin-top:14px;">
        <button class="btn xs ghost" type="button" id="fmModalClose">取消</button>
        <button class="btn xs ghost" type="button" id="fmModalCompat" disabled>兼容上传</button>
        <button class="btn xs" type="button" id="fmModalStart" disabled>开始上传</button>
      </div>
    </div>
  </div>
</div>

<script>
const pickFilesBtn = document.getElementById('fmPickFiles');
const pickFolderBtn = document.getElementById('fmPickFolder');
const fmSearch = document.getElementById('fmSearch');
const fmSearchClear = document.getElementById('fmSearchClear');
const fmRefreshBtn = document.getElementById('fmRefreshBtn');
const fmUpBtn = document.getElementById('fmUpBtn');
const fmStats = document.getElementById('fmStats');
const fmSelectInfo = document.getElementById('fmSelectInfo');
const fmSelectAll = document.getElementById('fmSelectAll');
const fmUploadModal = document.getElementById('fmUploadModal');
const fmModeFiles = document.getElementById('fmModeFiles');
const fmModeFolder = document.getElementById('fmModeFolder');
const fmModalSub = document.getElementById('fmModalSub');
const fmModalPick = document.getElementById('fmModalPick');
const fmModalFilesInput = document.getElementById('fmModalFilesInput');
const fmModalFolderInput = document.getElementById('fmModalFolderInput');
const fmModalHint = document.getElementById('fmModalHint');
const fmModalFileList = document.getElementById('fmModalFileList');
const fmModalStats = document.getElementById('fmModalStats');
const fmModalStart = document.getElementById('fmModalStart');
const fmModalCompat = document.getElementById('fmModalCompat');
const fmModalClose = document.getElementById('fmModalClose');
const fmModalCloseTop = document.getElementById('fmModalCloseTop');
const fmModalProgress = document.getElementById('fmModalProgress');
const fmModalProgressFill = document.getElementById('fmModalProgressFill');
const fmModalStatus = document.getElementById('fmModalStatus');
const fmModalRetry = document.getElementById('fmModalRetry');

const CHUNK_SIZE = 1024 * 512;
const UPLOAD_MAX_BYTES = {{ upload_max_bytes }};
const SITE_ID = {{ site.id }};
const CUR_PATH = {{ path|tojson }};
const folderPickerEl = fmModalFolderInput;
const SUPPORTS_FOLDER_PICK = !!(folderPickerEl && (('webkitdirectory' in folderPickerEl) || ('mozdirectory' in folderPickerEl)));
const modalUI = {
  panel: fmModalProgress,
  progressFill: fmModalProgressFill,
  status: fmModalStatus,
  retry: fmModalRetry,
  button: fmModalStart
};
let modalFiles = [];
let lastUploadMethod = 'chunked';

function bytesToHuman(n){
  if(!n) return '0 B';
  const units = ['B','KB','MB','GB','TB'];
  let i = 0;
  let v = n;
  while(v >= 1024 && i < units.length - 1){
    v /= 1024;
    i++;
  }
  return v.toFixed(1) + ' ' + units[i];
}

function openModal(){
  if(!fmUploadModal) return;
  fmUploadModal.style.display = 'flex';
  document.body.classList.add('modal-open');
}

function closeModal(){
  if(!fmUploadModal) return;
  fmUploadModal.style.display = 'none';
  document.body.classList.remove('modal-open');
}

function renderModalList(files){
  if(!fmModalFileList || !fmModalStats) return;
  fmModalFileList.innerHTML = '';
  if(!files.length){
    fmModalFileList.textContent = '未选择';
    fmModalStats.textContent = '';
    return;
  }
  const limit = 200;
  const totalBytes = files.reduce((s,f)=>s + (f.size || 0), 0) || 0;
  const show = files.slice(0, limit);
  show.forEach((f)=>{
    const row = document.createElement('div');
    row.className = 'fm-upload-item';
    const name = document.createElement('span');
    name.className = 'fm-upload-name';
    name.textContent = f.webkitRelativePath || f.name;
    const size = document.createElement('span');
    size.className = 'fm-upload-size';
    size.textContent = bytesToHuman(f.size || 0);
    row.appendChild(name);
    row.appendChild(size);
    fmModalFileList.appendChild(row);
  });
  if(files.length > limit){
    const more = document.createElement('div');
    more.className = 'muted sm';
    more.textContent = `仅显示前 ${limit} 项，实际 ${files.length} 项`;
    fmModalFileList.appendChild(more);
  }
  fmModalStats.textContent = `共 ${files.length} 个文件 · ${bytesToHuman(totalBytes)}`;
}

let modalMode = 'file';

function setModalMode(mode){
  modalMode = mode === 'folder' ? 'folder' : 'file';
  if(fmModeFiles) fmModeFiles.classList.toggle('active', modalMode === 'file');
  if(fmModeFolder) fmModeFolder.classList.toggle('active', modalMode === 'folder');
  if(fmModalPick) fmModalPick.textContent = modalMode === 'folder' ? '选择文件夹' : '选择文件';
  if(fmModalPick){
    if(modalMode === 'folder' && !SUPPORTS_FOLDER_PICK){
      fmModalPick.title = '当前浏览器不支持文件夹选择';
    }else{
      fmModalPick.title = modalMode === 'folder' ? '选择文件夹' : '选择文件';
    }
  }
  if(fmModalSub){
    fmModalSub.textContent = modalMode === 'folder'
      ? '选择文件夹后确认上传'
      : '选择文件后确认上传';
  }
  modalFiles = [];
  if(fmModalFilesInput) fmModalFilesInput.value = '';
  if(fmModalFolderInput) fmModalFolderInput.value = '';
  if(fmModalHint) fmModalHint.textContent = '未选择';
  renderModalList([]);
  if(fmModalStart) fmModalStart.disabled = true;
  if(fmModalCompat) fmModalCompat.disabled = true;
  if(fmModalProgress) fmModalProgress.style.display = 'none';
  if(fmModalProgressFill) fmModalProgressFill.style.width = '0%';
  if(fmModalStatus) fmModalStatus.textContent = '';
  if(fmModalRetry) fmModalRetry.style.display = 'none';
}

function bufToHex(buffer){
  const bytes = new Uint8Array(buffer);
  const hex = [];
  for(const b of bytes){
    hex.push(b.toString(16).padStart(2, '0'));
  }
  return hex.join('');
}

const HAS_SUBTLE = !!(window.crypto && window.crypto.subtle);

async function sha256Hex(arrayBuffer){
  if(!HAS_SUBTLE) return '';
  const hash = await crypto.subtle.digest('SHA-256', arrayBuffer);
  return bufToHex(hash);
}

async function chunkToBase64(arrayBuffer){
  let binary = '';
  const bytes = new Uint8Array(arrayBuffer);
  const len = bytes.byteLength;
  for(let i=0;i<len;i++){
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}

function uploadKey(file, path, filename){
  const p = path || CUR_PATH || '';
  const f = filename || file.name || '';
  return `nexus_upload_${SITE_ID}_${p}_${f}_${file.size}_${file.lastModified}`;
}

async function getResumeOffset(file, uploadId, path, filename){
  const resp = await fetch(`/websites/${SITE_ID}/files/upload_status`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ path: path || CUR_PATH, filename: filename || file.name, upload_id: uploadId })
  });
  const data = await resp.json().catch(()=>({ok:false}));
  if(!data.ok) return 0;
  return parseInt(data.offset || 0, 10) || 0;
}

function splitRelPath(rel){
  const clean = String(rel || '').replace(/^[/\\\\]+/, '').replace(/\\\\/g, '/');
  if(!clean) return {dir:'', name:''};
  const parts = clean.split('/').filter(Boolean);
  const name = parts.pop() || '';
  return {dir: parts.join('/'), name};
}

function joinPath(a,b){
  const aa = String(a || '').replace(/[\\\\/]+$/,'');
  const bb = String(b || '').replace(/^[\\\\/]+/, '');
  if(!aa) return bb;
  if(!bb) return aa;
  return aa + '/' + bb;
}

let tableStats = {total:0, files:0, dirs:0, size:0};

function computeTableStats(){
  const rows = Array.from(document.querySelectorAll('.fm-row'));
  let total = 0;
  let files = 0;
  let dirs = 0;
  let size = 0;
  for(const r of rows){
    total += 1;
    const type = r.dataset.type || '';
    if(type === 'dir'){
      dirs += 1;
    }else{
      files += 1;
      size += parseInt(r.dataset.size || '0', 10) || 0;
    }
  }
  tableStats = {total, files, dirs, size};
}

function renderStats(shownCount){
  if(!fmStats) return;
  let text = `共 ${tableStats.total} 项 · 目录 ${tableStats.dirs} · 文件 ${tableStats.files} · 大小 ${bytesToHuman(tableStats.size)}`;
  if(typeof shownCount === 'number' && shownCount !== tableStats.total){
    text += ` · 匹配 ${shownCount} 项`;
  }
  fmStats.textContent = text;
}

function updateSelectionInfo(){
  if(!fmSelectInfo) return;
  const checks = Array.from(document.querySelectorAll('.fm-item-check'));
  const visibleChecks = checks.filter((c)=>{
    const row = c.closest('.fm-row');
    return row && row.style.display !== 'none';
  });
  const selected = visibleChecks.filter((c)=>c.checked);
  if(visibleChecks.length){
    if(fmSelectAll){
      fmSelectAll.checked = selected.length === visibleChecks.length;
      fmSelectAll.indeterminate = selected.length > 0 && selected.length < visibleChecks.length;
    }
  }else if(fmSelectAll){
    fmSelectAll.checked = false;
    fmSelectAll.indeterminate = false;
  }
  fmSelectInfo.textContent = selected.length ? `已选择 ${selected.length} 项` : '';
}

function applySearchFilter(){
  const rows = Array.from(document.querySelectorAll('.fm-row'));
  const q = (fmSearch?.value || '').trim().toLowerCase();
  let shown = 0;
  rows.forEach((r)=>{
    const name = r.dataset.name || '';
    const match = !q || name.includes(q);
    r.style.display = match ? '' : 'none';
    if(match) shown += 1;
  });
  const emptyRow = document.getElementById('fmSearchEmptyRow');
  if(emptyRow){
    emptyRow.style.display = shown ? 'none' : '';
  }
  renderStats(shown);
  updateSelectionInfo();
}

function resolveUploadTarget(file){
  const rel = file.webkitRelativePath || '';
  if(rel){
    const info = splitRelPath(rel);
    return {path: joinPath(CUR_PATH, info.dir), filename: info.name || file.name};
  }
  return {path: CUR_PATH, filename: file.name};
}

async function uploadFile(file, uploadId, startOffset, path, filename, totalBytes, progressCb, ui){
  let offset = startOffset || 0;
  const total = file.size;
  const panel = ui?.panel;
  const progressFill = ui?.progressFill;
  const status = ui?.status;
  const retry = ui?.retry;
  const button = ui?.button;
  if(panel) panel.style.display = 'block';
  if(retry) retry.style.display = 'none';
  if(button) button.disabled = true;
  if(status) status.textContent = `准备上传 ${file.name} (${bytesToHuman(total)})…`;
  if(total === 0){
    const resp = await fetch(`/websites/${SITE_ID}/files/upload_chunk`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        path: path || CUR_PATH,
        filename: filename || file.name,
        upload_id: uploadId,
        offset: 0,
        done: true,
        allow_empty: true
      })
    });
    const data = await resp.json().catch(()=>({ok:false,error:'上传失败'}));
    if(!data.ok){
      throw new Error(data.error || '上传失败');
    }
    if(progressCb) progressCb(0);
    return;
  }
  while(offset < total){
    const chunk = file.slice(offset, offset + CHUNK_SIZE);
    const buf = await chunk.arrayBuffer();
    const chunkSha = await sha256Hex(buf);
    const b64 = await chunkToBase64(buf);
    const done = (offset + chunk.size) >= total;
    const payload = {
      path: path || CUR_PATH,
      filename: filename || file.name,
      upload_id: uploadId,
      offset: offset,
      done: done,
      content_b64: b64
    };
    if(chunkSha){
      payload.chunk_sha256 = chunkSha;
    }
    const resp = await fetch(`/websites/${SITE_ID}/files/upload_chunk`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await resp.json().catch(()=>({ok:false,error:'上传失败'}));
    if(!data.ok){
      if(data.expected_offset !== undefined){
        offset = parseInt(data.expected_offset || 0, 10) || 0;
        continue;
      }
      throw new Error(data.error || '上传失败');
    }
    offset += chunk.size;
    if(progressCb) progressCb(chunk.size);
    localStorage.setItem(uploadKey(file, path, filename), uploadId);
  }
  localStorage.removeItem(uploadKey(file, path, filename));
  if(status) status.textContent = '上传完成';
  if(button) button.disabled = false;
}

async function startChunkedUpload(files, ui, resumeOnly){
  lastUploadMethod = 'chunked';
  if(!files.length){
    alert('请选择文件或文件夹');
    return;
  }
  if(!HAS_SUBTLE && ui?.status){
    ui.status.textContent = '提示：当前环境不支持 SHA256（将跳过校验）。建议使用 HTTPS 或现代浏览器。';
  }
  for(const f of files){
    if(UPLOAD_MAX_BYTES && f.size > UPLOAD_MAX_BYTES){
      alert(`文件过大：${f.name}（${bytesToHuman(f.size)}），超过限制 ${bytesToHuman(UPLOAD_MAX_BYTES)}`);
      return;
    }
  }
  if(ui?.button) ui.button.disabled = true;
  if(fmModalCompat) fmModalCompat.disabled = true;
  const totalBytes = files.reduce((s,f)=>s + (f.size || 0), 0) || 0;
  let uploadedBytes = 0;
  try{
    const tasks = [];
    for(let i=0;i<files.length;i++){
      const file = files[i];
      const target = resolveUploadTarget(file);
      const key = uploadKey(file, target.path, target.filename);
      let uploadId = localStorage.getItem(key) || '';
      if(!uploadId){
        if(resumeOnly){
          throw new Error('找不到可恢复的上传');
        }
        uploadId = Math.random().toString(16).slice(2) + Date.now().toString(16);
      }
      const offset = await getResumeOffset(file, uploadId, target.path, target.filename);
      uploadedBytes += offset;
      tasks.push({file, target, uploadId, offset});
    }
    const total = totalBytes || 0;
    const updateProgress = (delta, name)=>{
      uploadedBytes += delta;
      const pct = total > 0 ? Math.min(100, Math.round((uploadedBytes / total) * 100)) : 100;
      if(ui?.progressFill) ui.progressFill.style.width = pct + '%';
      if(ui?.status){
        ui.status.textContent = `上传中：${name} · ${bytesToHuman(uploadedBytes)} / ${bytesToHuman(total)} (${pct}%)`;
      }
    };
    const concurrency = 3;
    let cursor = 0;
    const worker = async ()=>{
      while(true){
        if(cursor >= tasks.length) return;
        const t = tasks[cursor++];
        await uploadFile(t.file, t.uploadId, t.offset, t.target.path, t.target.filename, total, (d)=>updateProgress(d, t.file.name), ui);
      }
    };
    const workers = [];
    for(let i=0;i<Math.min(concurrency, tasks.length);i++){
      workers.push(worker());
    }
    await Promise.all(workers);
    window.location.reload();
  }catch(err){
    if(ui?.status) ui.status.textContent = String(err);
    if(ui?.retry) ui.retry.style.display = 'inline-block';
    if(ui?.button) ui.button.disabled = false;
    if(fmModalCompat) fmModalCompat.disabled = false;
  }
}

async function startCompatUpload(files, mode, ui){
  lastUploadMethod = 'compat';
  if(!files.length){
    alert('请选择文件或文件夹');
    return;
  }
  for(const f of files){
    if(UPLOAD_MAX_BYTES && f.size > UPLOAD_MAX_BYTES){
      alert(`文件过大：${f.name}（${bytesToHuman(f.size)}），超过限制 ${bytesToHuman(UPLOAD_MAX_BYTES)}`);
      return;
    }
  }
  if(ui?.panel) ui.panel.style.display = 'block';
  if(ui?.retry) ui.retry.style.display = 'none';
  if(ui?.button) ui.button.disabled = true;
  if(fmModalCompat) fmModalCompat.disabled = true;
  if(ui?.status) ui.status.textContent = '兼容上传中…';
  if(ui?.progressFill) ui.progressFill.style.width = '0%';
  const form = new FormData();
  form.append('path', CUR_PATH || '');
  const field = mode === 'folder' ? 'folder' : 'files';
  files.forEach((f)=>{
    const name = f.webkitRelativePath || f.name;
    form.append(field, f, name);
  });
  await new Promise((resolve, reject)=>{
    const xhr = new XMLHttpRequest();
    xhr.open('POST', `/websites/${SITE_ID}/files/upload`);
    xhr.upload.onprogress = (e)=>{
      if(!e.lengthComputable) return;
      const pct = Math.min(100, Math.round((e.loaded / e.total) * 100));
      if(ui?.progressFill) ui.progressFill.style.width = pct + '%';
      if(ui?.status){
        ui.status.textContent = `兼容上传中：${bytesToHuman(e.loaded)} / ${bytesToHuman(e.total)} (${pct}%)`;
      }
    };
    xhr.onload = ()=>{
      if(xhr.status >= 200 && xhr.status < 400){
        resolve();
      }else{
        reject(new Error(`上传失败（${xhr.status}）`));
      }
    };
    xhr.onerror = ()=> reject(new Error('上传失败'));
    xhr.send(form);
  }).then(()=>{
    window.location.reload();
  }).catch((err)=>{
    if(ui?.status) ui.status.textContent = String(err);
    if(ui?.retry) ui.retry.style.display = 'inline-block';
    if(ui?.button) ui.button.disabled = false;
    if(fmModalCompat) fmModalCompat.disabled = false;
  });
}

pickFilesBtn?.addEventListener('click', ()=>{
  setModalMode('file');
  openModal();
});

pickFolderBtn?.addEventListener('click', ()=>{
  if(!SUPPORTS_FOLDER_PICK){
    alert('当前浏览器不支持文件夹选择，请使用 Chrome / Edge 或尝试兼容上传。');
    return;
  }
  setModalMode('folder');
  openModal();
});

fmModeFiles?.addEventListener('click', ()=> setModalMode('file'));
fmModeFolder?.addEventListener('click', ()=>{
  if(!SUPPORTS_FOLDER_PICK){
    alert('当前浏览器不支持文件夹选择，请使用 Chrome / Edge。');
    return;
  }
  setModalMode('folder');
});

fmModalPick?.addEventListener('click', ()=>{
  if(modalMode === 'folder'){
    if(!SUPPORTS_FOLDER_PICK){
      alert('当前浏览器不支持文件夹选择，请使用 Chrome / Edge。');
      return;
    }
    fmModalFolderInput?.click();
  }else{
    fmModalFilesInput?.click();
  }
});

fmModalFilesInput?.addEventListener('change', ()=>{
  modalFiles = fmModalFilesInput?.files ? Array.from(fmModalFilesInput.files) : [];
  if(fmModalHint){
    fmModalHint.textContent = modalFiles.length ? `已选择 ${modalFiles.length} 个文件` : '未选择';
  }
  renderModalList(modalFiles);
  if(fmModalStart) fmModalStart.disabled = !modalFiles.length;
  if(fmModalCompat) fmModalCompat.disabled = !modalFiles.length;
});

fmModalFolderInput?.addEventListener('change', ()=>{
  modalFiles = fmModalFolderInput?.files ? Array.from(fmModalFolderInput.files) : [];
  if(fmModalHint){
    if(modalFiles.length){
      const rel = modalFiles[0].webkitRelativePath || '';
      const folderName = rel ? rel.split('/')[0] : '文件夹';
      fmModalHint.textContent = `已选择：${folderName}`;
    }else{
      fmModalHint.textContent = '未选择';
    }
  }
  renderModalList(modalFiles);
  if(fmModalStart) fmModalStart.disabled = !modalFiles.length;
  if(fmModalCompat) fmModalCompat.disabled = !modalFiles.length;
});

fmModalStart?.addEventListener('click', async ()=>{
  if(!modalFiles.length){
    alert(modalMode === 'folder' ? '请选择文件夹' : '请选择文件');
    return;
  }
  await startChunkedUpload(modalFiles, modalUI, false);
});

fmModalCompat?.addEventListener('click', async ()=>{
  if(!modalFiles.length){
    alert(modalMode === 'folder' ? '请选择文件夹' : '请选择文件');
    return;
  }
  await startCompatUpload(modalFiles, modalMode, modalUI);
});

fmModalRetry?.addEventListener('click', async ()=>{
  if(!modalFiles.length) return;
  if(lastUploadMethod === 'compat'){
    await startCompatUpload(modalFiles, modalMode, modalUI);
  }else{
    await startChunkedUpload(modalFiles, modalUI, true);
  }
});

const modalClose = ()=>{
  closeModal();
};
fmModalClose?.addEventListener('click', modalClose);
fmModalCloseTop?.addEventListener('click', modalClose);
fmUploadModal?.addEventListener('click', (e)=>{
  if(e.target === fmUploadModal) closeModal();
});
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && fmUploadModal && fmUploadModal.style.display !== 'none'){
    closeModal();
  }
});

fmSearch?.addEventListener('input', applySearchFilter);
fmSearchClear?.addEventListener('click', ()=>{
  if(fmSearch) fmSearch.value = '';
  applySearchFilter();
});

fmRefreshBtn?.addEventListener('click', ()=> window.location.reload());
fmUpBtn?.addEventListener('click', ()=>{
  const segs = String(CUR_PATH || '').split('/').filter(Boolean);
  if(!segs.length) return;
  segs.pop();
  const up = segs.join('/');
  window.location.href = `/websites/${SITE_ID}/files?path=${encodeURIComponent(up)}`;
});

fmSelectAll?.addEventListener('change', ()=>{
  const rows = Array.from(document.querySelectorAll('.fm-row'));
  const checked = !!fmSelectAll.checked;
  rows.forEach((r)=>{
    if(r.style.display === 'none') return;
    const box = r.querySelector('.fm-item-check');
    if(box) box.checked = checked;
  });
  updateSelectionInfo();
});

document.querySelectorAll('.fm-item-check').forEach((c)=>{
  c.addEventListener('change', updateSelectionInfo);
});

if(!SUPPORTS_FOLDER_PICK && pickFolderBtn){
  pickFolderBtn.setAttribute('disabled', 'disabled');
  pickFolderBtn.classList.add('disabled');
  pickFolderBtn.title = '当前浏览器不支持文件夹选择';
}
if(!SUPPORTS_FOLDER_PICK && fmModeFolder){
  fmModeFolder.setAttribute('disabled', 'disabled');
  fmModeFolder.classList.add('disabled');
  fmModeFolder.title = '当前浏览器不支持文件夹选择';
}

computeTableStats();
applySearchFilter();
setModalMode('file');
</script>
{% endblock %}
