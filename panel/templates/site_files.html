{% extends "base.html" %}
{% block content %}
<div class="page-head">
  <div class="page-title">
    <h1 class="h1">文件管理 · {{ site.name }}</h1>
    <div class="meta">
      <span class="meta-item">根目录：<span class="mono" style="overflow-wrap:anywhere;">{{ root }}</span></span>
      <span class="meta-item">当前：<span class="mono" style="overflow-wrap:anywhere;">{{ path or '/' }}</span></span>
    </div>
  </div>
  <div class="right">
    <a class="btn sm ghost" href="/websites/{{ site.id }}">返回站点</a>
  </div>
</div>

{% include "site_nav.html" %}

{% if error %}
  <div class="flash" style="background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.4);">
    {{ error }}
  </div>
{% endif %}

<div class="card fm-card compact" style="margin-top:12px;">
  <div class="fm-pathbar">
    <div class="fm-crumbs">
      <button class="btn xs ghost" type="button" id="fmUpBtn">上一级</button>
      <div class="file-path fm-crumb-trail">
        {% for name, p in breadcrumbs %}
          <a href="/websites/{{ site.id }}/files?path={{ p }}">{{ name }}</a>
          {% if not loop.last %}<span class="sep">/</span>{% endif %}
        {% endfor %}
      </div>
    </div>
    <div class="fm-path-actions">
      <button class="btn xs ghost" type="button" id="fmRefreshBtn">刷新</button>
    </div>
  </div>

  <div class="fm-toolbar">
    <div class="fm-actions">
      <button class="btn xs" type="button" id="fmPickFiles">上传文件</button>
      <button class="btn xs ghost" type="button" id="fmShareBtn">分享选中</button>
      <div class="fm-divider"></div>
      <form method="post" action="/websites/{{ site.id }}/files/mkdir" class="fm-mkdir">
        <input type="hidden" name="path" value="{{ path }}">
        <input class="input sm" name="name" placeholder="新建目录">
        <button class="btn xs ghost" type="submit">创建</button>
      </form>
    </div>
    <div class="fm-tools">
      <div class="fm-search">
        <input class="input sm" id="fmSearch" placeholder="搜索文件/目录">
        <button class="btn xs ghost" type="button" id="fmSearchClear">清空</button>
      </div>
    </div>
  </div>

  <div class="fm-subbar">
    <div class="muted sm" id="fmStats"></div>
    <div class="muted sm" id="fmSelectInfo"></div>
  </div>

  <div id="uploadPanel" style="margin-top:10px;display:none;">
    <div class="progress"><div class="progress-fill" id="uploadProgressFill"></div></div>
    <div class="muted sm" id="uploadStatus" style="margin-top:6px;"></div>
    <button class="btn xs ghost" type="button" id="uploadRetry" style="margin-top:8px;display:none;">重试上传</button>
  </div>

  <div class="table-wrap fm-table-wrap" style="margin-top:12px;">
    <table class="table no-sticky fm-table dense">
      <thead>
        <tr>
          <th class="fm-sel">
            <input type="checkbox" id="fmSelectAll" class="fm-check">
          </th>
          <th>名称</th>
          <th>大小</th>
          <th>修改时间</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        {% set ext = "" %}
        {% if (not it.is_dir) and ("." in it.name) %}
          {% set ext = it.name.rsplit(".", 1)[-1] | lower %}
        {% endif %}
        <tr
          class="fm-row"
          data-name="{{ it.name|lower }}"
          data-display-name="{{ it.name }}"
          data-path="{{ it.path }}"
          data-type="{{ 'dir' if it.is_dir else 'file' }}"
          data-size="{{ it.size or 0 }}"
        >
          <td class="fm-sel">
            <input type="checkbox" class="fm-check fm-item-check">
          </td>
          <td>
            <div class="fm-name-wrap">
              <span class="fm-badge {{ 'dir' if it.is_dir else 'file' }}">{{ '目录' if it.is_dir else (ext or '文件') }}</span>
              {% if it.is_dir %}
                <a href="/websites/{{ site.id }}/files?path={{ it.path }}" class="fm-link">{{ it.name }}</a>
              {% else %}
                <span>{{ it.name }}</span>
              {% endif %}
            </div>
          </td>
          <td class="mono">{{ it.size_h }}</td>
          <td class="mono">{{ it.mtime or "-" }}</td>
          <td class="fm-actions-cell">
            <div class="fm-inline-actions">
              {% if not it.is_dir %}
                <a class="btn xs ghost fm-act-btn" href="/websites/{{ site.id }}/files/edit?path={{ it.path }}">编辑</a>
                <a class="btn xs ghost fm-act-btn" href="/websites/{{ site.id }}/files/download?path={{ it.path }}">下载</a>
                {% if it.name.endswith('.zip') %}
                  <form method="post" action="/websites/{{ site.id }}/files/unzip" class="fm-inline-form">
                    <input type="hidden" name="path" value="{{ it.path }}">
                    <input type="hidden" name="dest" value="{{ path }}">
                    <button class="btn xs ghost fm-act-btn" type="submit">解压</button>
                  </form>
                {% endif %}
              {% endif %}
              <button
                class="btn xs ghost fm-act-btn fm-share-one"
                type="button"
                data-path="{{ it.path }}"
                data-name="{{ it.name }}"
                data-type="{{ 'dir' if it.is_dir else 'file' }}"
              >分享</button>
              <form method="post" action="/websites/{{ site.id }}/files/delete" class="fm-inline-form" onsubmit="return confirm('确定删除吗？');">
                <input type="hidden" name="path" value="{{ it.path }}">
                <button class="btn xs ghost fm-act-btn fm-act-danger" type="submit">删除</button>
              </form>
            </div>
            <div class="fm-row-share-links" data-path="{{ it.path }}"></div>
          </td>
        </tr>
        {% else %}
        <tr id="fmEmptyRow">
          <td colspan="5" class="muted">当前目录为空</td>
        </tr>
        {% endfor %}
        {% if items %}
        <tr id="fmSearchEmptyRow" style="display:none;">
          <td colspan="5" class="muted">没有匹配的文件或目录</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div id="fmUploadModal" class="modal" style="display:none;">
  <div class="modal-inner modal-pro fm-upload-modal">
    <div class="modal-head">
      <div class="title-wrap">
        <div class="h2">上传</div>
        <div class="muted sm" id="fmModalSub">选择文件或文件夹后确认上传</div>
      </div>
      <button class="btn xs ghost" type="button" id="fmModalCloseTop">关闭</button>
    </div>
    <div class="modal-body fm-upload-body">
      <div class="fm-upload-mode">
        <button class="btn xs ghost fm-mode-btn" type="button" id="fmModeFiles">文件</button>
        <button class="btn xs ghost fm-mode-btn" type="button" id="fmModeFolder">文件夹</button>
      </div>
      <div class="fm-upload-row">
        <button class="btn xs" type="button" id="fmModalPick">选择文件</button>
        <input type="file" id="fmModalFilesInput" class="fm-file-input" multiple>
        <input type="file" id="fmModalFolderInput" class="fm-file-input" webkitdirectory directory mozdirectory multiple>
        <div class="muted sm" id="fmModalHint">未选择</div>
      </div>
      <div class="fm-upload-row">
        <span class="muted sm">并发上传</span>
        <select class="select sm" id="fmModalConcurrency"></select>
        <span class="muted sm">建议 2-6，文件越多可适当调高</span>
      </div>
      <div class="fm-upload-list" id="fmModalFileList">未选择</div>
      <div class="fm-upload-stats muted sm" id="fmModalStats"></div>
      <div id="fmModalProgress" style="margin-top:10px;display:none;">
        <div class="progress"><div class="progress-fill" id="fmModalProgressFill"></div></div>
        <div class="muted sm" id="fmModalStatus" style="margin-top:6px;"></div>
        <button class="btn xs ghost" type="button" id="fmModalRetry" style="margin-top:8px;display:none;">重试上传</button>
      </div>
      <div class="row" style="justify-content:flex-end;gap:10px;margin-top:14px;">
        <button class="btn xs ghost" type="button" id="fmModalClose">取消</button>
        <button class="btn xs ghost" type="button" id="fmModalCompat" disabled>兼容上传</button>
        <button class="btn xs" type="button" id="fmModalStart" disabled>开始上传</button>
      </div>
    </div>
  </div>
</div>

<div id="fmShareModal" class="modal" style="display:none;">
  <div class="modal-inner modal-pro fm-share-modal">
    <div class="modal-head">
      <div class="title-wrap">
        <div class="h2">文件分享</div>
        <div class="muted sm" id="fmShareSub">生成可访问的分享链接</div>
      </div>
      <button class="btn xs ghost" type="button" id="fmShareCloseTop">关闭</button>
    </div>
    <div class="modal-body">
      <div class="fm-share-picks" id="fmShareItems">未选择</div>
      <div class="fm-share-ttl">
        <span class="muted sm">有效期</span>
        <input class="input sm" id="fmShareTtlValue" type="number" min="1" step="1" value="24">
        <select class="select" id="fmShareTtlUnit">
          <option value="hour">小时</option>
          <option value="minute">分钟</option>
          <option value="day">天</option>
        </select>
        <span class="muted sm" id="fmShareTtlHint"></span>
      </div>
      <div class="fm-share-link-row">
        <input class="input sm mono" id="fmShareLink" placeholder="点击“生成链接”后显示" readonly>
        <button class="btn xs ghost" type="button" id="fmShareCopy" disabled>复制</button>
        <a class="btn xs ghost" id="fmShareOpen" href="#" target="_blank" rel="noopener" style="display:none;">打开</a>
      </div>
      <div class="muted sm" id="fmShareStatus"></div>
      <div class="fm-share-history-wrap">
        <div class="muted sm">历史链接</div>
        <div class="fm-share-history" id="fmShareHistory">加载中…</div>
      </div>
      <div class="row" style="justify-content:flex-end;gap:10px;margin-top:6px;">
        <button class="btn xs ghost fm-act-danger" type="button" id="fmShareRevoke" disabled>取消分享</button>
        <button class="btn xs ghost" type="button" id="fmShareClose">取消</button>
        <button class="btn xs" type="button" id="fmShareGen">生成链接</button>
      </div>
    </div>
  </div>
</div>

<script>
const pickFilesBtn = document.getElementById('fmPickFiles');
const pickFolderBtn = document.getElementById('fmPickFolder');
const fmSearch = document.getElementById('fmSearch');
const fmSearchClear = document.getElementById('fmSearchClear');
const fmRefreshBtn = document.getElementById('fmRefreshBtn');
const fmUpBtn = document.getElementById('fmUpBtn');
const fmStats = document.getElementById('fmStats');
const fmSelectInfo = document.getElementById('fmSelectInfo');
const fmSelectAll = document.getElementById('fmSelectAll');
const fmShareBtn = document.getElementById('fmShareBtn');
const fmUploadModal = document.getElementById('fmUploadModal');
const fmModeFiles = document.getElementById('fmModeFiles');
const fmModeFolder = document.getElementById('fmModeFolder');
const fmModalSub = document.getElementById('fmModalSub');
const fmModalPick = document.getElementById('fmModalPick');
const fmModalFilesInput = document.getElementById('fmModalFilesInput');
const fmModalFolderInput = document.getElementById('fmModalFolderInput');
const fmModalHint = document.getElementById('fmModalHint');
const fmModalConcurrency = document.getElementById('fmModalConcurrency');
const fmModalFileList = document.getElementById('fmModalFileList');
const fmModalStats = document.getElementById('fmModalStats');
const fmModalStart = document.getElementById('fmModalStart');
const fmModalCompat = document.getElementById('fmModalCompat');
const fmModalClose = document.getElementById('fmModalClose');
const fmModalCloseTop = document.getElementById('fmModalCloseTop');
const fmModalProgress = document.getElementById('fmModalProgress');
const fmModalProgressFill = document.getElementById('fmModalProgressFill');
const fmModalStatus = document.getElementById('fmModalStatus');
const fmModalRetry = document.getElementById('fmModalRetry');
const fmShareModal = document.getElementById('fmShareModal');
const fmShareItems = document.getElementById('fmShareItems');
const fmShareTtlValue = document.getElementById('fmShareTtlValue');
const fmShareTtlUnit = document.getElementById('fmShareTtlUnit');
const fmShareTtlHint = document.getElementById('fmShareTtlHint');
const fmShareLink = document.getElementById('fmShareLink');
const fmShareCopy = document.getElementById('fmShareCopy');
const fmShareOpen = document.getElementById('fmShareOpen');
const fmShareStatus = document.getElementById('fmShareStatus');
const fmShareHistory = document.getElementById('fmShareHistory');
const fmShareClose = document.getElementById('fmShareClose');
const fmShareCloseTop = document.getElementById('fmShareCloseTop');
const fmShareGen = document.getElementById('fmShareGen');
const fmShareRevoke = document.getElementById('fmShareRevoke');

const CHUNK_SIZE = 1024 * 512;
const UPLOAD_MAX_BYTES = {{ upload_max_bytes }};
const SITE_ID = {{ site.id }};
const CUR_PATH = {{ path|tojson }};
const FILE_SHARE_DEFAULT_TTL_SEC = {{ file_share_default_ttl_sec }};
const FILE_SHARE_MIN_TTL_SEC = {{ file_share_min_ttl_sec }};
const FILE_SHARE_MAX_TTL_SEC = {{ file_share_max_ttl_sec }};
const FILE_SHARE_MAX_ITEMS = {{ file_share_max_items }};
const folderPickerEl = fmModalFolderInput;
const SUPPORTS_FOLDER_PICK = !!(folderPickerEl && (('webkitdirectory' in folderPickerEl) || ('mozdirectory' in folderPickerEl)));
const modalUI = {
  panel: fmModalProgress,
  progressFill: fmModalProgressFill,
  status: fmModalStatus,
  retry: fmModalRetry,
  button: fmModalStart
};
const MAX_UPLOAD_CONCURRENCY = 8;
const MIN_UPLOAD_CONCURRENCY = 1;
const PROGRESS_UPDATE_INTERVAL_MS = 100;
const UPLOAD_REQUEST_TIMEOUT_MS = 120000;
const UPLOAD_REQUEST_MAX_RETRIES = 4;
const UPLOAD_RETRY_BASE_DELAY_MS = 400;
const UPLOAD_RETRY_MAX_DELAY_MS = 5000;
const COMPAT_UPLOAD_MAX_RETRIES = 2;
const UPLOAD_CONCURRENCY_KEY = `nexus_upload_concurrency_${SITE_ID}`;
let modalFiles = [];
let lastUploadMethod = 'chunked';
let shareItems = [];
let shareHistoryRows = [];
let currentShareUrl = '';
let shareHistoryLoading = false;

function bytesToHuman(n){
  if(!n) return '0 B';
  const units = ['B','KB','MB','GB','TB'];
  let i = 0;
  let v = n;
  while(v >= 1024 && i < units.length - 1){
    v /= 1024;
    i++;
  }
  return v.toFixed(1) + ' ' + units[i];
}

function sleep(ms){
  return new Promise((resolve)=> setTimeout(resolve, Math.max(0, ms || 0)));
}

function uploadRetryBackoffMs(attempt){
  const a = Math.max(1, parseInt(attempt || 1, 10) || 1);
  return Math.min(UPLOAD_RETRY_MAX_DELAY_MS, UPLOAD_RETRY_BASE_DELAY_MS * Math.pow(2, a - 1));
}

function isRetriableHttpStatus(status){
  const s = parseInt(status || 0, 10) || 0;
  return [408, 409, 425, 429, 500, 502, 503, 504].includes(s);
}

function isRetriableError(err){
  const status = parseInt(err?.httpStatus || 0, 10) || 0;
  if(status && isRetriableHttpStatus(status)){
    return true;
  }
  const msg = String(err?.message || err || '').toLowerCase();
  if(!msg){
    return false;
  }
  return /load failed|failed to fetch|networkerror|network request failed|connection reset|connection aborted|timed out|timeout|econnreset|econnaborted|socket hang up|the network connection was lost/i.test(msg);
}

function normalizeUploadError(err, fallback){
  const raw = String(err?.message || err || '').trim();
  const base = String(fallback || '上传失败');
  if(!raw){
    return base;
  }
  if(/load failed|failed to fetch|networkerror|network request failed|the network connection was lost/i.test(raw)){
    return `${base}：网络请求中断（可能节点离线、面板重启中或网关超时）`;
  }
  if(/timeout|timed out|请求超时/i.test(raw)){
    return `${base}：请求超时，请降低并发后重试`;
  }
  return raw;
}

async function fetchJsonWithRetry(url, options, cfg){
  const conf = cfg || {};
  const maxRetries = Math.max(0, parseInt(conf.retries ?? UPLOAD_REQUEST_MAX_RETRIES, 10) || 0);
  const timeoutMs = Math.max(5000, parseInt(conf.timeoutMs ?? UPLOAD_REQUEST_TIMEOUT_MS, 10) || UPLOAD_REQUEST_TIMEOUT_MS);
  const onRetry = typeof conf.onRetry === 'function' ? conf.onRetry : null;
  let attempt = 0;
  while(true){
    const ctrl = new AbortController();
    const timer = setTimeout(()=> ctrl.abort(), timeoutMs);
    try{
      const resp = await fetch(url, {
        credentials: 'same-origin',
        ...(options || {}),
        signal: ctrl.signal
      });
      clearTimeout(timer);
      const data = await resp.json().catch(()=>({ok:false,error:`HTTP ${resp.status}`}));
      if(resp.ok){
        return data;
      }
      const err = new Error(String((data && data.error) || `HTTP ${resp.status}`));
      err.httpStatus = resp.status;
      if(attempt < maxRetries && isRetriableHttpStatus(resp.status)){
        attempt += 1;
        if(onRetry){
          try{ onRetry({attempt, maxRetries, error: err, status: resp.status}); }catch(_e){}
        }
        await sleep(uploadRetryBackoffMs(attempt));
        continue;
      }
      throw err;
    }catch(rawErr){
      clearTimeout(timer);
      let err = rawErr;
      if(rawErr && rawErr.name === 'AbortError'){
        err = new Error(`请求超时（>${Math.round(timeoutMs / 1000)} 秒）`);
      }else if(!(rawErr instanceof Error)){
        err = new Error(String(rawErr || '请求失败'));
      }
      if(attempt < maxRetries && isRetriableError(err)){
        attempt += 1;
        if(onRetry){
          try{ onRetry({attempt, maxRetries, error: err}); }catch(_e){}
        }
        await sleep(uploadRetryBackoffMs(attempt));
        continue;
      }
      throw err;
    }
  }
}

function clampUploadConcurrency(raw){
  const n = parseInt(raw, 10) || 0;
  if(n < MIN_UPLOAD_CONCURRENCY) return MIN_UPLOAD_CONCURRENCY;
  if(n > MAX_UPLOAD_CONCURRENCY) return MAX_UPLOAD_CONCURRENCY;
  return n;
}

function defaultUploadConcurrency(){
  const cores = parseInt(navigator.hardwareConcurrency || '0', 10) || 4;
  if(cores <= 2) return 2;
  if(cores <= 4) return 3;
  if(cores <= 8) return 4;
  return 6;
}

function selectedUploadConcurrency(){
  if(!fmModalConcurrency) return clampUploadConcurrency(defaultUploadConcurrency());
  return clampUploadConcurrency(fmModalConcurrency.value);
}

function initUploadConcurrency(){
  if(!fmModalConcurrency) return;
  fmModalConcurrency.innerHTML = '';
  for(let i=MIN_UPLOAD_CONCURRENCY;i<=MAX_UPLOAD_CONCURRENCY;i++){
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = `${i} 并发`;
    fmModalConcurrency.appendChild(opt);
  }
  const saved = clampUploadConcurrency(localStorage.getItem(UPLOAD_CONCURRENCY_KEY) || defaultUploadConcurrency());
  fmModalConcurrency.value = String(saved);
}

function updateBodyModalState(){
  const uploadOpen = !!(fmUploadModal && fmUploadModal.style.display !== 'none');
  const shareOpen = !!(fmShareModal && fmShareModal.style.display !== 'none');
  document.body.classList.toggle('modal-open', uploadOpen || shareOpen);
}

function openModal(){
  if(!fmUploadModal) return;
  fmUploadModal.style.display = 'flex';
  updateBodyModalState();
}

function closeModal(){
  if(!fmUploadModal) return;
  fmUploadModal.style.display = 'none';
  updateBodyModalState();
}

function openShareModal(){
  if(!fmShareModal) return;
  fmShareModal.style.display = 'flex';
  updateBodyModalState();
}

function closeShareModal(){
  if(!fmShareModal) return;
  fmShareModal.style.display = 'none';
  updateBodyModalState();
}

function formatDurationLabel(sec){
  const s = Math.max(0, parseInt(sec || 0, 10) || 0);
  if(!s) return '0 分钟';
  if(s % 86400 === 0){
    return `${s / 86400} 天`;
  }
  if(s % 3600 === 0){
    return `${s / 3600} 小时`;
  }
  if(s % 60 === 0){
    return `${s / 60} 分钟`;
  }
  return `${s} 秒`;
}

function shareDurationSec(){
  const value = parseInt(fmShareTtlValue?.value || '0', 10) || 0;
  const unit = String(fmShareTtlUnit?.value || 'hour');
  if(value <= 0) return 0;
  let mul = 3600;
  if(unit === 'minute') mul = 60;
  if(unit === 'day') mul = 86400;
  return value * mul;
}

function normalizeShareItems(items){
  if(!Array.isArray(items)) return [];
  const out = [];
  const seen = new Map();
  for(const row of items){
    const pathRaw = String(row?.path || '').replace(/\\/g, '/').replace(/^\/+/, '').trim();
    if(!pathRaw) continue;
    const name = String(row?.name || pathRaw.split('/').pop() || pathRaw);
    const isDir = !!row?.is_dir || String(row?.type || '').toLowerCase() === 'dir';
    if(seen.has(pathRaw)){
      if(isDir){
        const idx = seen.get(pathRaw);
        if(typeof idx === 'number' && out[idx]){
          out[idx].is_dir = true;
        }
      }
      continue;
    }
    seen.set(pathRaw, out.length);
    out.push({path: pathRaw, name, is_dir: isDir});
    if(out.length >= FILE_SHARE_MAX_ITEMS) break;
  }
  return out;
}

function renderShareItems(items){
  if(!fmShareItems) return;
  if(!items.length){
    fmShareItems.textContent = '未选择';
    return;
  }
  fmShareItems.innerHTML = '';
  items.forEach((it)=>{
    const row = document.createElement('div');
    row.className = 'fm-share-item';
    const left = document.createElement('span');
    left.className = 'mono';
    left.textContent = it.path;
    const right = document.createElement('span');
    right.className = 'muted sm';
    right.textContent = it.is_dir ? '目录' : '文件';
    row.appendChild(left);
    row.appendChild(right);
    fmShareItems.appendChild(row);
  });
}

function setShareStatus(text, isError){
  if(!fmShareStatus) return;
  fmShareStatus.textContent = text || '';
  fmShareStatus.style.color = isError ? 'rgba(248,113,113,0.95)' : '';
}

function clearCurrentShareLink(){
  currentShareUrl = '';
  if(fmShareLink) fmShareLink.value = '';
  if(fmShareCopy) fmShareCopy.disabled = true;
  if(fmShareRevoke) fmShareRevoke.disabled = true;
  if(fmShareOpen){
    fmShareOpen.style.display = 'none';
    fmShareOpen.removeAttribute('href');
  }
}

function shareStatusText(status){
  const s = String(status || '').toLowerCase();
  if(s === 'active') return '有效';
  if(s === 'expired') return '已过期';
  if(s === 'revoked') return '已取消';
  return '异常';
}

async function copyText(text){
  const val = String(text || '');
  if(!val) return false;
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(val);
      return true;
    }
  }catch(_err){
    // fallback below
  }
  if(!fmShareLink) return false;
  const old = fmShareLink.value;
  fmShareLink.value = val;
  fmShareLink.focus();
  fmShareLink.select();
  let ok = false;
  try{
    ok = document.execCommand('copy');
  }catch(_err){
    ok = false;
  }
  fmShareLink.value = old;
  return ok;
}

async function revokeShareByUrl(url){
  const target = String(url || '').trim();
  if(!target) throw new Error('缺少分享链接');
  const resp = await fetch(`/websites/${SITE_ID}/files/share/revoke`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ url: target })
  });
  const data = await resp.json().catch(()=>({ok:false,error:'取消分享失败'}));
  if(!data.ok){
    throw new Error(data.error || '取消分享失败');
  }
  return data;
}

function filteredShareHistoryRows(items){
  const rows = Array.isArray(items) ? items : [];
  if(!shareItems.length){
    return rows;
  }
  const picked = new Set(
    normalizeShareItems(shareItems).map((it)=>String(it.path || '').trim()).filter(Boolean)
  );
  if(!picked.size){
    return rows;
  }
  return rows.filter((row)=>{
    const arr = Array.isArray(row?.items) ? row.items : [];
    for(const item of arr){
      const p = String(item?.path || '').trim();
      if(picked.has(p)){
        return true;
      }
    }
    return false;
  });
}

function clearFileShareHistory(){
  document.querySelectorAll('.fm-row-share-links').forEach((box)=>{
    box.innerHTML = '';
    box.classList.remove('has-links');
  });
}

function renderFileShareHistory(items){
  clearFileShareHistory();
  const rows = Array.isArray(items) ? items : [];
  if(!rows.length){
    return;
  }
  const byPath = new Map();
  rows.forEach((row)=>{
    const arr = Array.isArray(row?.items) ? row.items : [];
    arr.forEach((it)=>{
      const p = String(it?.path || '').trim();
      if(!p) return;
      if(!byPath.has(p)){
        byPath.set(p, []);
      }
      byPath.get(p).push(row);
    });
  });
  document.querySelectorAll('.fm-row-share-links').forEach((box)=>{
    const p = String(box.dataset.path || '').trim();
    if(!p) return;
    const links = byPath.get(p) || [];
    if(!links.length){
      return;
    }
    box.classList.add('has-links');
    const limit = 3;
    links.slice(0, limit).forEach((it)=>{
      const wrap = document.createElement('div');
      wrap.className = 'fm-row-share-link';

      const main = document.createElement('div');
      main.className = 'fm-row-share-main';

      const badge = document.createElement('span');
      const status = String(it?.status || 'invalid');
      badge.className = `fm-share-status ${status}`;
      badge.textContent = shareStatusText(status);
      main.appendChild(badge);

      const link = document.createElement('a');
      link.className = 'mono fm-row-share-url';
      link.target = '_blank';
      link.rel = 'noopener';
      const rowUrl = String(it?.url || '');
      if(rowUrl){
        link.href = rowUrl;
        link.textContent = rowUrl;
      }else{
        link.href = '#';
        link.classList.add('disabled');
        link.textContent = `(短链丢失: ${String(it?.code || '-')})`;
      }
      main.appendChild(link);

      const createdAt = String(it?.created_at || '');
      const expireAt = String(it?.expire_at || '');
      const meta = document.createElement('span');
      meta.className = 'fm-row-share-meta';
      meta.textContent = [createdAt ? `创建 ${createdAt}` : '', expireAt ? `过期 ${expireAt}` : ''].filter(Boolean).join(' · ') || '-';
      main.appendChild(meta);

      const actions = document.createElement('div');
      actions.className = 'fm-row-share-actions';

      const copyBtn = document.createElement('button');
      copyBtn.className = 'btn xs ghost';
      copyBtn.type = 'button';
      copyBtn.textContent = '复制';
      copyBtn.disabled = !rowUrl;
      copyBtn.addEventListener('click', async ()=>{
        const ok = await copyText(rowUrl);
        setShareStatus(ok ? '链接已复制' : '复制失败，请手动复制', !ok);
      });
      actions.appendChild(copyBtn);

      if(Boolean(it?.can_revoke) && rowUrl){
        const revokeBtn = document.createElement('button');
        revokeBtn.className = 'btn xs ghost fm-act-danger';
        revokeBtn.type = 'button';
        revokeBtn.textContent = '取消';
        revokeBtn.addEventListener('click', async ()=>{
          if(!confirm('确定取消该分享链接吗？取消后将立即失效。')){
            return;
          }
          revokeBtn.disabled = true;
          try{
            await revokeShareAndRefresh(rowUrl);
          }catch(err){
            setShareStatus(String(err), true);
            revokeBtn.disabled = false;
          }
        });
        actions.appendChild(revokeBtn);
      }

      wrap.appendChild(main);
      wrap.appendChild(actions);
      box.appendChild(wrap);
    });
    if(links.length > limit){
      const more = document.createElement('div');
      more.className = 'muted sm';
      more.textContent = `另有 ${links.length - limit} 条历史链接`;
      box.appendChild(more);
    }
  });
}

async function revokeShareAndRefresh(url){
  await revokeShareByUrl(url);
  if(currentShareUrl === url){
    clearCurrentShareLink();
  }
  setShareStatus('分享已取消，原链接已失效', false);
  await loadShareHistory();
}

function renderShareHistory(items){
  if(!fmShareHistory) return;
  const rows = filteredShareHistoryRows(items);
  fmShareHistory.innerHTML = '';
  if(!rows.length){
    const empty = document.createElement('div');
    empty.className = 'muted sm';
    empty.textContent = shareItems.length ? '当前选择暂无历史分享链接' : '暂无历史分享链接';
    fmShareHistory.appendChild(empty);
    return;
  }
  rows.forEach((it)=>{
    const row = document.createElement('div');
    row.className = 'fm-share-history-row';

    const info = document.createElement('div');
    info.className = 'fm-share-history-info';

    const top = document.createElement('div');
    top.className = 'fm-share-history-top';
    const url = document.createElement('span');
    url.className = 'mono fm-share-history-url';
    const rowUrl = String(it?.url || '');
    url.textContent = rowUrl || `(短链丢失: ${String(it?.code || '-')})`;
    const badge = document.createElement('span');
    const status = String(it?.status || 'invalid');
    badge.className = `fm-share-status ${status}`;
    badge.textContent = shareStatusText(status);
    top.appendChild(url);
    top.appendChild(badge);

    const meta = document.createElement('div');
    meta.className = 'muted sm';
    const parts = [];
    const firstItem = String(it?.first_item || '');
    const itemCount = parseInt(it?.item_count || 0, 10) || 0;
    if(firstItem) parts.push(firstItem);
    if(itemCount > 0) parts.push(`共 ${itemCount} 项`);
    const createdAt = String(it?.created_at || '');
    if(createdAt) parts.push(`创建 ${createdAt}`);
    const expireAt = String(it?.expire_at || '');
    if(expireAt) parts.push(`过期 ${expireAt}`);
    const revokedAt = String(it?.revoked_at || '');
    if(revokedAt) parts.push(`取消 ${revokedAt}`);
    meta.textContent = parts.join(' · ') || '-';

    info.appendChild(top);
    info.appendChild(meta);

    const actions = document.createElement('div');
    actions.className = 'fm-share-history-actions';
    const copyBtn = document.createElement('button');
    copyBtn.className = 'btn xs ghost';
    copyBtn.type = 'button';
    copyBtn.textContent = '复制';
    copyBtn.disabled = !rowUrl;
    copyBtn.addEventListener('click', async ()=>{
      const ok = await copyText(rowUrl);
      setShareStatus(ok ? '链接已复制' : '复制失败，请手动复制', !ok);
    });
    actions.appendChild(copyBtn);

    const openBtn = document.createElement('a');
    openBtn.className = 'btn xs ghost';
    openBtn.textContent = '打开';
    openBtn.target = '_blank';
    openBtn.rel = 'noopener';
    if(rowUrl){
      openBtn.href = rowUrl;
    }else{
      openBtn.href = '#';
      openBtn.setAttribute('disabled', 'disabled');
      openBtn.classList.add('disabled');
    }
    actions.appendChild(openBtn);

    if(Boolean(it?.can_revoke) && rowUrl){
      const revokeBtn = document.createElement('button');
      revokeBtn.className = 'btn xs ghost fm-act-danger';
      revokeBtn.type = 'button';
      revokeBtn.textContent = '取消';
      revokeBtn.addEventListener('click', async ()=>{
        if(!confirm('确定取消该分享链接吗？取消后将立即失效。')){
          return;
        }
        revokeBtn.disabled = true;
        try{
          await revokeShareAndRefresh(rowUrl);
        }catch(err){
          setShareStatus(String(err), true);
          revokeBtn.disabled = false;
        }
      });
      actions.appendChild(revokeBtn);
    }

    row.appendChild(info);
    row.appendChild(actions);
    fmShareHistory.appendChild(row);
  });
}

async function loadShareHistory(){
  if(shareHistoryLoading) return;
  shareHistoryLoading = true;
  if(fmShareHistory){
    fmShareHistory.innerHTML = '<div class="muted sm">加载中…</div>';
  }
  try{
    const resp = await fetch(`/websites/${SITE_ID}/files/share/list?limit=50`);
    const data = await resp.json().catch(()=>({ok:false,error:'加载历史链接失败'}));
    if(!data.ok){
      throw new Error(data.error || '加载历史链接失败');
    }
    shareHistoryRows = Array.isArray(data.items) ? data.items : [];
    renderFileShareHistory(shareHistoryRows);
    renderShareHistory(shareHistoryRows);
  }catch(err){
    shareHistoryRows = [];
    clearFileShareHistory();
    if(fmShareHistory){
      fmShareHistory.innerHTML = '';
      const fail = document.createElement('div');
      fail.className = 'muted sm';
      fail.style.color = 'rgba(248,113,113,0.95)';
      fail.textContent = String(err);
      fmShareHistory.appendChild(fail);
    }
  }finally{
    shareHistoryLoading = false;
  }
}

function resetShareTtl(){
  let sec = FILE_SHARE_DEFAULT_TTL_SEC || 86400;
  let unit = 'hour';
  let value = Math.max(1, Math.round(sec / 3600));
  if(sec % 86400 === 0){
    unit = 'day';
    value = Math.max(1, sec / 86400);
  }else if(sec % 3600 === 0){
    unit = 'hour';
    value = Math.max(1, sec / 3600);
  }else{
    unit = 'minute';
    value = Math.max(1, Math.round(sec / 60));
  }
  if(fmShareTtlValue) fmShareTtlValue.value = String(value);
  if(fmShareTtlUnit) fmShareTtlUnit.value = unit;
}

function openShareForItems(items){
  const picked = normalizeShareItems(items);
  if(!picked.length){
    alert('请先选择要分享的文件或目录');
    return;
  }
  shareItems = picked;
  resetShareTtl();
  renderShareItems(shareItems);
  clearCurrentShareLink();
  setShareStatus(`已选择 ${shareItems.length} 项`, false);
  openShareModal();
  renderShareHistory(shareHistoryRows);
  loadShareHistory();
}

function collectCheckedShareItems(){
  const rows = Array.from(document.querySelectorAll('.fm-row'));
  const out = [];
  rows.forEach((row)=>{
    const box = row.querySelector('.fm-item-check');
    if(!box || !box.checked) return;
    const path = String(row.dataset.path || '').trim();
    if(!path) return;
    out.push({
      path,
      name: String(row.dataset.displayName || path.split('/').pop() || path),
      is_dir: String(row.dataset.type || '').toLowerCase() === 'dir'
    });
  });
  return normalizeShareItems(out);
}

function renderModalList(files){
  if(!fmModalFileList || !fmModalStats) return;
  fmModalFileList.innerHTML = '';
  if(!files.length){
    fmModalFileList.textContent = '未选择';
    fmModalStats.textContent = '';
    return;
  }
  const limit = 200;
  const totalBytes = files.reduce((s,f)=>s + (f.size || 0), 0) || 0;
  const show = files.slice(0, limit);
  show.forEach((f)=>{
    const row = document.createElement('div');
    row.className = 'fm-upload-item';
    const name = document.createElement('span');
    name.className = 'fm-upload-name';
    name.textContent = f.webkitRelativePath || f.name;
    const size = document.createElement('span');
    size.className = 'fm-upload-size';
    size.textContent = bytesToHuman(f.size || 0);
    row.appendChild(name);
    row.appendChild(size);
    fmModalFileList.appendChild(row);
  });
  if(files.length > limit){
    const more = document.createElement('div');
    more.className = 'muted sm';
    more.textContent = `仅显示前 ${limit} 项，实际 ${files.length} 项`;
    fmModalFileList.appendChild(more);
  }
  fmModalStats.textContent = `共 ${files.length} 个文件 · ${bytesToHuman(totalBytes)}`;
}

let modalMode = 'file';

function setModalMode(mode){
  modalMode = mode === 'folder' ? 'folder' : 'file';
  if(fmModeFiles) fmModeFiles.classList.toggle('active', modalMode === 'file');
  if(fmModeFolder) fmModeFolder.classList.toggle('active', modalMode === 'folder');
  if(fmModalPick) fmModalPick.textContent = modalMode === 'folder' ? '选择文件夹' : '选择文件';
  if(fmModalPick){
    if(modalMode === 'folder' && !SUPPORTS_FOLDER_PICK){
      fmModalPick.title = '当前浏览器不支持文件夹选择';
    }else{
      fmModalPick.title = modalMode === 'folder' ? '选择文件夹' : '选择文件';
    }
  }
  if(fmModalSub){
    fmModalSub.textContent = modalMode === 'folder'
      ? '选择文件夹后确认上传'
      : '选择文件后确认上传';
  }
  modalFiles = [];
  if(fmModalFilesInput) fmModalFilesInput.value = '';
  if(fmModalFolderInput) fmModalFolderInput.value = '';
  if(fmModalHint) fmModalHint.textContent = '未选择';
  renderModalList([]);
  if(fmModalStart) fmModalStart.disabled = true;
  if(fmModalCompat) fmModalCompat.disabled = true;
  if(fmModalProgress) fmModalProgress.style.display = 'none';
  if(fmModalProgressFill) fmModalProgressFill.style.width = '0%';
  if(fmModalStatus) fmModalStatus.textContent = '';
  if(fmModalRetry) fmModalRetry.style.display = 'none';
}

function bufToHex(buffer){
  const bytes = new Uint8Array(buffer);
  const hex = [];
  for(const b of bytes){
    hex.push(b.toString(16).padStart(2, '0'));
  }
  return hex.join('');
}

const HAS_SUBTLE = !!(window.crypto && window.crypto.subtle);

async function sha256Hex(arrayBuffer){
  if(!HAS_SUBTLE) return '';
  const hash = await crypto.subtle.digest('SHA-256', arrayBuffer);
  return bufToHex(hash);
}

async function blobToBase64(blob){
  return await new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = ()=>{
      const text = String(reader.result || '');
      const i = text.indexOf(',');
      resolve(i >= 0 ? text.slice(i + 1) : text);
    };
    reader.onerror = ()=> reject(new Error('分片编码失败'));
    reader.readAsDataURL(blob);
  });
}

function uploadKey(file, path, filename){
  const p = path || CUR_PATH || '';
  const f = filename || file.name || '';
  return `nexus_upload_${SITE_ID}_${p}_${f}_${file.size}_${file.lastModified}`;
}

async function getResumeOffset(file, uploadId, path, filename){
  const data = await fetchJsonWithRetry(
    `/websites/${SITE_ID}/files/upload_status`,
    {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ path: path || CUR_PATH, filename: filename || file.name, upload_id: uploadId })
    },
    {
      retries: 2,
      timeoutMs: 30000
    }
  );
  if(!data.ok) return 0;
  return parseInt(data.offset || 0, 10) || 0;
}

function splitRelPath(rel){
  const clean = String(rel || '').replace(/^[/\\\\]+/, '').replace(/\\\\/g, '/');
  if(!clean) return {dir:'', name:''};
  const parts = clean.split('/').filter(Boolean);
  const name = parts.pop() || '';
  return {dir: parts.join('/'), name};
}

function joinPath(a,b){
  const aa = String(a || '').replace(/[\\\\/]+$/,'');
  const bb = String(b || '').replace(/^[\\\\/]+/, '');
  if(!aa) return bb;
  if(!bb) return aa;
  return aa + '/' + bb;
}

let tableStats = {total:0, files:0, dirs:0, size:0};

function computeTableStats(){
  const rows = Array.from(document.querySelectorAll('.fm-row'));
  let total = 0;
  let files = 0;
  let dirs = 0;
  let size = 0;
  for(const r of rows){
    total += 1;
    const type = r.dataset.type || '';
    if(type === 'dir'){
      dirs += 1;
    }else{
      files += 1;
      size += parseInt(r.dataset.size || '0', 10) || 0;
    }
  }
  tableStats = {total, files, dirs, size};
}

function renderStats(shownCount){
  if(!fmStats) return;
  let text = `共 ${tableStats.total} 项 · 目录 ${tableStats.dirs} · 文件 ${tableStats.files} · 大小 ${bytesToHuman(tableStats.size)}`;
  if(typeof shownCount === 'number' && shownCount !== tableStats.total){
    text += ` · 匹配 ${shownCount} 项`;
  }
  fmStats.textContent = text;
}

function updateSelectionInfo(){
  const checks = Array.from(document.querySelectorAll('.fm-item-check'));
  const visibleChecks = checks.filter((c)=>{
    const row = c.closest('.fm-row');
    return row && row.style.display !== 'none';
  });
  const selected = visibleChecks.filter((c)=>c.checked);
  const selectedAll = checks.filter((c)=>c.checked);
  if(visibleChecks.length){
    if(fmSelectAll){
      fmSelectAll.checked = selected.length === visibleChecks.length;
      fmSelectAll.indeterminate = selected.length > 0 && selected.length < visibleChecks.length;
    }
  }else if(fmSelectAll){
    fmSelectAll.checked = false;
    fmSelectAll.indeterminate = false;
  }
  if(fmSelectInfo){
    fmSelectInfo.textContent = selected.length ? `已选择 ${selected.length} 项` : '';
  }
  if(fmShareBtn){
    const count = selectedAll.length;
    fmShareBtn.disabled = count === 0;
    fmShareBtn.textContent = count ? `分享选中 (${count})` : '分享选中';
  }
}

function applySearchFilter(){
  const rows = Array.from(document.querySelectorAll('.fm-row'));
  const q = (fmSearch?.value || '').trim().toLowerCase();
  let shown = 0;
  rows.forEach((r)=>{
    const name = r.dataset.name || '';
    const match = !q || name.includes(q);
    r.style.display = match ? '' : 'none';
    if(match) shown += 1;
  });
  const emptyRow = document.getElementById('fmSearchEmptyRow');
  if(emptyRow){
    emptyRow.style.display = shown ? 'none' : '';
  }
  renderStats(shown);
  updateSelectionInfo();
}

function resolveUploadTarget(file){
  const rel = file.webkitRelativePath || '';
  if(rel){
    const info = splitRelPath(rel);
    return {path: joinPath(CUR_PATH, info.dir), filename: info.name || file.name};
  }
  return {path: CUR_PATH, filename: file.name};
}

async function uploadFile(file, uploadId, startOffset, path, filename, totalBytes, progressCb, ui){
  let offset = startOffset || 0;
  const total = file.size;
  const panel = ui?.panel;
  const progressFill = ui?.progressFill;
  const status = ui?.status;
  const retry = ui?.retry;
  const button = ui?.button;
  if(panel) panel.style.display = 'block';
  if(retry) retry.style.display = 'none';
  if(button) button.disabled = true;
  if(status) status.textContent = `准备上传 ${file.name} (${bytesToHuman(total)})…`;
  if(total === 0){
    const data = await fetchJsonWithRetry(
      `/websites/${SITE_ID}/files/upload_chunk`,
      {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          path: path || CUR_PATH,
          filename: filename || file.name,
          upload_id: uploadId,
          offset: 0,
          done: true,
          allow_empty: true
        })
      },
      {
        onRetry: ({attempt, maxRetries})=>{
          if(status){
            status.textContent = `网络抖动，空文件分片重试中（${attempt}/${maxRetries}）…`;
          }
        }
      }
    );
    if(!data.ok){
      throw new Error(data.error || '上传失败');
    }
    if(progressCb) progressCb(0);
    return;
  }
  while(offset < total){
    const chunk = file.slice(offset, offset + CHUNK_SIZE);
    if(chunk.size <= 0){
      break;
    }
    let chunkSha = '';
    if(HAS_SUBTLE){
      const buf = await chunk.arrayBuffer();
      chunkSha = await sha256Hex(buf);
    }
    const b64 = await blobToBase64(chunk);
    const done = (offset + chunk.size) >= total;
    const payload = {
      path: path || CUR_PATH,
      filename: filename || file.name,
      upload_id: uploadId,
      offset: offset,
      done: done,
      content_b64: b64
    };
    if(chunkSha){
      payload.chunk_sha256 = chunkSha;
    }
    const data = await fetchJsonWithRetry(
      `/websites/${SITE_ID}/files/upload_chunk`,
      {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      },
      {
        onRetry: ({attempt, maxRetries})=>{
          if(status){
            status.textContent = `网络抖动，分片重试中：${file.name}（${attempt}/${maxRetries}）…`;
          }
        }
      }
    );
    if(!data.ok){
      if(data.expected_offset !== undefined){
        offset = parseInt(data.expected_offset || 0, 10) || 0;
        continue;
      }
      throw new Error(data.error || '上传失败');
    }
    offset += chunk.size;
    if(progressCb) progressCb(chunk.size);
    localStorage.setItem(uploadKey(file, path, filename), uploadId);
  }
  localStorage.removeItem(uploadKey(file, path, filename));
  if(status) status.textContent = '上传完成';
  if(button) button.disabled = false;
}

async function startChunkedUpload(files, ui, resumeOnly){
  lastUploadMethod = 'chunked';
  if(!files.length){
    alert('请选择文件或文件夹');
    return;
  }
  if(!HAS_SUBTLE && ui?.status){
    ui.status.textContent = '提示：当前环境不支持 SHA256（将跳过校验）。建议使用 HTTPS 或现代浏览器。';
  }
  for(const f of files){
    if(UPLOAD_MAX_BYTES && f.size > UPLOAD_MAX_BYTES){
      alert(`文件过大：${f.name}（${bytesToHuman(f.size)}），超过限制 ${bytesToHuman(UPLOAD_MAX_BYTES)}`);
      return;
    }
  }
  if(ui?.button) ui.button.disabled = true;
  if(fmModalCompat) fmModalCompat.disabled = true;
  const totalBytes = files.reduce((s,f)=>s + (f.size || 0), 0) || 0;
  const total = totalBytes || 0;
  let uploadedBytes = 0;
  let cursor = 0;
  let lastUiTs = 0;
  let lastName = '';
  try{
    if(resumeOnly){
      for(const file of files){
        const target = resolveUploadTarget(file);
        const key = uploadKey(file, target.path, target.filename);
        if(!localStorage.getItem(key)){
          throw new Error('找不到可恢复的上传');
        }
      }
    }
    const flushProgress = (name, force)=>{
      const now = Date.now();
      if(!force && (now - lastUiTs) < PROGRESS_UPDATE_INTERVAL_MS){
        return;
      }
      if(name){
        lastName = name;
      }
      lastUiTs = now;
      const doneBytes = Math.max(0, Math.min(total, uploadedBytes));
      const pct = total > 0 ? Math.min(100, Math.round((doneBytes / total) * 100)) : 100;
      if(ui?.progressFill) ui.progressFill.style.width = pct + '%';
      if(ui?.status){
        ui.status.textContent = `上传中：${lastName || '-'} · ${bytesToHuman(doneBytes)} / ${bytesToHuman(total)} (${pct}%)`;
      }
    };
    const updateProgress = (delta, name, force)=>{
      if(delta > 0){
        uploadedBytes += delta;
      }
      flushProgress(name, force);
    };
    const concurrency = Math.max(1, Math.min(files.length, selectedUploadConcurrency()));
    if(ui?.status){
      ui.status.textContent = `准备上传：${files.length} 个文件，${concurrency} 并发`;
    }
    if(ui?.progressFill) ui.progressFill.style.width = '0%';
    const worker = async ()=>{
      while(true){
        if(cursor >= files.length) return;
        const file = files[cursor++];
        const target = resolveUploadTarget(file);
        const key = uploadKey(file, target.path, target.filename);
        let uploadId = localStorage.getItem(key) || '';
        if(!uploadId){
          if(resumeOnly){
            throw new Error('找不到可恢复的上传');
          }
          uploadId = Math.random().toString(16).slice(2) + Date.now().toString(16);
        }
        let offset = 0;
        try{
          offset = await getResumeOffset(file, uploadId, target.path, target.filename);
        }catch(err){
          if(resumeOnly){
            throw err;
          }
          if(ui?.status){
            ui.status.textContent = `${normalizeUploadError(err, '获取续传状态失败')}，已从头上传：${file.name}`;
          }
          offset = 0;
        }
        if(offset > 0){
          updateProgress(offset, file.name, true);
        }else{
          updateProgress(0, file.name, false);
        }
        await uploadFile(
          file,
          uploadId,
          offset,
          target.path,
          target.filename,
          total,
          (d)=>updateProgress(d, file.name, false),
          ui
        );
        updateProgress(0, file.name, true);
      }
    };
    const workers = [];
    for(let i=0;i<concurrency;i++){
      workers.push(worker());
    }
    await Promise.all(workers);
    window.location.reload();
  }catch(err){
    if(ui?.status) ui.status.textContent = normalizeUploadError(err, '上传失败');
    if(ui?.retry) ui.retry.style.display = 'inline-block';
    if(ui?.button) ui.button.disabled = false;
    if(fmModalCompat) fmModalCompat.disabled = false;
  }
}

async function compatUploadOnce(files, mode, ui){
  const form = new FormData();
  form.append('path', CUR_PATH || '');
  const field = mode === 'folder' ? 'folder' : 'files';
  files.forEach((f)=>{
    const name = f.webkitRelativePath || f.name;
    form.append(field, f, name);
  });
  return await new Promise((resolve, reject)=>{
    const xhr = new XMLHttpRequest();
    xhr.open('POST', `/websites/${SITE_ID}/files/upload`);
    xhr.upload.onprogress = (e)=>{
      if(!e.lengthComputable) return;
      const pct = Math.min(100, Math.round((e.loaded / e.total) * 100));
      if(ui?.progressFill) ui.progressFill.style.width = pct + '%';
      if(ui?.status){
        ui.status.textContent = `兼容上传中：${bytesToHuman(e.loaded)} / ${bytesToHuman(e.total)} (${pct}%)`;
      }
    };
    xhr.onload = ()=>{
      if(xhr.status >= 200 && xhr.status < 400){
        resolve();
      }else{
        const err = new Error(`上传失败（${xhr.status}）`);
        err.httpStatus = xhr.status;
        reject(err);
      }
    };
    xhr.onerror = ()=> reject(new Error('上传失败：网络请求中断'));
    xhr.send(form);
  });
}

async function startCompatUpload(files, mode, ui){
  lastUploadMethod = 'compat';
  if(!files.length){
    alert('请选择文件或文件夹');
    return;
  }
  for(const f of files){
    if(UPLOAD_MAX_BYTES && f.size > UPLOAD_MAX_BYTES){
      alert(`文件过大：${f.name}（${bytesToHuman(f.size)}），超过限制 ${bytesToHuman(UPLOAD_MAX_BYTES)}`);
      return;
    }
  }
  if(ui?.panel) ui.panel.style.display = 'block';
  if(ui?.retry) ui.retry.style.display = 'none';
  if(ui?.button) ui.button.disabled = true;
  if(fmModalCompat) fmModalCompat.disabled = true;
  if(ui?.status) ui.status.textContent = '兼容上传中…';
  if(ui?.progressFill) ui.progressFill.style.width = '0%';
  try{
    const totalAttempts = Math.max(1, COMPAT_UPLOAD_MAX_RETRIES + 1);
    for(let attempt=1; attempt<=totalAttempts; attempt++){
      try{
        await compatUploadOnce(files, mode, ui);
        break;
      }catch(err){
        const canRetry = attempt < totalAttempts && isRetriableError(err);
        if(!canRetry){
          throw err;
        }
        if(ui?.status){
          ui.status.textContent = `网络抖动，兼容上传重试中（${attempt}/${COMPAT_UPLOAD_MAX_RETRIES}）…`;
        }
        await sleep(uploadRetryBackoffMs(attempt));
      }
    }
    window.location.reload();
  }catch(err){
    if(ui?.status) ui.status.textContent = normalizeUploadError(err, '上传失败');
    if(ui?.retry) ui.retry.style.display = 'inline-block';
    if(ui?.button) ui.button.disabled = false;
    if(fmModalCompat) fmModalCompat.disabled = false;
  }
}

pickFilesBtn?.addEventListener('click', ()=>{
  setModalMode('file');
  openModal();
});

pickFolderBtn?.addEventListener('click', ()=>{
  if(!SUPPORTS_FOLDER_PICK){
    alert('当前浏览器不支持文件夹选择，请使用 Chrome / Edge 或尝试兼容上传。');
    return;
  }
  setModalMode('folder');
  openModal();
});

fmModeFiles?.addEventListener('click', ()=> setModalMode('file'));
fmModeFolder?.addEventListener('click', ()=>{
  if(!SUPPORTS_FOLDER_PICK){
    alert('当前浏览器不支持文件夹选择，请使用 Chrome / Edge。');
    return;
  }
  setModalMode('folder');
});

fmModalPick?.addEventListener('click', ()=>{
  if(modalMode === 'folder'){
    if(!SUPPORTS_FOLDER_PICK){
      alert('当前浏览器不支持文件夹选择，请使用 Chrome / Edge。');
      return;
    }
    fmModalFolderInput?.click();
  }else{
    fmModalFilesInput?.click();
  }
});

fmModalFilesInput?.addEventListener('change', ()=>{
  modalFiles = fmModalFilesInput?.files ? Array.from(fmModalFilesInput.files) : [];
  if(fmModalHint){
    fmModalHint.textContent = modalFiles.length ? `已选择 ${modalFiles.length} 个文件` : '未选择';
  }
  renderModalList(modalFiles);
  if(fmModalStart) fmModalStart.disabled = !modalFiles.length;
  if(fmModalCompat) fmModalCompat.disabled = !modalFiles.length;
});

fmModalFolderInput?.addEventListener('change', ()=>{
  modalFiles = fmModalFolderInput?.files ? Array.from(fmModalFolderInput.files) : [];
  if(fmModalHint){
    if(modalFiles.length){
      const rel = modalFiles[0].webkitRelativePath || '';
      const folderName = rel ? rel.split('/')[0] : '文件夹';
      fmModalHint.textContent = `已选择：${folderName}`;
    }else{
      fmModalHint.textContent = '未选择';
    }
  }
  renderModalList(modalFiles);
  if(fmModalStart) fmModalStart.disabled = !modalFiles.length;
  if(fmModalCompat) fmModalCompat.disabled = !modalFiles.length;
});

fmModalStart?.addEventListener('click', async ()=>{
  if(!modalFiles.length){
    alert(modalMode === 'folder' ? '请选择文件夹' : '请选择文件');
    return;
  }
  await startChunkedUpload(modalFiles, modalUI, false);
});

fmModalCompat?.addEventListener('click', async ()=>{
  if(!modalFiles.length){
    alert(modalMode === 'folder' ? '请选择文件夹' : '请选择文件');
    return;
  }
  await startCompatUpload(modalFiles, modalMode, modalUI);
});

fmModalRetry?.addEventListener('click', async ()=>{
  if(!modalFiles.length) return;
  if(lastUploadMethod === 'compat'){
    await startCompatUpload(modalFiles, modalMode, modalUI);
  }else{
    await startChunkedUpload(modalFiles, modalUI, true);
  }
});

fmModalConcurrency?.addEventListener('change', ()=>{
  const val = selectedUploadConcurrency();
  if(fmModalConcurrency) fmModalConcurrency.value = String(val);
  localStorage.setItem(UPLOAD_CONCURRENCY_KEY, String(val));
});

const modalClose = ()=>{
  closeModal();
};
fmModalClose?.addEventListener('click', modalClose);
fmModalCloseTop?.addEventListener('click', modalClose);
fmUploadModal?.addEventListener('click', (e)=>{
  if(e.target === fmUploadModal) closeModal();
});
const shareModalClose = ()=>{
  closeShareModal();
};
fmShareClose?.addEventListener('click', shareModalClose);
fmShareCloseTop?.addEventListener('click', shareModalClose);
fmShareModal?.addEventListener('click', (e)=>{
  if(e.target === fmShareModal) closeShareModal();
});

fmShareBtn?.addEventListener('click', ()=>{
  openShareForItems(collectCheckedShareItems());
});

document.querySelectorAll('.fm-share-one').forEach((btn)=>{
  btn.addEventListener('click', ()=>{
    openShareForItems(
      [
        {
          path: String(btn.dataset.path || ''),
          name: String(btn.dataset.name || ''),
          is_dir: String(btn.dataset.type || '').toLowerCase() === 'dir'
        }
      ]
    );
  });
});

fmShareTtlValue?.addEventListener('input', ()=>{
  const sec = shareDurationSec();
  if(sec > 0 && (sec < FILE_SHARE_MIN_TTL_SEC || sec > FILE_SHARE_MAX_TTL_SEC)){
    setShareStatus(`有效期将自动限制为 ${formatDurationLabel(FILE_SHARE_MIN_TTL_SEC)} - ${formatDurationLabel(FILE_SHARE_MAX_TTL_SEC)}`, false);
    return;
  }
  if(shareItems.length){
    setShareStatus(`已选择 ${shareItems.length} 项`, false);
  }
});
fmShareTtlUnit?.addEventListener('change', ()=>{
  if(shareItems.length){
    setShareStatus(`已选择 ${shareItems.length} 项`, false);
  }
});

fmShareGen?.addEventListener('click', async ()=>{
  if(!shareItems.length){
    alert('请先选择要分享的文件或目录');
    return;
  }
  const rawSec = shareDurationSec();
  if(rawSec <= 0){
    alert('请输入有效的分享时长');
    return;
  }
  const ttlSec = Math.max(FILE_SHARE_MIN_TTL_SEC, Math.min(FILE_SHARE_MAX_TTL_SEC, rawSec));
  if(fmShareGen) fmShareGen.disabled = true;
  if(fmShareCopy) fmShareCopy.disabled = true;
  setShareStatus('正在生成分享链接…', false);
  try{
    const resp = await fetch(`/websites/${SITE_ID}/files/share`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ items: shareItems, ttl_sec: ttlSec })
    });
    const data = await resp.json().catch(()=>({ok:false,error:'生成分享链接失败'}));
    if(!data.ok){
      throw new Error(data.error || '生成分享链接失败');
    }
    const url = String(data.url || '');
    currentShareUrl = url;
    if(fmShareLink) fmShareLink.value = url;
    if(fmShareCopy) fmShareCopy.disabled = !url;
    if(fmShareRevoke) fmShareRevoke.disabled = !url;
    if(fmShareOpen){
      if(url){
        fmShareOpen.href = url;
        fmShareOpen.style.display = '';
      }else{
        fmShareOpen.style.display = 'none';
      }
    }
    const expireText = String(data.expire_at || '');
    const ttlText = formatDurationLabel(Number(data.ttl_sec || ttlSec));
    setShareStatus(expireText ? `已生成，${ttlText}后过期（${expireText}）` : `已生成，${ttlText}后过期`, false);
    await loadShareHistory();
  }catch(err){
    if(fmShareRevoke && !currentShareUrl){
      fmShareRevoke.disabled = true;
    }
    setShareStatus(String(err), true);
  }finally{
    if(fmShareGen) fmShareGen.disabled = false;
  }
});

fmShareRevoke?.addEventListener('click', async ()=>{
  const url = String(currentShareUrl || fmShareLink?.value || '');
  if(!url){
    return;
  }
  if(!confirm('确定取消该分享链接吗？取消后将立即失效。')){
    return;
  }
  if(fmShareRevoke) fmShareRevoke.disabled = true;
  setShareStatus('正在取消分享…', false);
  try{
    await revokeShareAndRefresh(url);
  }catch(err){
    setShareStatus(String(err), true);
    if(fmShareRevoke) fmShareRevoke.disabled = !currentShareUrl;
  }
});

fmShareCopy?.addEventListener('click', async ()=>{
  const text = String(fmShareLink?.value || '');
  if(!text) return;
  const copied = await copyText(text);
  setShareStatus(copied ? '链接已复制' : '复制失败，请手动复制', !copied);
});

document.addEventListener('keydown', (e)=>{
  if(e.key !== 'Escape') return;
  if(fmUploadModal && fmUploadModal.style.display !== 'none'){
    closeModal();
  }
  if(fmShareModal && fmShareModal.style.display !== 'none'){
    closeShareModal();
  }
});

fmSearch?.addEventListener('input', applySearchFilter);
fmSearchClear?.addEventListener('click', ()=>{
  if(fmSearch) fmSearch.value = '';
  applySearchFilter();
});

fmRefreshBtn?.addEventListener('click', ()=> window.location.reload());
fmUpBtn?.addEventListener('click', ()=>{
  const segs = String(CUR_PATH || '').split('/').filter(Boolean);
  if(!segs.length) return;
  segs.pop();
  const up = segs.join('/');
  window.location.href = `/websites/${SITE_ID}/files?path=${encodeURIComponent(up)}`;
});

fmSelectAll?.addEventListener('change', ()=>{
  const rows = Array.from(document.querySelectorAll('.fm-row'));
  const checked = !!fmSelectAll.checked;
  rows.forEach((r)=>{
    if(r.style.display === 'none') return;
    const box = r.querySelector('.fm-item-check');
    if(box) box.checked = checked;
  });
  updateSelectionInfo();
});

document.querySelectorAll('.fm-item-check').forEach((c)=>{
  c.addEventListener('change', updateSelectionInfo);
});

if(!SUPPORTS_FOLDER_PICK && pickFolderBtn){
  pickFolderBtn.setAttribute('disabled', 'disabled');
  pickFolderBtn.classList.add('disabled');
  pickFolderBtn.title = '当前浏览器不支持文件夹选择';
}
if(!SUPPORTS_FOLDER_PICK && fmModeFolder){
  fmModeFolder.setAttribute('disabled', 'disabled');
  fmModeFolder.classList.add('disabled');
  fmModeFolder.title = '当前浏览器不支持文件夹选择';
}
if(fmShareTtlHint){
  fmShareTtlHint.textContent = `范围：${formatDurationLabel(FILE_SHARE_MIN_TTL_SEC)} - ${formatDurationLabel(FILE_SHARE_MAX_TTL_SEC)}`;
}
resetShareTtl();
if(fmShareRevoke) fmShareRevoke.disabled = true;
setShareStatus('', false);

computeTableStats();
applySearchFilter();
initUploadConcurrency();
setModalMode('file');
loadShareHistory();
</script>
{% endblock %}
