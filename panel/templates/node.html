{% extends "base.html" %}
{% block content %}
{% set perms = (request.session.get('user_permissions') if request and request.session else []) or [] %}
{% set policy = (request.session.get('user_policy') if request and request.session else {}) or {} %}
{% if policy is mapping %}
  {% set allowed_tunnels = (policy.get('allowed_tunnel_types') or []) %}
  {% if policy.get('tunnel_limit_enabled') is not none %}
    {% set tunnel_limit_enabled = policy.get('tunnel_limit_enabled') %}
  {% else %}
    {% set tunnel_limit_enabled = 'allowed_tunnel_types' in policy %}
  {% endif %}
{% else %}
  {% set allowed_tunnels = [] %}
  {% set tunnel_limit_enabled = false %}
{% endif %}
{% set can_nodes_write = ('*' in perms) or ('nodes.write' in perms) or ('nodes.*' in perms) %}
{% set can_nodes_delete = ('*' in perms) or ('nodes.delete' in perms) or ('nodes.*' in perms) %}
{% set can_publish = ('*' in perms) or ('publish.apply' in perms) %}
{% set can_backup = ('*' in perms) or ('backup.manage' in perms) %}
{% set can_restore = ('*' in perms) or ('restore.manage' in perms) %}
{% set can_mode_wss_perm = ('*' in perms) or ('sync.wss' in perms) or ('sync.*' in perms) %}
{% set can_mode_intranet_perm = ('*' in perms) or ('sync.intranet' in perms) or ('sync.*' in perms) %}
{% set tunnel_no_limit = not tunnel_limit_enabled %}
{% set can_mode_tcp = can_publish and (tunnel_no_limit or ('direct' in allowed_tunnels) or ('tcp' in allowed_tunnels)) %}
{% set can_mode_wss = can_publish and can_mode_wss_perm and (tunnel_no_limit or ('wss' in allowed_tunnels)) %}
{% set can_mode_intranet = can_publish and can_mode_intranet_perm and (tunnel_no_limit or ('intranet' in allowed_tunnels)) %}
<div id="toast" class="toast"></div>

<div class="split-layout">
  <!-- Left: nodes list -->
  <aside class="card node-sidebar">
    <div class="card-header">
      <div style="min-width:0;">
        <div class="card-title">èŠ‚ç‚¹åˆ—è¡¨</div>
        <div class="card-sub">åˆ‡æ¢æŸ¥çœ‹è¯¥èŠ‚ç‚¹çš„è½¬å‘è§„åˆ™</div>
      </div>
      <div class="right" style="flex:0 0 auto;">
        {% if can_nodes_write %}
        <button class="btn xs" type="button" onclick="openAddNodeModal()">æ¥å…¥èŠ‚ç‚¹</button>
        {% endif %}
      </div>
    </div>
    <div class="node-list">
      {% for g in (node_groups or []) %}
        {% if not loop.first %}<div class="node-group-divider" aria-hidden="true"></div>{% endif %}
        <div class="node-group">
          <div class="node-group-head">
            <div class="node-group-name" role="button" tabindex="0" data-group-name="{{ g.name or 'é»˜è®¤åˆ†ç»„' }}" data-group-order="{{ g.sort_order }}" title="ç‚¹å‡»è®¾ç½®åˆ†ç»„æ’åº Â· å½“å‰ï¼š{{ g.sort_order }}">{{ g.name or 'é»˜è®¤åˆ†ç»„' }}</div>
            <div class="node-group-tools">
              <div class="node-group-count muted sm">{{ g.online }}/{{ g.total }}</div>
              <button class="btn icon xs ghost node-group-toggle" type="button" title="æŠ˜å /å±•å¼€" data-group-toggle="{{ g.name or 'é»˜è®¤åˆ†ç»„' }}">â–¾</button>
            </div>
          </div>
          <div class="node-group-items">
            {% for n in (g.nodes or []) %}
            <div class="node-item-row{% if n.id == node.id %} active{% endif %}"
                 data-node-id="{{ n.id }}"
                 data-node-name="{{ (n.name or '')|e }}"
                 data-node-base-url="{{ (n.base_url or '')|e }}"
                 data-node-group="{{ (n.group_name or 'é»˜è®¤åˆ†ç»„')|e }}"
                 data-node-verify-tls="{{ 1 if n.verify_tls else 0 }}"
                 data-node-is-private="{{ 1 if n.is_private else 0 }}"
                 data-node-role="{{ (n.role or 'normal')|e }}"
                 data-node-website-root="{{ (n.website_root_base or '')|e }}"
                 data-node-ar-enabled="{{ 1 if (n.auto_restart_policy.enabled if n.auto_restart_policy else 1) else 0 }}"
                 data-node-ar-schedule="{{ (n.auto_restart_policy.schedule_type if n.auto_restart_policy else 'daily')|e }}"
                 data-node-ar-interval="{{ (n.auto_restart_policy.interval if n.auto_restart_policy else 1) }}"
                 data-node-ar-hour="{{ (n.auto_restart_policy.hour if n.auto_restart_policy else 4) }}"
                 data-node-ar-minute="{{ (n.auto_restart_policy.minute if n.auto_restart_policy else 8) }}"
                 data-node-ar-weekdays="{{ ((n.auto_restart_policy.weekdays if n.auto_restart_policy else [1,2,3,4,5,6,7])|join(','))|e }}"
                 data-node-ar-monthdays="{{ ((n.auto_restart_policy.monthdays if n.auto_restart_policy else [1])|join(','))|e }}"
                 data-node-display-ip="{{ (n.display_ip or '')|e }}">
              <a class="node-item{% if n.id == node.id %} active{% endif %}" href="/nodes/{{ n.id }}">
                <span class="dot {% if n.online %}online{% else %}offline{% endif %}"></span>
                <div class="node-info">
                  <div class="node-name">{{ n.name or n.display_ip or ('èŠ‚ç‚¹-' ~ n.id) }}</div>
                  <div class="node-meta mono">{{ n.display_ip or '-' }}</div>
                  <div class="muted sm">{{ n.group_name or 'é»˜è®¤åˆ†ç»„' }}</div>
                </div>
              </a>
            </div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
    <div class="sidebar-foot">
      <a class="btn xs ghost w100" href="/">è¿”å›æ§åˆ¶å°</a>
    </div>
  </aside>

  <!-- Right: current node rules -->
  <main class="node-main">
    <section>
      <div class="card">
        <div class="card-header node-head" style="align-items:flex-start;">
          <div class="node-head-left" style="min-width:0;">
            <div class="card-title">
              <span class="node-title">{{ node.name or node.display_ip }}</span>
              <span class="pill xs {% if node.online %}ok{% else %}ghost{% endif %}">{% if node.online %}åœ¨çº¿{% else %}ç¦»çº¿{% endif %}</span>
              <span id="nodeDisplayIp" class="muted sm">Â· {{ node.display_ip or '-' }}</span>
            </div>
            <div class="meta" style="margin-top:6px;">
              {% if node.agent_version %}<span class="meta-item">Agentï¼š{{ node.agent_version }}</span>{% endif %}
              <span class="meta-item">å¿ƒè·³ <span id="nodeLastSeen" class="mono" data-last-seen-mode="full" data-last-seen="{{ node.last_seen_at or '' }}" >{{ node.last_seen_at or "-" }}</span></span>
              <span class="meta-item">åˆ†ç»„ <span id="nodeGroupPill" class="pill xs ghost">{{ node.group_name or 'é»˜è®¤åˆ†ç»„' }}</span></span>
            </div>
            <div class="card-sub" style="margin-top:8px;">æ”¯æŒ TCP/UDP/WSS Â· WSS è‡ªåŠ¨åŒæ­¥ï¼ˆç”Ÿæˆè§„åˆ™é”å®šï¼‰</div>
          </div>
          <div class="right node-tools node-head-right" style="gap:8px; flex:0 0 auto; flex-wrap:nowrap; justify-content:flex-end;">
            <details class="menu toolbar-mini toolbar-mini-search">
              <summary class="btn sm ghost">ğŸ” æœç´¢</summary>
              <div class="menu-pop">
                <div class="toolbar-mini-form">
                  <label class="label">æœç´¢è§„åˆ™</label>
                  <input class="input sm toolbar-mini-search-input" id="ruleSearch" placeholder="ç›‘å¬/ç›®æ ‡/å¤‡æ³¨â€¦ï¼ˆæ”¯æŒ type:wss status:running favï¼‰" oninput="setRuleFilter(this.value)">
                </div>
              </div>
            </details>

            <details class="menu toolbar-mini toolbar-mini-filter" title="å¿«é€Ÿç­›é€‰">
              <summary class="btn sm ghost">â›­ ç­›é€‰</summary>
              <div class="menu-pop">
                <div class="toolbar-mini-form">
                  <label class="label">è§„åˆ™ç­›é€‰</label>
                  <select id="ruleQuickFilter" class="select toolbar-mini-filter-select" onchange="setRuleQuickFilter(this.value)">
                    <option value="">å…¨éƒ¨è§„åˆ™</option>
                    <option value="fav">ä»…æ”¶è— â˜…</option>
                    <option value="running">è¿è¡Œä¸­</option>
                    <option value="disabled">å·²æš‚åœ</option>
                    <option value="tcp">TCP/UDP</option>
                    {% if can_mode_wss %}
                    <option value="wss">WSS éš§é“</option>
                    {% endif %}
                    {% if can_mode_intranet %}
                    <option value="intranet">å†…ç½‘ç©¿é€</option>
                    {% endif %}
                    <option value="lb">è´Ÿè½½å‡è¡¡ï¼ˆå¤šç›®æ ‡ï¼‰</option>
                    <option value="remark">æœ‰å¤‡æ³¨</option>
                  </select>
                </div>
              </div>
            </details>

            <!-- Bulk operations (shown only when any rules are selected) -->
            {% if can_publish %}
            <div id="bulkBar" class="bulk-bar" style="display:none;">
              <span class="pill xs ghost" id="bulkCount">å·²é€‰ 0</span>
              <button class="btn xs ghost" type="button" title="æ‰¹é‡å¯ç”¨" onclick="bulkSetDisabled(false)">â–¶ å¯ç”¨</button>
              <button class="btn xs ghost" type="button" title="æ‰¹é‡æš‚åœ" onclick="bulkSetDisabled(true)">â¸ æš‚åœ</button>
              <button class="btn xs ghost" type="button" title="æ‰¹é‡åˆ é™¤" onclick="bulkDeleteSelected()" style="color:var(--bad);">ğŸ—‘ åˆ é™¤</button>
              <button class="btn xs ghost" type="button" title="æ¸…ç©ºé€‰æ‹©" onclick="clearRuleSelection()">æ¸…ç©º</button>
            </div>
            {% endif %}
            {% if can_publish %}
            <button class="btn sm primary toolbar-main-cta" type="button" onclick="newRule()">+ åˆ›å»ºè½¬å‘</button>
            {% endif %}
            {% if can_nodes_write %}
            <button class="btn sm ghost toolbar-command" type="button" onclick="openCommandModal('ä¸€é”®æ¥å…¥å‘½ä»¤', window.__INSTALL_CMD__)">æ¥å…¥å‘½ä»¤</button>
            {% endif %}
            <details class="menu toolbar-rules">
              <summary class="btn sm ghost">è§„åˆ™å·¥å…· â–¾</summary>
              <div class="menu-pop">
                {% if can_backup %}
                <a class="menu-item" href="/api/nodes/{{ node.id }}/backup">å¤‡ä»½è§„åˆ™ <span class="muted sm">ä¸‹è½½</span></a>
                {% endif %}
                {% if can_restore %}
                <button class="menu-item" type="button" id="restoreRulesBtn" onclick="triggerRestore()">æ¢å¤è§„åˆ™ <span class="muted sm">ç²˜è´´</span></button>
                {% endif %}
                {% if can_publish %}
                <div class="menu-sep"></div>
                <button class="menu-item danger" type="button" onclick="purgeAllRules()">
                  æ¸…ç©ºæ‰€æœ‰è§„åˆ™ <span class="muted sm">å±é™©</span>
                </button>
                {% endif %}
              </div>
            </details>

            <details class="menu toolbar-node">
              <summary class="btn sm ghost">èŠ‚ç‚¹æ“ä½œ â–¾</summary>
              <div class="menu-pop">
                {% if can_nodes_write %}
                <button class="menu-item" type="button" onclick="openEditNodeModal()">ç¼–è¾‘èŠ‚ç‚¹</button>
                {% endif %}
                <button class="menu-item" type="button" onclick="promptTraceRouteTarget()">
                  è·¯ç”±è¿½è¸ª <span class="muted sm">mtr / traceroute</span>
                </button>
                <button class="menu-item" type="button" id="autoRefreshBtn" onclick="toggleAutoRefresh()">è‡ªåŠ¨åˆ·æ–°ï¼šå¼€</button>
                {% if can_nodes_write %}
                <div class="menu-sep"></div>
                <button class="menu-item" type="button" onclick="confirmAndShowUninstallCommand()">
                  å¸è½½ Agent <span class="muted sm">åœæ­¢å—æ§</span>
                </button>
                {% endif %}
                {% if can_publish %}
                <div class="menu-sep"></div>
                <button class="menu-item" type="button" onclick="resetNodeTraffic()">é‡ç½®æµé‡ç»Ÿè®¡ <span class="muted sm">æ¸…é›¶</span></button>
                {% endif %}
                {% if can_nodes_delete %}
                <div class="menu-sep"></div>
                <button class="menu-item danger" type="button" onclick="removeCurrentNode()">
                  ç§»é™¤èŠ‚ç‚¹ <span class="muted sm">å±é™©</span>
                </button>
                {% endif %}
              </div>
            </details>
          </div>
        </div>

        <div id="nodeSummary" class="summary-bar" style="display:none;"></div>

        <div id="autoRestartCard" class="auto-restart-card" style="display:none;">
          <div class="auto-restart-head">
            <div class="auto-restart-title">è‡ªåŠ¨é‡å¯ç­–ç•¥</div>
            <span id="autoRestartBadge" class="pill xs ghost">æœªä¸ŠæŠ¥</span>
          </div>
          <div class="auto-restart-grid">
            <div class="auto-restart-item">
              <div class="k">ä»Šæ—¥è®¡åˆ’</div>
              <div class="v mono" id="autoRestartPlan">â€”</div>
            </div>
            <div class="auto-restart-item">
              <div class="k">åˆ¤å®šä¾æ®</div>
              <div class="v" id="autoRestartReason">â€”</div>
            </div>
            <div class="auto-restart-item">
              <div class="k">å½“å‰è´Ÿè½½</div>
              <div class="v mono" id="autoRestartLoad">â€”</div>
            </div>
            <div class="auto-restart-item">
              <div class="k">æœ€è¿‘æ‰§è¡Œ</div>
              <div class="v" id="autoRestartLast">â€”</div>
            </div>
          </div>
          <div class="auto-restart-foot muted sm" id="autoRestartHint">ç­‰å¾… Agent ä¸ŠæŠ¥</div>
        </div>

        <div id="rulesLoading" class="muted">æ­£åœ¨åŠ è½½è§„åˆ™â€¦</div>

        <!-- Mobile: card list (table is desktop only) -->
        <div id="rulesMobile" class="rules-mobile" style="display:none;"></div>

        <div class="table-wrap">
          <table id="rulesTable" class="table rules-table" style="display:none;">
            <thead>
              <tr>
                <th class="sel">
                  <input type="checkbox" id="rulesSelectAll" title="å…¨é€‰/å–æ¶ˆå…¨é€‰ï¼ˆå½“å‰ç­›é€‰ï¼‰" onclick="toggleSelectAllVisible(this.checked)">
                </th>
                <th>#</th>
                <th>çŠ¶æ€</th>
                <th class="listen">ç›‘å¬</th>
                <th class="health">è¿é€š</th>
                <th class="stat">æ´»è·ƒ</th>
                <th class="stat">æµé‡</th>
                <th class="actions">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="rulesBody"></tbody>
          </table>
        </div>

        <details id="intranetHealthCard" class="hist-panel intranet-health-panel" open style="display:none;">
          <summary class="hist-head">
            <div class="hist-head-left">
              <div class="hist-title">ç©¿é€é“¾è·¯å¥åº·åº¦</div>
              <div class="hist-sub">æ§åˆ¶é€šé“è´¨é‡ Â· ä¸¢åŒ…/å»¶è¿Ÿ/é‡è¿</div>
            </div>
            <div class="hist-head-right muted sm" id="intranetHealthSource">è‡ªåŠ¨åˆ·æ–°æ—¶å®æ—¶æ›´æ–°</div>
          </summary>
          <div class="hist-body">
            <div id="intranetHealthSummary" class="hist-kpis intra-health-summary"></div>
            <div id="intranetHealthList" class="intra-health-list"></div>
          </div>
        </details>



        <!-- Traffic / connections history curves (persistent on panel) -->
        <details id="histPanel" class="hist-panel" open>
          <summary class="hist-head">
            <div class="hist-head-left">
              <div class="hist-title">å†å²æ›²çº¿</div>
              <div class="hist-sub">æµé‡é€Ÿç‡ Â· æ´»è·ƒè¿æ¥</div>
            </div>
            <div class="hist-head-right muted sm" id="histHeadHint">è‡ªåŠ¨åˆ·æ–°æ—¶å®æ—¶æ›´æ–°</div>
          </summary>

          <div class="hist-body">
            <div class="hist-controls">
              <div class="hist-ctrl">
                <label class="label">è§„åˆ™</label>
                <select id="histRuleSelect" class="select">
                  <option value="__all__">å…¨éƒ¨è§„åˆ™ï¼ˆæ±‡æ€»ï¼‰</option>
                </select>
              </div>

              <div class="hist-ctrl" style="max-width:200px;">
                <label class="label">çª—å£</label>
                <select id="histWindowSelect" class="select">
                  <option value="300000">5 åˆ†é’Ÿ</option>
                  <option value="600000" selected>10 åˆ†é’Ÿ</option>
                  <option value="1800000">30 åˆ†é’Ÿ</option>
                  <option value="3600000">60 åˆ†é’Ÿ</option>
                  <option value="86400000">1 å¤©</option>
                  <option value="604800000">7 å¤©</option>
                </select>
              </div>

              <div class="hist-ctrl hist-ctrl-actions">
                <label class="label">&nbsp;</label>
                <div class="row" style="gap:8px; flex-wrap:wrap;">
                  <button class="btn sm ghost" type="button" onclick="clearRuleHistory()">æ¸…ç©ºå†å²</button>
                </div>
              </div>

              <div class="hist-ctrl hist-ctrl-kpi">
                <label class="label">å½“å‰</label>
                <div class="hist-kpis" id="histKpis">
                  <span class="pill xs ghost">â†“ â€”</span>
                  <span class="pill xs ghost">â†‘ â€”</span>
                  <span class="pill xs ghost">æ´»è·ƒ â€”</span>
                </div>
              </div>
            </div>

            <div class="hist-charts">
              <div class="hist-chart" id="histTrafficWrap">
                <div class="hist-chart-head">
                  <div class="name">æµé‡é€Ÿç‡</div>
                  <div class="hint muted sm">â†“ä¸‹è½½ / â†‘ä¸Šä¼ </div>
                </div>
                <canvas id="histTrafficCanvas" class="hist-canvas" aria-label="traffic history"></canvas>
                <div class="hist-legend">
                  <span class="hist-leg"><i class="dot dl"></i> ä¸‹è½½</span>
                  <span class="hist-leg"><i class="dot ul"></i> ä¸Šä¼ </span>
                </div>
                <div class="hist-tooltip" id="histTrafficTip" style="display:none;"></div>
              </div>

              <div class="hist-chart" id="histConnWrap">
                <div class="hist-chart-head">
                  <div class="name">æ´»è·ƒè¿æ¥</div>
                  <div class="hint muted sm">å½“å‰å ç”¨/å¹¶å‘</div>
                </div>
                <canvas id="histConnCanvas" class="hist-canvas small" aria-label="connections history"></canvas>
                <div class="hist-legend">
                  <span class="hist-leg"><i class="dot conn"></i> æ´»è·ƒè¿æ¥</span>
                </div>
                <div class="hist-tooltip" id="histConnTip" style="display:none;"></div>
              </div>
            </div>

            <div id="histNoData" class="muted sm" style="margin-top:8px; display:none;">
              æš‚æ— å†å²æ•°æ®ï¼šé¢æ¿ä¼šåœ¨æ”¶åˆ°èŠ‚ç‚¹ä¸ŠæŠ¥åæŒç»­è®°å½•ã€‚è‹¥èŠ‚ç‚¹åˆšæ¥å…¥ï¼Œè¯·ç¨åå†çœ‹ã€‚
            </div>
          </div>
        </details>

        <div id="statsLoading" class="muted">æ­£åœ¨åŠ è½½æµé‡ç»Ÿè®¡â€¦</div>
      </div>
    </section>
  </main>
</div>

<!-- Add Node Modal (for quick switching / onboarding) -->
<!-- Add Node Modal -->
<div id="addNodeModal" class="modal" style="display:none;">
  <div class="modal-inner" style="max-width:560px;">
    <div class="row" style="align-items:center;">
      <div class="col"><div class="h2">æ¥å…¥èŠ‚ç‚¹</div></div>
      <div class="col right"><button class="btn xs ghost" type="button" onclick="closeAddNodeModal()">å…³é—­</button></div>
    </div>

    <div class="form" style="margin-top:10px;">
      <label class="label">èŠ‚ç‚¹åç§°ï¼ˆå¯é€‰ï¼‰</label>
      <input class="input" id="addNodeName" placeholder="ä¾‹å¦‚ï¼šé¦™æ¸¯-01 / US-Edge">

      <label class="label">IP/åŸŸå</label>
      <input class="input" id="addNodeIp" placeholder="ä¾‹å¦‚ï¼š1.2.3.4 æˆ– https://node.example.com:18700">
      <div class="help">é»˜è®¤æŒ‰ HTTP æ¥å…¥ï¼›è‹¥å¡«å†™ <span class="mono">https://</span> å‰ç¼€ä¼šè‡ªåŠ¨åˆ‡æ¢ HTTPSã€‚</div>

      <details class="advanced-details">
        <summary>
          <div class="adv-summary-left">
            <div class="adv-title">é«˜çº§é€‰é¡¹</div>
            <div class="adv-hint">åˆ†ç»„ / èŠ‚ç‚¹è§’è‰²ï¼ˆå¯é€‰ï¼‰</div>
          </div>
          <div class="adv-summary-right">
            <span class="pill xs ghost">å¯é€‰</span>
          </div>
        </summary>
        <div class="adv-body">
          <label class="label">åˆ†ç»„åç§°</label>
          <input class="input" id="addNodeGroup" placeholder="ä¾‹å¦‚ï¼šé¦™æ¸¯ / ç¾å›½ / å®¢æˆ·A" value="é»˜è®¤åˆ†ç»„">
          <div class="help">ä»…ç”¨äºé¢æ¿åˆ†ç±»ï¼›ä¸å½±å“è§„åˆ™ä¸è½¬å‘ã€‚</div>

          <div class="row" style="gap:12px;align-items:center;">
            <div class="col">
              <label class="help"><input type="checkbox" id="addNodeIsPrivate" style="transform:translateY(1px);"> å†…ç½‘æœºå™¨ï¼ˆç”¨äºå†…ç½‘ç©¿é€å‡ºå£ï¼‰</label>
            </div>
          </div>
        </div>
      </details>

      <div id="addNodeError" class="muted" style="margin-top:8px;color:var(--bad);"></div>

      <div class="row" style="gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn xs ghost" type="button" onclick="closeAddNodeModal()">å–æ¶ˆ</button>
        <button class="btn xs" id="addNodeSubmit" type="button" onclick="createNodeFromModal()">åˆ›å»ºå¹¶è¿›å…¥</button>
      </div>
    </div>
  </div>
</div>


<!-- Edit Node Modal -->
<div id="editNodeModal" class="modal" style="display:none;">
  <div class="modal-inner" style="max-width:560px;">
    <div class="row" style="align-items:center;">
      <div class="col"><div class="h2">ç¼–è¾‘èŠ‚ç‚¹</div></div>
      <div class="col right"><button class="btn xs ghost" type="button" onclick="closeEditNodeModal()">å…³é—­</button></div>
    </div>

    <div class="form" style="margin-top:10px;">
      <label class="label">èŠ‚ç‚¹åç§°</label>
      <input class="input" id="editNodeName" placeholder="ä¾‹å¦‚ï¼šé¦™æ¸¯-01 / US-Edge">

      <div class="row" style="gap:12px; margin-top:10px;">
        <div class="col" style="max-width:180px;">
          <label class="label">åè®®</label>
          <select class="select" id="editNodeScheme">
            <option value="http">http</option>
            <option value="https">https</option>
          </select>
        </div>
        <div class="col">
          <label class="label">åˆ†ç»„åç§°</label>
          <input class="input" id="editNodeGroup" placeholder="ä¾‹å¦‚ï¼šé¦™æ¸¯ / ç¾å›½ / å®¢æˆ·A">
        </div>
      </div>

      <label class="label" style="margin-top:10px;">IP/åŸŸå</label>
      <input class="input" id="editNodeIp" placeholder="ä¾‹å¦‚ï¼š1.2.3.4 æˆ– node.example.com">
      <div class="help">ç«¯å£æ— éœ€å•ç‹¬å¡«å†™ï¼Œé»˜è®¤ 18700ï¼›å¦‚éœ€è‡ªå®šä¹‰å¯åœ¨åœ°å€ä¸­å†™ host:portï¼ˆä¿å­˜åä»ä¸åœ¨åˆ—è¡¨å±•ç¤ºç«¯å£ï¼‰ã€‚</div>

      <div class="row" style="gap:12px;align-items:center;margin-top:6px;">
        <div class="col">
          <label class="help"><input type="checkbox" id="editNodeVerifyTls" style="transform:translateY(1px);"> éªŒè¯ TLS è¯ä¹¦ï¼ˆhttps æ‰éœ€è¦ï¼‰</label>
        </div>
        <div class="col">
          <label class="help"><input type="checkbox" id="editNodeIsPrivate" style="transform:translateY(1px);"> å†…ç½‘æœºå™¨ï¼ˆç”¨äºå†…ç½‘ç©¿é€å‡ºå£ï¼‰</label>
        </div>
        <div class="col">
          <label class="help"><input type="checkbox" id="editNodeIsWebsite" style="transform:translateY(1px);"> ç½‘ç«™æœºï¼ˆå¯ç®¡ç†ç«™ç‚¹/SSL/æ–‡ä»¶ï¼‰</label>
        </div>
      </div>

      <label class="label" style="margin-top:8px;">ç½‘ç«™æ ¹ç›®å½•</label>
      <input class="input" id="editNodeWebsiteRoot" placeholder="/www">
      <div class="help">ä»…å¯¹ç½‘ç«™æœºç”Ÿæ•ˆï¼Œç”¨äºæ–‡ä»¶ç®¡ç†æ ¹ç›®å½•é™åˆ¶ã€‚</div>

      <details class="advanced-details" style="margin-top:10px;" open>
        <summary>
          <div class="adv-summary-left">
            <div class="adv-title">è‡ªåŠ¨é‡å¯ç­–ç•¥</div>
            <div class="adv-hint">æŒ‰èŠ‚ç‚¹ç‹¬ç«‹è®¾ç½®ï¼ˆæ¯æ—¥/æ¯å‘¨/æ¯æœˆï¼‰</div>
          </div>
          <div class="adv-summary-right">
            <span class="pill xs ghost">å¯é€‰</span>
          </div>
        </summary>
        <div class="adv-body">
          <label class="help"><input type="checkbox" id="editNodeAutoRestartEnabled" style="transform:translateY(1px);"> å¯ç”¨è‡ªåŠ¨é‡å¯</label>

          <div class="row" style="gap:12px; margin-top:8px;">
            <div class="col" style="max-width:160px;">
              <label class="label">å‘¨æœŸ</label>
              <select class="select" id="editNodeAutoRestartSchedule" onchange="toggleAutoRestartEditor()">
                <option value="daily">æ¯å¤©</option>
                <option value="weekly">æ¯å‘¨</option>
                <option value="monthly">æ¯æœˆ</option>
              </select>
            </div>
            <div class="col" style="max-width:130px;">
              <label class="label">é—´éš”</label>
              <input class="input" id="editNodeAutoRestartInterval" type="number" min="1" max="365" value="1" placeholder="1">
              <div class="help">æ¯ N ä¸ªå‘¨æœŸ</div>
            </div>
            <div class="col" style="max-width:160px;">
              <label class="label">æ—¶é—´</label>
              <input class="input" id="editNodeAutoRestartTime" type="time" value="04:08">
            </div>
          </div>

          <div id="editNodeAutoRestartWeeklyBox" style="margin-top:8px; display:none;">
            <label class="label">æ¯å‘¨å‡ æ‰§è¡Œ</label>
            <div class="row" style="gap:8px;flex-wrap:wrap;">
              <label class="help"><input type="checkbox" data-ar-weekday="1"> å‘¨ä¸€</label>
              <label class="help"><input type="checkbox" data-ar-weekday="2"> å‘¨äºŒ</label>
              <label class="help"><input type="checkbox" data-ar-weekday="3"> å‘¨ä¸‰</label>
              <label class="help"><input type="checkbox" data-ar-weekday="4"> å‘¨å››</label>
              <label class="help"><input type="checkbox" data-ar-weekday="5"> å‘¨äº”</label>
              <label class="help"><input type="checkbox" data-ar-weekday="6"> å‘¨å…­</label>
              <label class="help"><input type="checkbox" data-ar-weekday="7"> å‘¨æ—¥</label>
            </div>
          </div>

          <div id="editNodeAutoRestartMonthlyBox" style="margin-top:8px; display:none;">
            <label class="label">æ¯æœˆæ—¥æœŸ</label>
            <input class="input" id="editNodeAutoRestartMonthdays" placeholder="ä¾‹å¦‚ï¼š1,15,28">
            <div class="help">æ”¯æŒå¤šä¸ªæ—¥æœŸï¼ˆ1-31ï¼Œé€—å·åˆ†éš”ï¼‰</div>
          </div>
        </div>
      </details>

      <div id="editNodeError" class="muted" style="margin-top:8px;color:var(--bad);"></div>

      <div class="row" style="gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn xs ghost" type="button" onclick="closeEditNodeModal()">å–æ¶ˆ</button>
        <button class="btn xs" id="editNodeSubmit" type="button" onclick="saveEditNode()">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div id="modal" class="modal" style="display:none;">
  <div class="modal-inner">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div class="col"><div class="h2" id="modalTitle">ç¼–è¾‘è§„åˆ™</div></div>
      <div class="right"><button class="btn xs ghost" type="button" onclick="closeModal()">å…³é—­</button></div>
    </div>

    <div class="form">
	      <!-- ä¿ç•™åŸ selectï¼ˆJS/æ¥å£ä¾èµ– #f_typeï¼‰ï¼Œä»…éšè—ä¸å±•ç¤º -->
	      <select class="select" id="f_type" style="display:none;">
	        <option value="tcp">TCP/UDP</option>
	        {% if can_mode_wss %}
	        <option value="wss">WSS éš§é“</option>
	        {% endif %}
	        {% if can_mode_intranet %}
	        <option value="intranet">å†…ç½‘ç©¿é€</option>
	        {% endif %}
	      </select>

	      <!-- æ¨¡å¼å¡ç‰‡ï¼šç›´æ¥æ”¾åœ¨å‚æ•°é¡µé¡¶éƒ¨ï¼ˆå–æ¶ˆç‹¬ç«‹ä»‹ç»é¡µï¼‰ -->
	      <div class="mode-strip">
	        <div class="mode-switch" id="modeSwitch" role="tablist" aria-label="è½¬å‘æ¨¡å¼é€‰æ‹©">
	          <button class="mode-card active" type="button" data-mode="tcp" role="tab" aria-selected="true">
	            <div class="mode-card-head">
	              <div class="mode-ico">âš¡</div>
	              <div class="mode-card-txt">
	                <div class="mode-title">æ™®é€šè½¬å‘</div>
	                <div class="mode-sub">å•æœºç›‘å¬ â†’ ç›®æ ‡</div>
	              </div>
	            </div>
	            <div class="mode-tags">
	              <span class="mode-tag">æœ€å¸¸ç”¨</span>
	              <span class="mode-tag">å•èŠ‚ç‚¹</span>
	            </div>
	          </button>

	          {% if can_mode_wss %}
	          <button class="mode-card" type="button" data-mode="wss" role="tab" aria-selected="false">
	            <div class="mode-card-head">
	              <div class="mode-ico">ğŸ›¡ï¸</div>
	              <div class="mode-card-txt">
	                <div class="mode-title">WSS éš§é“</div>
	                <div class="mode-sub">å‘é€æœº â†” æ¥æ”¶æœºï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰</div>
	              </div>
	            </div>
	            <div class="mode-tags">
	              <span class="mode-tag">ä¼ªè£…</span>
	              <span class="mode-tag">åŒç«¯</span>
	            </div>
	          </button>
	          {% endif %}

	          {% if can_mode_intranet %}
	          <button class="mode-card" type="button" data-mode="intranet" role="tab" aria-selected="false">
	            <div class="mode-card-head">
	              <div class="mode-ico">ğŸ </div>
	              <div class="mode-card-txt">
	                <div class="mode-title">å†…ç½‘ç©¿é€</div>
	                <div class="mode-sub">å…¬ç½‘å…¥å£ â†” å†…ç½‘å‡ºå£ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰</div>
	              </div>
	            </div>
	            <div class="mode-tags">
	              <span class="mode-tag">æš´éœ²å†…ç½‘</span>
	              <span class="mode-tag">åŒç«¯</span>
	            </div>
	          </button>
	          {% endif %}
	        </div>
	      </div>

	      <div class="form-section">
	        <div class="section-head">
	          <div style="min-width:0;">
	            <div class="section-title">åŸºç¡€å‚æ•°</div>
	            <div class="section-sub muted sm">ç«¯å£ + ç›®æ ‡ï¼›æ›´å¤šé€‰é¡¹åœ¨ã€Œé«˜çº§å‚æ•°ã€ã€‚</div>
	          </div>
	        </div>

	        <div class="row base-top-row" style="gap:12px;">
	          <div class="col listen-col">
	            <label class="label" id="listenLabel">
	              <span id="listenLabelMain">ç›‘å¬ç«¯å£</span> <span class="muted sm" id="listenLabelExample">ï¼ˆä¾‹å¦‚ 443ï¼‰</span>
	            </label>
	
	            <div class="input-group">
	              <span class="input-prefix mono" id="listenHostPrefix">0.0.0.0:</span>
	              <input class="input" id="f_listen_port" placeholder="443" inputmode="numeric" pattern="\d*">
	            </div>
	            <!-- hidden full listen (ip:port), filled by JS -->
	            <input id="f_listen" type="hidden" value="">
	          </div>

        <div class="col status-col" id="statusCol" style="max-width:220px;">
	            <label class="label">çŠ¶æ€</label>
	            <select class="select" id="f_disabled">
	              <option value="0">å¯ç”¨</option>
	              <option value="1">æš‚åœ</option>
	            </select>
	          </div>

          <!-- Normal forwarding tool (basic params for tcp mode) -->
          <div class="col" id="forwardToolBox" style="max-width:240px; display:none;">
            <label class="label">æ™®é€šè½¬å‘å·¥å…·</label>
            <select class="select" id="f_forward_tool">
              <option value="iptables">iptablesï¼ˆé»˜è®¤ï¼‰</option>
              <option value="realm">realm</option>
            </select>
            <div class="help">ä»…æ™®é€šè½¬å‘ç”Ÿæ•ˆï¼›WSS/å†…ç½‘ç©¿é€ä¸ä½¿ç”¨è¯¥é€‰é¡¹ã€‚</div>
          </div>

	          <!-- WSS: æ¥æ”¶æœºèŠ‚ç‚¹ -->
	          <div class="col peer-col" id="wssBox" style="display:none;">
	            <label class="label">æ¥æ”¶æœºèŠ‚ç‚¹ <span class="muted sm">ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰</span></label>
	            <select class="select" id="f_wss_receiver_node">
	              <option value="">ï¼ˆä¸é€‰æ‹©=æ‰‹åŠ¨é…å¯¹ç æ¨¡å¼ï¼‰</option>
	            </select>
	          </div>

	          <!-- Intranet: å†…ç½‘å‡ºå£èŠ‚ç‚¹ -->
	          <div class="col peer-col" id="intranetBox" style="display:none;">
	            <label class="label">å†…ç½‘å‡ºå£èŠ‚ç‚¹ <span class="muted sm">ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰</span></label>
	            <select class="select" id="f_intranet_receiver_node">
	              <option value="">è¯·é€‰æ‹©å†…ç½‘èŠ‚ç‚¹â€¦</option>
	            </select>
	          </div>
	        </div>

	        <div class="help compact" id="baseHelp"></div>

		        <label class="label" id="remoteLabel">
		          <span id="remoteLabelMain">ç›®æ ‡åœ°å€</span> <span class="muted sm" id="remoteLabelExtra">ï¼ˆRemoteï¼Œæ¯è¡Œä¸€ä¸ª host:portï¼‰</span>
		        </label>
		        <textarea class="textarea" id="f_remotes" rows="4" placeholder="203.0.113.10:443\n198.51.100.8:443"></textarea>
		        <div class="help" id="remoteHelp"></div>

		        <div class="row" style="gap:12px; align-items:flex-end;">
		          <div class="col" style="max-width:360px;">
		            <label class="label">è‡ªé€‚åº”è´Ÿè½½å‡è¡¡</label>
		            <label class="help" style="margin:0;">
		              <input type="checkbox" id="f_adaptive_lb" checked style="transform:translateY(1px);">
		              å¯ç”¨ï¼ˆæŒ‰å»¶è¿Ÿ/é”™è¯¯ç‡/å¯ç”¨æ€§è‡ªåŠ¨è°ƒæƒï¼‰
		            </label>
		            <div class="help">ä»…å¤šç›®æ ‡è½¬å‘ç”Ÿæ•ˆï¼›å…³é—­åä¿æŒæ‰‹åŠ¨ç­–ç•¥/æƒé‡ã€‚</div>
		          </div>
		        </div>

		        <div class="row" style="gap:12px; align-items:flex-end;">
		          <div class="col">
		            <label class="label">å¤‡æ³¨ <span class="muted sm">ï¼ˆå¯é€‰ï¼Œç”¨äºæœç´¢/ç­›é€‰ï¼‰</span></label>
		            <input class="input" id="f_remark" placeholder="ä¾‹å¦‚ï¼šå®¢æˆ·A / ä¸´æ—¶æµ‹è¯• / èµ°CF">
	          </div>
	          <div class="col" style="max-width:220px;">
	            <label class="help" style="margin:0;">
	              <input type="checkbox" id="f_favorite" style="transform:translateY(1px);">
	              æ”¶è—ï¼ˆâ˜…ï¼‰
	            </label>
	          </div>
	        </div>

          <div id="qosBox" style="margin-top:14px;">
            <div class="adv-subtitle">QoSï¼ˆç«¯å£é˜²æŠ¤ï¼Œå¯é€‰ï¼‰</div>
            <div class="adv-grid" style="margin-top:6px;">
              <div class="col" style="max-width:240px;">
                <label class="label">å¸¦å®½ä¸Šé™ï¼ˆMbpsï¼‰</label>
                <input class="input" id="f_qos_bandwidth_mbps" type="number" step="1" placeholder="ä¾‹å¦‚ 100">
                <div class="help">é™åˆ¶è¯¥ç›‘å¬ç«¯å£æ€»å¸¦å®½ï¼›ç•™ç©º=ä¸é™åˆ¶ã€‚</div>
              </div>
              <div class="col" style="max-width:240px;">
                <label class="label">æœ€å¤§å¹¶å‘è¿æ¥</label>
                <input class="input" id="f_qos_max_conns" type="number" step="1" placeholder="ä¾‹å¦‚ 2000">
                <div class="help">è¶…è¿‡é˜ˆå€¼çš„æ–° TCP è¿æ¥ä¼šè¢«æ‹’ç»ã€‚</div>
              </div>
              <div class="col" style="max-width:260px;">
                <label class="label">æ¯ç§’æ–°å»ºè¿æ¥ä¸Šé™</label>
                <input class="input" id="f_qos_conn_rate" type="number" step="1" placeholder="ä¾‹å¦‚ 300">
                <div class="help">é™åˆ¶æ–°å»ºè¿æ¥é€Ÿç‡ï¼ˆæ¯ç§’ï¼‰ã€‚</div>
              </div>
              <div class="col" style="max-width:260px;">
                <label class="label">æ€»æµé‡ä¸Šé™ï¼ˆGBï¼‰</label>
                <input class="input" id="f_qos_traffic_total_gb" type="number" step="1" placeholder="ä¾‹å¦‚ 500">
                <div class="help">è¾¾åˆ°ä¸Šé™åå°†é˜»æ–­è¯¥ç«¯å£æ–°æµé‡ï¼›ç•™ç©º=ä¸é™åˆ¶ã€‚</div>
              </div>
            </div>
          </div>
	      </div>

	      <details class="advanced-details" id="advancedDetails">
                <summary>
                  <div class="adv-summary-left">
                    <div class="adv-title">é«˜çº§å‚æ•°</div>
                    <div class="adv-hint">ç›‘å¬ IP / åè®® / è´Ÿè½½å‡è¡¡ / éš§é“å‚æ•°</div>
                  </div>
                  <div class="adv-summary-right">
                    <span class="pill xs ghost">å¯é€‰</span>
                  </div>
                </summary>

                <div class="adv-body">
                  <div class="adv-grid">
                    <div class="col">
                      <label class="label">ç›‘å¬ IPï¼ˆé»˜è®¤ 0.0.0.0ï¼‰</label>
                      <input class="input" id="f_listen_host" placeholder="0.0.0.0">
                      <div class="help">æ”¹ä¸º 127.0.0.1 å¯ä»…æœ¬æœºè®¿é—®ï¼›æˆ–å¡«æŒ‡å®šç½‘å¡ IP ä»…ç›‘å¬è¯¥åœ°å€ã€‚</div>
                    </div>

                    <div class="col" style="max-width:240px;">
                      <label class="label">åè®®</label>
                      <select class="select" id="f_protocol">
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                        <option value="tcp+udp">TCP+UDP</option>
                      </select>
                    </div>

                    <div class="col" style="max-width:240px;">
                      <label class="label">ç­–ç•¥</label>
                      <select class="select" id="f_balance">
                        <option value="roundrobin">è½®è¯¢</option>
                        <option value="iphash">IP Hash</option>
                      </select>
                      <div class="help">å¤šç›®æ ‡æ—¶ç”Ÿæ•ˆï¼šè½®è¯¢ / æŒ‰æ¥æº IP å›ºå®šè½ç‚¹ã€‚</div>
                    </div>

                    <div class="col">
                      <label class="label">æƒé‡ï¼ˆä¸ Remote è¡Œæ•°ä¸€è‡´ï¼Œé€—å·åˆ†éš”ï¼Œå¯ç©ºï¼‰</label>
                      <input class="input" id="f_weights" placeholder="1,1,2">
                      <div class="help">ä»…è½®è¯¢ç”Ÿæ•ˆï¼›IP Hash ä¼šå¿½ç•¥æƒé‡ã€‚æƒé‡æ•°é‡å¿…é¡»ä¸ Remote è¡Œæ•°ä¸€è‡´ã€‚</div>
                    </div>

	                  </div>

                  <!-- Common advanced params (normal rules only) -->
                  <div id="commonAdvancedBox" style="display:none;">
                    <div class="adv-subtitle">ç»‘å®š / è·¯ç”±</div>
                    <div class="adv-grid" style="margin-top:6px;">
                      <div class="col">
                        <label class="label">Throughï¼ˆå‡ºç«™ç»‘å®š IPï¼Œå¯é€‰ï¼‰</label>
                        <input class="input" id="f_through" placeholder="ä¾‹å¦‚ï¼š1.2.3.4 æˆ– [2001:db8::1] æˆ– 1.2.3.4:50000(UDP)">
                        <div class="help">TCPï¼šå‡ºç«™è¿æ¥å‰ç»‘å®šæŒ‡å®š IPï¼›UDPï¼šæ”¯æŒ ip æˆ– ip:portã€‚</div>
                      </div>
                      <div class="col">
                        <label class="label">Interfaceï¼ˆå‡ºç«™æ¥å£ï¼Œå¯é€‰ï¼‰</label>
                        <input class="input" id="f_interface" placeholder="ä¾‹å¦‚ï¼šeth0">
                        <div class="help">å°†å‡ºç«™æµé‡ç»‘å®šåˆ°æŒ‡å®šç½‘å¡ã€‚</div>
                      </div>
                      <div class="col">
                        <label class="label">Listen Interfaceï¼ˆå…¥ç«™æ¥å£ï¼Œå¯é€‰ï¼‰</label>
                        <input class="input" id="f_listen_interface" placeholder="ä¾‹å¦‚ï¼šeth0">
                        <div class="help">ä»…ç›‘å¬æŒ‡å®šç½‘å¡çš„å…¥ç«™è¿æ¥ï¼ˆå¤šç½‘å¡åœºæ™¯ä½¿ç”¨ï¼‰ã€‚</div>
                      </div>
                    </div>

                    <div class="adv-subtitle">Networkï¼ˆè¦†ç›–å…¨å±€ï¼Œå¯é€‰ï¼‰</div>
                    <div class="adv-grid" style="margin-top:6px;">
                      <div class="col" style="max-width:240px;">
                        <label class="label">TCP è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰</label>
                        <input class="input" id="f_net_tcp_timeout" type="number" step="1" placeholder="é»˜è®¤ 5ï¼›0=å…³é—­">
                        <div class="help">è¿æ¥è¿œç«¯çš„è¶…æ—¶ï¼›ç•™ç©º=ç»§æ‰¿å…¨å±€ã€‚</div>
                      </div>
                      <div class="col" style="max-width:240px;">
                        <label class="label">UDP å…³è”è¶…æ—¶ï¼ˆç§’ï¼‰</label>
                        <input class="input" id="f_net_udp_timeout" type="number" step="1" placeholder="é»˜è®¤ 30">
                        <div class="help">UDP ä¼šè¯ç©ºé—²è¶…æ—¶ï¼›ç•™ç©º=ç»§æ‰¿å…¨å±€ã€‚</div>
                      </div>
                      <div class="col" style="max-width:240px;">
                        <label class="label">TCP Keepaliveï¼ˆç§’ï¼‰</label>
                        <input class="input" id="f_net_tcp_keepalive" type="number" step="1" placeholder="é»˜è®¤ 15ï¼›0=ç³»ç»Ÿé»˜è®¤">
                        <div class="help">ç•™ç©º=ç»§æ‰¿å…¨å±€ã€‚</div>
                      </div>
                      <div class="col" style="max-width:240px;">
                        <label class="label">Keepalive é‡è¯•æ¬¡æ•°</label>
                        <input class="input" id="f_net_tcp_keepalive_probe" type="number" step="1" placeholder="é»˜è®¤ 3">
                        <div class="help">ç•™ç©º=ç»§æ‰¿å…¨å±€ã€‚</div>
                      </div>
                      <div class="col" style="max-width:240px;">
                        <label class="label">IPv6 Onlyï¼ˆå¯é€‰ï¼‰</label>
                        <select class="select" id="f_net_ipv6_only">
                          <option value="">ç»§æ‰¿å…¨å±€</option>
                          <option value="1">å¼€å¯</option>
                          <option value="0">å…³é—­</option>
                        </select>
                        <div class="help">ç¦ç”¨ ipv4-mapped-ipv6ï¼ˆä»…åœ¨ç›‘å¬ IPv6 æ—¶ç”Ÿæ•ˆï¼‰ã€‚</div>
                      </div>
                    </div>

                    <div class="adv-subtitle">PROXY Protocolï¼ˆå¯é€‰ï¼‰</div>
                    <div class="adv-grid" style="margin-top:6px;">
                      <div class="col" style="max-width:240px;">
                        <label class="label">å…¥ç«™è§£æ PROXY</label>
                        <select class="select" id="f_accept_proxy">
                          <option value="">ç»§æ‰¿å…¨å±€</option>
                          <option value="1">å¼€å¯</option>
                          <option value="0">å…³é—­</option>
                        </select>
                      </div>
                      <div class="col" style="max-width:240px;">
                        <label class="label">è§£æè¶…æ—¶ï¼ˆç§’ï¼‰</label>
                        <input class="input" id="f_accept_proxy_timeout" type="number" step="1" placeholder="é»˜è®¤ 5">
                        <div class="help">ä»…åœ¨å…¥ç«™è§£æ PROXY æ—¶ç”Ÿæ•ˆï¼›ç•™ç©º=ç»§æ‰¿å…¨å±€ã€‚</div>
                      </div>
                      <div class="col" style="max-width:240px;">
                        <label class="label">å‡ºç«™å‘é€ PROXY</label>
                        <select class="select" id="f_send_proxy">
                          <option value="">ç»§æ‰¿å…¨å±€</option>
                          <option value="1">å¼€å¯</option>
                          <option value="0">å…³é—­</option>
                        </select>
                      </div>
                      <div class="col" style="max-width:240px;">
                        <label class="label">PROXY ç‰ˆæœ¬</label>
                        <select class="select" id="f_send_proxy_version">
                          <option value="">ç»§æ‰¿å…¨å±€</option>
                          <option value="2">v2ï¼ˆé»˜è®¤ï¼‰</option>
                          <option value="1">v1</option>
                        </select>
                        <div class="help">ä»…åœ¨å‡ºç«™å‘é€ PROXY æ—¶ç”Ÿæ•ˆã€‚</div>
                      </div>
                    </div>

                    <div class="adv-subtitle">MPTCPï¼ˆLinuxï¼Œå¯é€‰ï¼‰</div>
                    <div class="adv-grid" style="margin-top:6px;">
                      <div class="col" style="max-width:240px;">
                        <label class="label">å‡ºç«™ MPTCP</label>
                        <select class="select" id="f_send_mptcp">
                          <option value="">ç»§æ‰¿å…¨å±€</option>
                          <option value="1">å¼€å¯</option>
                          <option value="0">å…³é—­</option>
                        </select>
                      </div>
                      <div class="col" style="max-width:240px;">
                        <label class="label">å…¥ç«™ MPTCP</label>
                        <select class="select" id="f_accept_mptcp">
                          <option value="">ç»§æ‰¿å…¨å±€</option>
                          <option value="1">å¼€å¯</option>
                          <option value="0">å…³é—­</option>
                        </select>
                      </div>
                    </div>

                    <div class="adv-subtitle">Transportï¼ˆå¯é€‰ï¼‰</div>
                    <div class="adv-grid" style="margin-top:6px;">
                      <div class="col">
                        <label class="label">Listen Transport</label>
                        <input class="input" id="f_listen_transport" placeholder='ä¾‹å¦‚ï¼šws;host=example.com;path=/;tls;servername=example.com'>
                        <div class="help">é«˜çº§ç”¨æ³•ï¼šéœ€è¦ realm transport åŠŸèƒ½ï¼›ç•™ç©º=ä¸ä½¿ç”¨ã€‚</div>
                      </div>
                      <div class="col">
                        <label class="label">Remote Transport</label>
                        <input class="input" id="f_remote_transport" placeholder='ä¾‹å¦‚ï¼šws;host=example.com;path=/;tls;sni=example.com;insecure'>
                        <div class="help">é«˜çº§ç”¨æ³•ï¼šéœ€è¦ realm transport åŠŸèƒ½ï¼›ç•™ç©º=ä¸ä½¿ç”¨ã€‚</div>
                      </div>
                    </div>
                  </div>

                  <div id="wssAdvancedBox" style="display:none;">
                    <div class="adv-subtitle">WSS éš§é“å‚æ•°</div>

                    <div class="row" style="gap:12px;margin-top:6px;align-items:flex-end;">
                      <div class="col" style="max-width:260px;">
                        <label class="label">æ¥æ”¶æœºç›‘å¬ç«¯å£</label>
                        <input class="input" id="f_wss_receiver_port" placeholder="ç•™ç©º = ä¸å‘é€æœºç«¯å£ä¸€è‡´">
                        <div class="help">ç•™ç©º=æ²¿ç”¨å‘é€æœºç«¯å£ï¼›å¦‚å†²çªè‡ªåŠ¨é¿è®©ã€‚</div>
                      </div>
                      <div class="col right" style="flex:0 0 auto;">
                        <button class="btn xs ghost" type="button" onclick="randomizeWss()">éšæœºç”Ÿæˆå‚æ•°</button>
                      </div>
                    </div>

                    <div class="row" style="gap:12px;margin-top:10px;">
                      <div class="col">
                        <label class="label">WSS Host <span class="muted sm">ï¼ˆç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰</span></label>
                        <input class="input" id="f_wss_host" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼Œä¾‹å¦‚ cdn.jsdelivr.net">
                      </div>
                      <div class="col">
                        <label class="label">WSS Path <span class="muted sm">ï¼ˆç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰</span></label>
                        <input class="input" id="f_wss_path" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼Œä¾‹å¦‚ /ws/xxxx">
                      </div>
                    </div>

                    <div class="row" style="gap:12px;">
                      <div class="col">
                        <label class="label">SNI <span class="muted sm">ï¼ˆç•™ç©º=åŒ Hostï¼‰</span></label>
                        <input class="input" id="f_wss_sni" placeholder="ç•™ç©º=åŒ Hostï¼Œä¾‹å¦‚ cdn.jsdelivr.net">
                      </div>
                      <div class="col" style="max-width:220px;">
                        <label class="label">TLS</label>
                        <select class="select" id="f_wss_tls">
                          <option value="1">å¯ç”¨</option>
                          <option value="0">å…³é—­</option>
                        </select>
                      </div>
                      <div class="col" style="max-width:220px;">
                        <label class="label" style="display:flex;align-items:center;gap:8px;">
                          <input type="checkbox" id="f_wss_insecure" checked style="width:auto;margin:0;">
                          è·³è¿‡è¯ä¹¦æ ¡éªŒ
                        </label>
                        <div class="help">å…¼å®¹æ€§æ›´å¥½ï¼Œä½†å®‰å…¨æ€§é™ä½ã€‚</div>
                      </div>
                    </div>

                    <div class="help" style="margin-top:6px;">Host/Path/SNI å»ºè®®ä¸è¯ä¹¦åŸŸåä¸€è‡´ï¼›ç•™ç©ºä¼šåœ¨ä¿å­˜æ—¶è‡ªåŠ¨éšæœºç”Ÿæˆã€‚</div>
                  </div>

                  <div id="intranetAdvancedBox" style="display:none;">
                    <div class="adv-subtitle">å†…ç½‘ç©¿é€å‚æ•°</div>

                    <div class="row" style="gap:12px;margin-top:6px;">
                      <div class="col" style="max-width:260px;">
                        <label class="label">éš§é“æœåŠ¡ç«¯ç«¯å£ï¼ˆAï¼‰</label>
                        <input class="input" id="f_intranet_server_port" placeholder="18443" value="18443">
                        <div class="help">ç”¨äº B â†’ A çš„åŠ å¯†éš§é“è¿æ¥ã€‚è¯·åœ¨ A æ”¾è¡Œè¯¥ç«¯å£ã€‚</div>
                      </div>
                      <div class="col">
                        <label class="label">å…¬ç½‘å…¥å£åœ°å€ï¼ˆAï¼Œå¯é€‰ï¼‰</label>
                        <input class="input" id="f_intranet_server_host" placeholder="é»˜è®¤=ä½¿ç”¨å½“å‰èŠ‚ç‚¹ base_url çš„ä¸»æœºåï¼ˆå»ºè®®å¡«å…¬ç½‘ IP/åŸŸåï¼‰">
                        <div class="help">å½“é¢æ¿ç®¡ç† A ä½¿ç”¨çš„æ˜¯å†…ç½‘åœ°å€æ—¶ï¼ŒB å¯èƒ½æ— æ³•ç›´è¿ã€‚è¿™é‡Œå¯å¡«å†™ B å¯è®¿é—®çš„å…¬ç½‘ IP/åŸŸåï¼ˆä¸å«åè®®ï¼‰ã€‚</div>
                      </div>
                    </div>

                    <div class="help" style="margin-top:6px;">æç¤ºï¼šRemote å†™ B å†…ç½‘å¯è¾¾åœ°å€ï¼ˆå¦‚ 192.168.x.x:portï¼‰ã€‚</div>

                    <div class="adv-subtitle" style="margin-top:12px;">è®¿é—® ACLï¼ˆå¯é€‰ï¼‰</div>
                    <div class="row" style="gap:12px;margin-top:6px;">
                      <div class="col">
                        <label class="label">å…è®¸æ¥æº IP/CIDR</label>
                        <textarea class="textarea" id="f_intranet_acl_allow_sources" rows="3" placeholder="æ¯è¡Œä¸€ä¸ªï¼Œä¾‹å¦‚&#10;203.0.113.10&#10;10.0.0.0/8"></textarea>
                      </div>
                      <div class="col">
                        <label class="label">æ‹’ç»æ¥æº IP/CIDR</label>
                        <textarea class="textarea" id="f_intranet_acl_deny_sources" rows="3" placeholder="æ¯è¡Œä¸€ä¸ªï¼Œä¾‹å¦‚&#10;0.0.0.0/0"></textarea>
                      </div>
                    </div>
                    <div class="row" style="gap:12px;">
                      <div class="col">
                        <label class="label">å…è®¸æ—¶é—´çª—</label>
                        <textarea class="textarea" id="f_intranet_acl_allow_hours" rows="2" placeholder="æ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ HH:MM-HH:MMï¼Œä¾‹å¦‚&#10;09:00-18:00"></textarea>
                        <div class="help">æŒ‰èŠ‚ç‚¹æœ¬åœ°æ—¶åŒºç”Ÿæ•ˆï¼›è·¨å¤©å¯å†™ 23:00-06:00ã€‚</div>
                      </div>
                      <div class="col">
                        <label class="label">å…è®¸ Tokenï¼ˆå¯é€‰ï¼‰</label>
                        <textarea class="textarea" id="f_intranet_acl_allow_tokens" rows="2" placeholder="æ¯è¡Œä¸€ä¸ª tokenï¼›ç•™ç©º=ä¸é™åˆ¶"></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </details>

              <div class="row" style="gap:10px; justify-content:flex-end;">
                <button class="btn xs ghost" type="button" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn xs" type="button" onclick="saveRule()">ä¿å­˜</button>
              </div>

              <div id="modalMsg" class="form-error" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

<div id="restoreModal" class="modal" style="display:none;">
  <div class="modal-inner" style="max-width:860px;">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div class="col"><div class="h2">æ¢å¤è§„åˆ™</div></div>
      <div class="right"><button class="btn xs ghost" type="button" onclick="closeRestoreModal()">å…³é—­</button></div>
    </div>
    <div class="form">
      <label class="label">ç²˜è´´å¤‡ä»½æ–‡ä»¶å†…å®¹ï¼ˆJSONï¼‰</label>
      <textarea class="textarea" id="restoreText" rows="14" placeholder='{
  "ok": true,
  "pool": {
    "endpoints": []
  }
}'></textarea>
      <div class="row" style="gap:10px;justify-content:flex-end;margin-top:12px;">
        <button class="btn xs ghost" type="button" onclick="closeRestoreModal()">å–æ¶ˆ</button>
        <button class="btn xs" type="button" onclick="restoreFromText()">å¼€å§‹æ¢å¤</button>
      </div>
    </div>
  </div>
</div>

<div id="commandModal" class="modal" style="display:none;">
  <div class="modal-inner">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div class="col"><div class="h2" id="commandTitle">å‘½ä»¤</div></div>
      <div class="right"><button class="btn xs ghost" type="button" onclick="closeCommandModal()">å…³é—­</button></div>
    </div>
    <p class="muted" style="margin-top:8px;">åœ¨ç›®æ ‡èŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ã€‚</p>
    <pre class="code-block" id="commandText"></pre>
    <div class="row" style="justify-content:flex-end;">
      <button class="btn xs" data-copy-target="commandText">å¤åˆ¶å‘½ä»¤</button>
    </div>
  </div>
</div>

<div id="traceRouteModal" class="modal" style="display:none;">
  <div class="modal-inner trace-route-modal-inner">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div class="col"><div class="h2" id="traceRouteTitle">è·¯ç”±è¿½è¸ª</div></div>
      <div class="right"><button class="btn xs ghost" type="button" onclick="closeTraceRouteModal()">å…³é—­</button></div>
    </div>
    <div id="traceRouteHint" class="muted sm" style="margin-top:8px;">åœ¨å½“å‰èŠ‚ç‚¹æ‰§è¡Œè·¯ç”±è¿½è¸ªï¼ˆä¼˜å…ˆ mtrï¼Œå›é€€ tracerouteï¼‰ã€‚</div>
    <div id="traceRouteMeta" class="trace-route-meta" style="margin-top:8px;"></div>
    <div id="traceRouteError" class="form-error" style="margin-top:8px;"></div>

    <div class="trace-route-chart-card" style="margin-top:10px;">
      <div class="trace-route-chart-head">
        <div class="name">æ¯è·³å»¶è¿Ÿ</div>
        <div class="hint muted sm">æŠ˜çº¿ä¸º Avg(ms)ï¼Œä¸¢åŒ…è·³ä¼šæ–­å¼€</div>
      </div>
      <canvas id="traceRouteCanvas" class="hist-canvas small trace-route-canvas" aria-label="trace-route-latency"></canvas>
    </div>

    <div class="table-wrap trace-route-table-wrap" style="margin-top:8px;">
      <table class="table no-sticky trace-route-table">
        <thead>
          <tr>
            <th>Hop</th>
            <th>Host</th>
            <th>IP</th>
            <th>Loss</th>
            <th>Avg</th>
            <th>Best</th>
            <th>Worst</th>
            <th>Samples</th>
          </tr>
        </thead>
        <tbody id="traceRouteBody">
          <tr><td colspan="8" class="muted">æš‚æ— è¿½è¸ªç»“æœ</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{% set perms2 = (request.session.get('user_permissions') if request and request.session else []) or [] %}
{% set policy2 = (request.session.get('user_policy') if request and request.session else {}) or {} %}
{% if policy2 is mapping %}
  {% set allowed_tunnels2 = (policy2.get('allowed_tunnel_types') or []) %}
  {% if policy2.get('tunnel_limit_enabled') is not none %}
    {% set tunnel_limit_enabled2 = policy2.get('tunnel_limit_enabled') %}
  {% else %}
    {% set tunnel_limit_enabled2 = 'allowed_tunnel_types' in policy2 %}
  {% endif %}
{% else %}
  {% set allowed_tunnels2 = [] %}
  {% set tunnel_limit_enabled2 = false %}
{% endif %}
{% set can_publish2 = ('*' in perms2) or ('publish.apply' in perms2) %}
{% set can_mode_wss_perm2 = ('*' in perms2) or ('sync.wss' in perms2) or ('sync.*' in perms2) %}
{% set can_mode_intranet_perm2 = ('*' in perms2) or ('sync.intranet' in perms2) or ('sync.*' in perms2) %}
{% set tunnel_no_limit2 = not tunnel_limit_enabled2 %}
{% set can_mode_tcp2 = can_publish2 and (tunnel_no_limit2 or ('direct' in allowed_tunnels2) or ('tcp' in allowed_tunnels2)) %}
{% set can_mode_wss2 = can_publish2 and can_mode_wss_perm2 and (tunnel_no_limit2 or ('wss' in allowed_tunnels2)) %}
{% set can_mode_intranet2 = can_publish2 and can_mode_intranet_perm2 and (tunnel_no_limit2 or ('intranet' in allowed_tunnels2)) %}
<script src="/static/app.js?v=100.0"></script>
<script>
window.__NODE_ID__ = {{ node.id }};
window.__NODE_IP__ = {{ (node.display_ip or node.name)|tojson }};
window.__NODE_NAME__ = {{ (node.name or '')|tojson }};
window.__NODE_BASE_URL__ = {{ (node.base_url or '')|tojson }};
window.__NODE_VERIFY_TLS__ = {{ (1 if node.verify_tls else 0) }};
window.__NODE_IS_PRIVATE__ = {{ (1 if node.is_private else 0) }};
window.__NODE_ROLE__ = {{ (node.role or 'normal')|tojson }};
window.__NODE_WEBSITE_ROOT__ = {{ (node.website_root_base or '')|tojson }};
window.__NODE_GROUP__ = {{ (node.group_name or 'é»˜è®¤åˆ†ç»„')|tojson }};
window.__NODE_AUTO_RESTART_ENABLED__ = {{ (1 if (node.auto_restart_policy.enabled if node.auto_restart_policy else 1) else 0) }};
window.__NODE_AUTO_RESTART_SCHEDULE__ = {{ ((node.auto_restart_policy.schedule_type if node.auto_restart_policy else 'daily'))|tojson }};
window.__NODE_AUTO_RESTART_INTERVAL__ = {{ (node.auto_restart_policy.interval if node.auto_restart_policy else 1) }};
window.__NODE_AUTO_RESTART_HOUR__ = {{ (node.auto_restart_policy.hour if node.auto_restart_policy else 4) }};
window.__NODE_AUTO_RESTART_MINUTE__ = {{ (node.auto_restart_policy.minute if node.auto_restart_policy else 8) }};
window.__NODE_AUTO_RESTART_WEEKDAYS__ = {{ ((node.auto_restart_policy.weekdays if node.auto_restart_policy else [1,2,3,4,5,6,7]))|tojson }};
window.__NODE_AUTO_RESTART_MONTHDAYS__ = {{ ((node.auto_restart_policy.monthdays if node.auto_restart_policy else [1]))|tojson }};
window.__INSTALL_CMD__ = {{ install_cmd|tojson }};
window.__UNINSTALL_CMD__ = {{ uninstall_cmd|tojson }};
window.__AUTO_OPEN_EDIT_NODE__ = {{ (1 if show_edit_node else 0) }};
window.__MODE_PERMS__ = {{ {"tcp": can_mode_tcp2, "wss": can_mode_wss2, "intranet": can_mode_intranet2}|tojson }};
window.__ALLOWED_TUNNEL_MODES__ = {{ ((["tcp"] if can_mode_tcp2 else []) + (["wss"] if can_mode_wss2 else []) + (["intranet"] if can_mode_intranet2 else []))|tojson }};
window.addEventListener('DOMContentLoaded', () => {
  initNodePage();
});

document.querySelectorAll('[data-copy-target]').forEach((btn)=>{
  btn.addEventListener('click', async ()=>{
    const id = btn.getAttribute('data-copy-target');
    const text = document.getElementById(id).textContent.trim();
    try{
      await navigator.clipboard.writeText(text);
      const original = btn.dataset._orig || btn.textContent;
      btn.dataset._orig = original;
      btn.textContent = 'å·²å¤åˆ¶';
      setTimeout(()=>{ btn.textContent = original; }, 1200);
    }catch(e){
      alert('å¤åˆ¶å¤±è´¥ï¼šæµè§ˆå™¨ä¸å…è®¸è®¿é—®å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
    }
  });
});

{% if show_install_cmd %}
openCommandModal('ä¸€é”®æ¥å…¥å‘½ä»¤', window.__INSTALL_CMD__);
{% endif %}
</script>
{% endblock %}
