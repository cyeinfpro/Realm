{% extends "base.html" %}
{% block content %}
{% set ok = diag.ok if diag is defined else None %}
{% set okcls = 'ok' if ok else ('bad' if ok is not none else 'ghost') %}

<div class="page-head">
  <div class="page-title">
    <h1 class="h1">诊断 · {{ site.name }}</h1>
    <div class="meta">
      <span class="meta-item">节点：{{ node.name if node else '-' }}</span>
      <span class="meta-item">域名：<span class="mono" style="overflow-wrap:anywhere;">{{ (site.domains or [])|join(', ') }}</span></span>
    </div>
    <div class="meta" style="margin-top:8px;">
      <span class="pill xs {{ okcls }}">{{ 'ok' if ok else 'fail' if ok is not none else 'unknown' }}</span>
      <span class="pill xs ghost">HTTP {{ diag.status_code or '-' }}</span>
      <span class="pill xs ghost">{{ diag.latency_ms or 0 }} ms</span>
    </div>
  </div>
  <div class="right">
    <a class="btn sm" href="/websites/{{ site.id }}/diagnose?refresh=1">立即诊断</a>
    <a class="btn sm ghost" href="/websites/{{ site.id }}">返回站点</a>
  </div>
</div>

{% include "site_nav.html" %}

{% if diag_error %}
  <div class="flash" style="background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.4);">
    {{ diag_error }}
  </div>
{% endif %}

<div class="meta" style="margin:0 0 10px;">
  <span class="meta-item">数据来源：{{ '实时诊断' if diag_source == 'live' else '缓存结果（点击“立即诊断”刷新）' }}</span>
</div>

<div class="site-layout site-layout-diagnose">
  <div class="site-stack">
    <div class="card compact">
      <div class="section-head">
        <div>
          <div class="section-title">诊断摘要</div>
          <div class="section-sub">当前健康状态与关键检查项（紧凑展示）。</div>
        </div>
      </div>

      <div class="kv-lines">
        <div class="kvline"><div class="k">Nginx 配置</div><div class="v"><span class="pill xs {{ 'ok' if diag.checks.nginx_test_ok else ('bad' if diag.checks.nginx_test_ok is not none else 'warn') }}">{{ 'ok' if diag.checks.nginx_test_ok else ('fail' if diag.checks.nginx_test_ok is not none else 'unknown') }}</span></div></div>
        <div class="kvline"><div class="k">Nginx 运行</div><div class="v"><span class="pill xs {{ 'ok' if diag.checks.nginx_active else 'warn' }}">{{ diag.checks.nginx_active if diag.checks.nginx_active is not none else 'unknown' }}</span></div></div>
        <div class="kvline"><div class="k">配置存在</div><div class="v"><span class="pill xs {{ 'ok' if diag.checks.conf_exists else ('bad' if diag.checks.conf_exists is not none else 'warn') }}">{{ 'ok' if diag.checks.conf_exists else ('missing' if diag.checks.conf_exists is not none else 'unknown') }}</span></div></div>
        <div class="kvline"><div class="k">配置已加载</div><div class="v"><span class="pill xs {{ 'ok' if diag.checks.conf_included else ('warn' if diag.checks.conf_included is not none else 'ghost') }}">{{ 'ok' if diag.checks.conf_included else ('unknown' if diag.checks.conf_included is not none else '-') }}</span></div></div>
        <div class="kvline"><div class="k">根目录</div><div class="v"><span class="pill xs {{ 'ok' if diag.checks.root_exists else ('bad' if diag.checks.root_exists is not none else 'warn') }}">{{ 'ok' if diag.checks.root_exists else ('missing' if diag.checks.root_exists is not none else 'unknown') }}</span></div></div>
        <div class="kvline"><div class="k">PHP-FPM</div><div class="v"><span class="pill xs {{ 'ok' if diag.checks.php_ok else ('warn' if diag.checks.php_ok is not none else 'ghost') }}">{{ 'ok' if diag.checks.php_ok else ('not ready' if diag.checks.php_ok is not none else '-') }}</span></div></div>
        <div class="kvline"><div class="k">HTTP 探测</div><div class="v"><span class="pill xs {{ 'ok' if diag.checks.http_ok else ('bad' if diag.checks.http_ok is not none else 'warn') }}">{{ diag.checks.http_status or '-' }}</span></div></div>
        <div class="kvline"><div class="k">虚拟主机命中</div><div class="v"><span class="pill xs {{ 'ok' if diag.checks.vhost_match else 'warn' if diag.checks.vhost_match is none else 'bad' }}">{{ 'ok' if diag.checks.vhost_match else 'unknown' if diag.checks.vhost_match is none else 'mismatch' }}</span></div></div>
        <div class="kvline"><div class="k">错误</div><div class="v mono" title="{{ diag.error or '' }}">{{ diag.error or '-' }}</div></div>
      </div>
    </div>

    <div class="card compact">
      <div class="section-head">
        <div>
          <div class="section-title">关键路径</div>
          <div class="section-sub">配置与目录位置（必要信息集中）。</div>
        </div>
      </div>

      <div class="kv-lines">
        <div class="kvline"><div class="k">配置路径</div><div class="v mono" title="{{ diag.checks.conf_path or '-' }}">{{ diag.checks.conf_path or '-' }}</div></div>
        <div class="kvline"><div class="k">根目录</div><div class="v mono" title="{{ site.root_path or '-' }}">{{ site.root_path or '-' }}</div></div>
        <div class="kvline"><div class="k">反向代理</div><div class="v mono" title="{{ site.proxy_target or '-' }}">{{ site.proxy_target or '-' }}</div></div>
        <div class="kvline"><div class="k">HTTP 延迟</div><div class="v mono">{{ diag.latency_ms or 0 }} ms</div></div>
      </div>

      <details class="advanced-details" style="margin-top:10px;">
        <summary>Nginx 测试输出</summary>
        <div class="advanced-body">
          <pre class="mono" style="white-space:pre-wrap; margin:0;">{{ diag.checks.nginx_test_output or '-' }}</pre>
        </div>
      </details>
    </div>
  </div>

  <div class="site-stack diag-side-stack">
    {% set csum = namespace(total=checks|length, fail=0) %}
    {% for c in checks %}
      {% if not (c.ok or 0) %}
        {% set csum.fail = csum.fail + 1 %}
      {% endif %}
    {% endfor %}

    <div class="card compact diag-mini-card">
      <div class="section-head">
        <div>
          <div class="section-title">最近检查</div>
          <div class="section-sub">紧凑流式视图（默认最近 6 条）。</div>
        </div>
        <span class="pill xs ghost">共 {{ csum.total }}</span>
      </div>

      <div class="diag-mini-stats">
        <span class="pill xs ok">成功 {{ csum.total - csum.fail }}</span>
        <span class="pill xs {{ 'bad' if csum.fail else 'ghost' }}">失败 {{ csum.fail }}</span>
      </div>

      {% if checks %}
        <div class="diag-feed" style="margin-top:10px;">
          {% for c in checks[:6] %}
            {% set ok = (c.ok or 0) %}
            <div class="diag-feed-item">
              <div class="diag-feed-main">
                <span class="mono diag-feed-time">{{ c.checked_at }}</span>
                <span class="pill xs {{ 'ok' if ok else 'bad' }}">{{ 'ok' if ok else 'fail' }}</span>
                <span class="mono diag-feed-meta">HTTP {{ c.status_code or '-' }} · {{ c.latency_ms or 0 }} ms</span>
              </div>
              {% if c.error %}
                <div class="mono diag-feed-sub" title="{{ c.error }}">{{ c.error }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        {% if checks|length > 6 %}
          <details class="advanced-details" style="margin-top:10px;">
            <summary>查看完整检查记录（{{ checks|length }}）</summary>
            <div class="advanced-body">
              <div class="table-wrap">
                <table class="table no-sticky dense">
                  <thead>
                    <tr>
                      <th>时间</th>
                      <th>状态</th>
                      <th>HTTP</th>
                      <th>延迟</th>
                      <th>错误</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for c in checks %}
                    {% set ok = (c.ok or 0) %}
                    <tr>
                      <td class="mono">{{ c.checked_at }}</td>
                      <td><span class="pill xs {{ 'ok' if ok else 'bad' }}">{{ 'ok' if ok else 'fail' }}</span></td>
                      <td class="mono">{{ c.status_code or '-' }}</td>
                      <td class="mono">{{ c.latency_ms or 0 }} ms</td>
                      <td><div class="mono truncate" title="{{ c.error or '' }}">{{ c.error or '-' }}</div></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </details>
        {% endif %}
      {% else %}
        <div class="muted" style="margin-top:10px;">暂无检查记录</div>
      {% endif %}
    </div>

    {% set esum = namespace(total=events|length, failed=0, running=0) %}
    {% for e in events %}
      {% set es = (e.status or '') %}
      {% if es in ['failed','error'] %}
        {% set esum.failed = esum.failed + 1 %}
      {% elif es == 'running' %}
        {% set esum.running = esum.running + 1 %}
      {% endif %}
    {% endfor %}

    <div class="card compact diag-mini-card">
      <div class="section-head">
        <div>
          <div class="section-title">变更历史</div>
          <div class="section-sub">紧凑事件流（默认最近 6 条）。</div>
        </div>
        <span class="pill xs ghost">共 {{ esum.total }}</span>
      </div>

      <div class="diag-mini-stats">
        <span class="pill xs ok">成功 {{ esum.total - esum.failed - esum.running }}</span>
        <span class="pill xs warn">进行中 {{ esum.running }}</span>
        <span class="pill xs {{ 'bad' if esum.failed else 'ghost' }}">失败 {{ esum.failed }}</span>
      </div>

      {% if events %}
        <div class="diag-feed" style="margin-top:10px;">
          {% for e in events[:6] %}
            {% set es = (e.status or '') %}
            {% set ecls = 'ok' if es == 'success' else ('warn' if es == 'running' else ('bad' if es in ['failed','error'] else 'ghost')) %}
            <div class="diag-feed-item">
              <div class="diag-feed-main">
                <span class="mono diag-feed-time">{{ e.created_at }}</span>
                <span class="pill xs {{ ecls }}">{{ es }}</span>
                <span class="diag-feed-action">{{ e.action }}</span>
              </div>
              <div class="diag-feed-sub">
                <span>{{ e.actor or '-' }}</span>
                {% if e.error %}
                  <span class="mono diag-feed-error" title="{{ e.error }}">{{ e.error }}</span>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>

        {% if events|length > 6 %}
          <details class="advanced-details" style="margin-top:10px;">
            <summary>查看完整变更记录（{{ events|length }}）</summary>
            <div class="advanced-body">
              <div class="table-wrap">
                <table class="table no-sticky dense">
                  <thead>
                    <tr>
                      <th>时间</th>
                      <th>动作</th>
                      <th>状态</th>
                      <th>操作者</th>
                      <th>错误</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for e in events %}
                    {% set es = (e.status or '') %}
                    {% set ecls = 'ok' if es == 'success' else ('warn' if es == 'running' else ('bad' if es in ['failed','error'] else 'ghost')) %}
                    <tr>
                      <td class="mono">{{ e.created_at }}</td>
                      <td>{{ e.action }}</td>
                      <td><span class="pill xs {{ ecls }}">{{ es }}</span></td>
                      <td>{{ e.actor or '-' }}</td>
                      <td><div class="mono truncate" title="{{ e.error or '' }}">{{ e.error or '-' }}</div></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </details>
        {% endif %}
      {% else %}
        <div class="muted" style="margin-top:10px;">暂无变更记录</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
