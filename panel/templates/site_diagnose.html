{% extends "base.html" %}
{% block content %}
{% set ok = diag.ok if diag is defined else None %}
{% set okcls = 'ok' if ok else ('bad' if ok is not none else 'ghost') %}

<div class="hero-card">
  <div class="hero-left">
    <span class="pill xs ghost">Diagnose</span>
    <div class="hero-title">站点诊断 · {{ site.name }}</div>
    <div class="hero-sub">节点：{{ node.name if node else '-' }} · 域名：<span class="mono">{{ (site.domains or [])|join(', ') }}</span></div>
    <div class="hero-metrics">
      <span class="pill xs {{ okcls }}">{{ 'ok' if ok else 'fail' if ok is not none else 'unknown' }}</span>
      <span class="pill xs ghost">HTTP {{ diag.status_code or '-' }}</span>
      <span class="pill xs ghost">{{ diag.latency_ms or 0 }} ms</span>
    </div>
  </div>
  <div class="hero-right">
    <a class="btn sm ghost" href="/websites/{{ site.id }}">返回站点</a>
  </div>
</div>

{% if diag_error %}
  <div class="flash" style="background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.4);">
    {{ diag_error }}
  </div>
{% endif %}

<div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(320px,1fr));">
  <div class="card">
    <div class="section-head">
      <div>
        <div class="section-title">诊断摘要</div>
        <div class="section-sub">当前健康状态与关键检查项。</div>
      </div>
    </div>
    <div class="kv-grid" style="margin-top:10px;">
      <div class="kv-item"><div class="kv-label">Nginx 配置</div><div class="kv-value"><span class="pill xs {{ 'ok' if diag.checks.nginx_test_ok else 'bad' }}">{{ 'ok' if diag.checks.nginx_test_ok else 'fail' }}</span></div></div>
      <div class="kv-item"><div class="kv-label">Nginx 运行</div><div class="kv-value"><span class="pill xs {{ 'ok' if diag.checks.nginx_active else 'warn' }}">{{ diag.checks.nginx_active if diag.checks.nginx_active is not none else 'unknown' }}</span></div></div>
      <div class="kv-item"><div class="kv-label">配置存在</div><div class="kv-value"><span class="pill xs {{ 'ok' if diag.checks.conf_exists else 'bad' }}">{{ 'ok' if diag.checks.conf_exists else 'missing' }}</span></div></div>
      <div class="kv-item"><div class="kv-label">配置已加载</div><div class="kv-value"><span class="pill xs {{ 'ok' if diag.checks.conf_included else 'warn' }}">{{ 'ok' if diag.checks.conf_included else 'unknown' }}</span></div></div>
      <div class="kv-item"><div class="kv-label">根目录</div><div class="kv-value"><span class="pill xs {{ 'ok' if diag.checks.root_exists else 'bad' }}">{{ 'ok' if diag.checks.root_exists else 'missing' }}</span></div></div>
      <div class="kv-item"><div class="kv-label">PHP-FPM</div><div class="kv-value"><span class="pill xs {{ 'ok' if diag.checks.php_ok else 'warn' }}">{{ 'ok' if diag.checks.php_ok else 'not ready' }}</span></div></div>
      <div class="kv-item"><div class="kv-label">HTTP 探测</div><div class="kv-value"><span class="pill xs {{ 'ok' if diag.checks.http_ok else 'bad' }}">{{ diag.checks.http_status or '-' }}</span></div></div>
      <div class="kv-item"><div class="kv-label">虚拟主机命中</div><div class="kv-value"><span class="pill xs {{ 'ok' if diag.checks.vhost_match else 'warn' if diag.checks.vhost_match is none else 'bad' }}">{{ 'ok' if diag.checks.vhost_match else 'unknown' if diag.checks.vhost_match is none else 'mismatch' }}</span></div></div>
      <div class="kv-item" style="grid-column:1 / -1;"><div class="kv-label">错误</div><div class="kv-value mono">{{ diag.error or '-' }}</div></div>
    </div>
  </div>

  <div class="card">
    <div class="section-head">
      <div>
        <div class="section-title">关键路径</div>
        <div class="section-sub">配置与目录位置。</div>
      </div>
    </div>
    <div class="kv-grid" style="margin-top:10px;">
      <div class="kv-item"><div class="kv-label">配置路径</div><div class="kv-value mono">{{ diag.checks.conf_path or '-' }}</div></div>
      <div class="kv-item"><div class="kv-label">根目录</div><div class="kv-value mono">{{ site.root_path or '-' }}</div></div>
      <div class="kv-item"><div class="kv-label">反向代理</div><div class="kv-value mono">{{ site.proxy_target or '-' }}</div></div>
      <div class="kv-item"><div class="kv-label">HTTP 延迟</div><div class="kv-value">{{ diag.latency_ms or 0 }} ms</div></div>
      <div class="kv-item" style="grid-column:1 / -1;"><div class="kv-label">Nginx 测试输出</div><div class="kv-value mono" style="white-space:pre-wrap;">{{ diag.checks.nginx_test_output or '-' }}</div></div>
    </div>
  </div>

  <div class="card">
    <div class="section-head">
      <div>
        <div class="section-title">最近检查</div>
        <div class="section-sub">健康监测结果。</div>
      </div>
    </div>
    {% if checks %}
    <div class="table-wrap" style="margin-top:10px;">
      <table class="table no-sticky">
        <thead>
          <tr>
            <th>时间</th>
            <th>状态</th>
            <th>HTTP</th>
            <th>延迟</th>
            <th>错误</th>
          </tr>
        </thead>
        <tbody>
          {% for c in checks %}
          {% set ok = (c.ok or 0) %}
          <tr>
            <td class="mono">{{ c.checked_at }}</td>
            <td><span class="pill xs {{ 'ok' if ok else 'bad' }}">{{ 'ok' if ok else 'fail' }}</span></td>
            <td>{{ c.status_code or '-' }}</td>
            <td>{{ c.latency_ms or 0 }} ms</td>
            <td class="mono">{{ c.error or '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="muted" style="margin-top:10px;">暂无检查记录</div>
    {% endif %}
  </div>

  <div class="card">
    <div class="section-head">
      <div>
        <div class="section-title">变更历史</div>
        <div class="section-sub">站点创建、删除、证书等操作记录。</div>
      </div>
    </div>
    {% if events %}
      <div class="table-wrap" style="margin-top:10px;">
        <table class="table no-sticky">
          <thead>
            <tr>
              <th>时间</th>
              <th>动作</th>
              <th>状态</th>
              <th>操作者</th>
              <th>错误</th>
            </tr>
          </thead>
          <tbody>
            {% for e in events %}
            {% set es = (e.status or '') %}
            {% set ecls = 'ok' if es == 'success' else ('warn' if es == 'running' else ('bad' if es in ['failed','error'] else 'ghost')) %}
            <tr>
              <td class="mono">{{ e.created_at }}</td>
              <td>{{ e.action }}</td>
              <td><span class="pill xs {{ ecls }}">{{ es }}</span></td>
              <td>{{ e.actor or '-' }}</td>
              <td class="mono">{{ e.error or '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="muted" style="margin-top:10px;">暂无变更记录</div>
    {% endif %}
  </div>
</div>
{% endblock %}
