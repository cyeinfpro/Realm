{% extends "base.html" %}

{% block content %}
{% set type_map = {'static':'静态', 'php':'PHP', 'reverse_proxy':'反向代理'} %}

<div class="page-head">
  <div class="page-title">
    <h1 class="h1">编辑站点 · {{ site.name }}</h1>
    <div class="meta">
      <span class="meta-item">节点：{{ node.name if node else '-' }}</span>
      <span class="meta-item">域名：<span class="mono" style="overflow-wrap:anywhere;">{{ (site.domains or [])|join(', ') }}</span></span>
    </div>
    <div class="meta" style="margin-top:8px;">
      <span class="pill xs ghost">ID #{{ site.id }}</span>
      <span class="pill xs ghost">{{ type_map.get(site.type, site.type) }}</span>
    </div>
  </div>
  <div class="right">
    <a class="btn sm ghost" href="/websites">返回列表</a>
    <a class="btn sm" href="/websites/{{ site.id }}">站点详情</a>
  </div>
</div>

{% include "site_nav.html" %}

<div class="card compact" style="margin-top:12px;">
  <div class="section-head">
    <div>
      <div class="section-title">站点配置</div>
      <div class="section-sub">保存后会立即重写 Nginx 配置并 reload；不会删除网站数据。</div>
    </div>
    <span class="pill xs ghost">ID #{{ site.id }}</span>
  </div>

  <form method="post" action="/websites/{{ site.id }}/edit" class="form" style="margin-top:12px;" id="siteEditForm">
      <div class="form-section">
        <div class="section-head">
          <div>
            <div class="section-title">基础信息</div>
            <div class="section-sub">名称仅用于展示；域名支持多个。</div>
          </div>
        </div>

        <div class="form-grid">
          <div class="col">
            <label class="label">站点名称（可选）</label>
            <input class="input" name="name" value="{{ site.name or '' }}" placeholder="例如：官网/博客/业务站" />
          </div>
          <div class="col">
            <label class="label">站点类型</label>
            <select class="select" name="site_type" id="site_type">
              <option value="static" {% if site.type == 'static' %}selected{% endif %}>静态站点（HTML/前端）</option>
              <option value="php" {% if site.type == 'php' %}selected{% endif %}>PHP 站点</option>
              <option value="reverse_proxy" {% if site.type == 'reverse_proxy' %}selected{% endif %}>反向代理（转发到其它服务）</option>
            </select>
          </div>
          <div class="col" style="grid-column: 1 / -1;">
            <label class="label">域名（多个用逗号分隔）</label>
            <input class="input" name="domains" value="{{ site.domains_text or '' }}" placeholder="example.com, www.example.com" />
            <div class="help">多个域名使用逗号或空格分隔。主域名建议放在第一位。</div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="section-head">
          <div>
            <div class="section-title">运行配置</div>
            <div class="section-sub">静态/PHP 使用根目录；反向代理使用目标地址。</div>
          </div>
        </div>

        <div class="form-grid">
          <div class="col" id="root_row">
            <label class="label">网站根目录</label>
            <input class="input" name="root_path" id="root_path" value="{{ site.root_path or '' }}" placeholder="/www/wwwroot/example.com" />
            <div class="help">静态/PHP 必填；反向代理可留空（系统会自动创建用于 SSL 验证的目录）。</div>
          </div>

          <div class="col" id="proxy_row">
            <label class="label">代理目标</label>
            <input class="input" name="proxy_target" id="proxy_target" value="{{ site.proxy_target or '' }}" placeholder="127.0.0.1:8080 或 http://127.0.0.1:8080" />
            <div class="help">仅反向代理需要填写，支持 http(s)://host:port 或 unix:/path.sock。</div>
          </div>
        </div>

        <div class="row" style="gap:14px; margin-top:6px; flex-wrap:wrap;">
          <label class="help"><input type="checkbox" name="https_redirect" {% if site.https_redirect %}checked{% endif %} style="transform:translateY(1px);"> HTTP 自动跳转 HTTPS</label>
          {% set gz = site.gzip_enabled %}
          <label class="help"><input type="checkbox" name="gzip_enabled" {% if gz is none or gz %}checked{% endif %} style="transform:translateY(1px);"> 启用 Gzip</label>
        </div>
      </div>

      <div class="form-section">
        <div class="section-head">
          <div>
            <div class="section-title">高级</div>
            <div class="section-sub">如需完全控制配置，可使用自定义 Nginx 模板。</div>
          </div>
        </div>

        <details>
          <summary class="btn xs ghost">自定义 Nginx 模板</summary>
          <div style="margin-top:10px;">
            <div class="help compact" style="margin-top:0;">
              可用变量：<span class="mono">{{'{{'}}SERVER_NAME{{'}}'}}</span>、<span class="mono">{{'{{'}}ROOT_PATH{{'}}'}}</span>、<span class="mono">{{'{{'}}PROXY_TARGET{{'}}'}}</span>、
              <span class="mono">{{'{{'}}SSL_CERT{{'}}'}}</span>、<span class="mono">{{'{{'}}SSL_KEY{{'}}'}}</span>、<span class="mono">{{'{{'}}GZIP_CONF{{'}}'}}</span>、
              <span class="mono">{{'{{'}}ACME_ROOT{{'}}'}}</span>
            </div>
            <textarea class="textarea mono" name="nginx_tpl" id="nginxTplInput" rows="16" placeholder="# 留空则使用内置模板">{{ site.nginx_tpl or default_nginx_tpl }}</textarea>
            <div class="help">提示：请确保 <span class="mono">/.well-known/acme-challenge/</span> 可被访问，否则 SSL 申请会失败。</div>
          </div>
        </details>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="col">
          <a class="btn ghost" href="/websites/{{ site.id }}">取消</a>
        </div>
        <div class="col right">
          <button class="btn" type="submit">保存并应用</button>
        </div>
      </div>
    </form>

</div>

<script>
(function(){
  const sel = document.getElementById('site_type');
  const rootRow = document.getElementById('root_row');
  const proxyRow = document.getElementById('proxy_row');
  const formEl = document.getElementById('siteEditForm');
  const tplEl = document.getElementById('nginxTplInput');
  const hadCustomTpl = {{ 'true' if site.nginx_tpl else 'false' }};
  const defaultTpl = {{ default_nginx_tpl|tojson }};

  function toggle(){
    const t = (sel && sel.value) || 'static';
    if(t === 'reverse_proxy'){
      if(proxyRow) proxyRow.style.display = '';
      if(rootRow) rootRow.style.display = '';
    }else{
      if(proxyRow) proxyRow.style.display = 'none';
      if(rootRow) rootRow.style.display = '';
    }
  }
  if(sel){
    sel.addEventListener('change', toggle);
  }
  if(formEl && tplEl){
    formEl.addEventListener('submit', function(){
      // If this site originally had no custom template and user didn't modify
      // the prefilled default reference, keep it empty to continue using built-in behavior.
      if(!hadCustomTpl && tplEl.value === defaultTpl){
        tplEl.value = '';
      }
    });
  }
  toggle();
})();
</script>
{% endblock %}
