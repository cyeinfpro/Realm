{% extends "base.html" %}
{% block content %}

{# ---- Stats ---- #}
{% set stats = namespace(running=0, creating=0, error=0, health_fail=0) %}
{% for s in sites %}
  {% if (s.status or '') == 'running' %}
    {% set stats.running = stats.running + 1 %}
  {% elif (s.status or '') in ['creating','pending'] %}
    {% set stats.creating = stats.creating + 1 %}
  {% elif (s.status or '') == 'error' %}
    {% set stats.error = stats.error + 1 %}
  {% endif %}
  {% if (s.health_status or '') == 'fail' %}
    {% set stats.health_fail = stats.health_fail + 1 %}
  {% endif %}
{% endfor %}

<div class="page-head">
  <div class="page-title">
    <h1 class="h1">网站管理</h1>
    <div class="meta">
      <span class="meta-item">统一编排站点生命周期：部署、证书、健康诊断与文件管理。</span>
      <span class="meta-item">· 站点 <strong>{{ sites|length }}</strong></span>
      <span class="meta-item">· 网站机 <strong>{{ nodes|length }}</strong></span>
    </div>
  </div>
  <div class="right">
    <button
      class="btn sm"
      type="button"
      data-action="open-site-create"
      {% if not nodes %}disabled title="请先接入并设置网站机节点"{% endif %}
    >新建站点</button>
  </div>
</div>

<section class="card wm-fav-card" id="wmFavCard">
  <div class="wm-card-head">
    <div>
      <div class="wm-card-title">文件收藏</div>
      <div class="wm-card-sub">将常用文件/目录固定在这里，点击后以弹窗方式直接管理。</div>
    </div>
    <div class="wm-card-tools">
      <span class="pill xs ghost" id="wmFavCount">{{ file_favorites|length }} 项</span>
    </div>
  </div>
  <div class="wm-fav-grid" id="wmFavGrid">
    {% if file_favorites %}
      {% for f in file_favorites %}
        <div
          class="wm-fav-item"
          data-site-id="{{ f.site_id }}"
          data-path="{{ f.path }}"
          data-type="{{ 'dir' if f.is_dir else 'file' }}"
          data-name="{{ f.name }}"
        >
          <button class="wm-fav-main" type="button" data-action="open-favorite">
            <div class="wm-fav-main-top">
              <span class="wm-fav-star">★</span>
              <span class="wm-fav-name" title="{{ f.name }}">{{ f.name }}</span>
              <span class="pill xs ghost">{{ '目录' if f.is_dir else '文件' }}</span>
            </div>
            <div class="wm-fav-path mono" title="{{ f.path }}">{{ f.path }}</div>
            <div class="wm-fav-meta">
              <span>{{ f.site_name }}</span>
              {% if f.site_domain %}<span class="mono">{{ f.site_domain }}</span>{% endif %}
            </div>
          </button>
          <div class="wm-fav-actions">
            <button class="btn xs ghost" type="button" data-action="open-favorite">打开</button>
            <button class="btn xs ghost wm-fav-unstar" type="button" data-action="unstar-favorite">取消收藏</button>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="wm-fav-empty" id="wmFavEmpty">暂未收藏文件或目录。可在文件管理里点击“☆/★”收藏常用项。</div>
    {% endif %}
  </div>
</section>

{# ---- Main layout ---- #}
<div class="wm-layout">

  <section class="card wm-card">
    <div class="wm-card-head">
      <div>
        <div class="wm-card-title">站点列表</div>
        <div class="wm-card-sub">按状态快速筛选，集中处理发布、诊断、文件与证书操作。</div>
      </div>
      <div class="wm-card-tools">
        <span class="pill xs ghost">共 {{ sites|length }} 个</span>
      </div>
    </div>

    {% if sites %}
      <div class="wm-toolbar" id="wmToolbar">
        <div class="dash-filters" id="wmSiteFilters" role="tablist" aria-label="站点筛选">
          <button class="chip active" type="button" data-status="all" aria-selected="true">全部 <strong>{{ sites|length }}</strong></button>
          <button class="chip" type="button" data-status="running">运行 <strong>{{ stats.running }}</strong></button>
          <button class="chip" type="button" data-status="creating">创建 <strong>{{ stats.creating }}</strong></button>
          <button class="chip" type="button" data-status="error">异常 <strong>{{ stats.error }}</strong></button>
          <button class="chip" type="button" id="wmHealthFailChip" data-health="fail">健康异常 <strong>{{ stats.health_fail }}</strong></button>
        </div>

        <div class="dash-search" role="search">
          <span class="dash-search-ico" aria-hidden="true">⌕</span>
          <input id="wmSiteSearch" class="dash-search-input" placeholder="搜索站点 / 域名 / 节点" autocomplete="off" />
          <button id="wmSiteSearchClear" class="dash-search-clear" type="button" title="清空">×</button>
        </div>
      </div>

      <div class="wm-countline">
        显示 <strong><span id="wmSiteCount">{{ sites|length }}</span></strong> / <strong>{{ sites|length }}</strong>
      </div>

      <div class="wm-sites" id="wmSiteGrid" style="margin-top:10px;">
        {% for s in sites %}
          {% set st = (s.status or '') %}
          {% set st_norm = 'creating' if st in ['creating','pending'] else st %}
          {% set st_class = 'ok' if st == 'running' else ('warn' if st in ['creating','pending'] else ('bad' if st == 'error' else 'ghost')) %}
          {% set type_map = {'static':'静态', 'php':'PHP', 'reverse_proxy':'反向代理'} %}
          {% set h = (s.health_status or '') %}
          {% set hcls = 'ok' if h == 'ok' else ('bad' if h == 'fail' else 'ghost') %}
          {% set domains = s.domains or [] %}
          {% set primary_domain = domains[0] if domains else '-' %}
          {% set extra = (domains|length - 1) %}

          <div class="wm-site-row"
               data-site-id="{{ s.id }}"
               data-site-name="{{ s.name }}"
               data-site-domain="{{ primary_domain if primary_domain != '-' else '' }}"
               data-name="{{ (s.name or '')|lower }}"
               data-domains="{{ (s.domains_text or '')|lower }}"
               data-node="{{ (s.node.name if s.node else '-')|lower }}"
               data-status="{{ st_norm }}"
               data-health="{{ h }}">
            <div class="wm-site-left">
              <div class="wm-site-line1">
                <div class="wm-site-name" title="{{ s.name }}">{{ s.name }}</div>
                <span class="pill xs {{ st_class }}" title="运行状态">{{ st or 'unknown' }}</span>
                <span
                  class="pill xs {{ hcls }}"
                  title="{{ (s.health_error or '健康状态') if h in ['fail','unknown'] else '健康状态' }}"
                >{{ h or 'unknown' }}</span>
              </div>

              <div class="wm-site-line2">
                <span class="mono wm-site-domain" title="{{ s.domains_text }}">
                  {{ primary_domain }}{% if extra > 0 %}<span class="muted"> · +{{ extra }}</span>{% endif %}
                </span>
                <span class="wm-site-hint">· {{ type_map.get(s.type, s.type) }}</span>
                {% if s.node %}<span class="wm-site-hint">· {{ s.node.name }}</span>{% endif %}
              </div>
            </div>

            <div class="wm-site-right">
              <div class="wm-site-kpis mono">
                <span class="wm-kpi">HTTP {{ s.health_code or '-' }}</span>
                <span class="wm-kpi">{{ s.health_latency_ms or 0 }}ms</span>
                <span class="wm-kpi">{{ s.health_checked_at or '-' }}</span>
              </div>

              <div class="wm-site-actions">
                <a class="btn icon xs secondary" href="/websites/{{ s.id }}" title="详情">↗</a>
                <details class="menu">
                  <summary class="btn icon xs ghost" title="更多">⋯</summary>
                  <div class="menu-pop">
                    <a class="menu-item" href="/websites/{{ s.id }}/edit">编辑配置</a>
                    <a class="menu-item" href="/websites/{{ s.id }}/diagnose">健康诊断</a>
                    {% if s.type != 'reverse_proxy' and s.root_path %}
                      <a class="menu-item" href="/websites/{{ s.id }}/files">文件管理</a>
                    {% endif %}
                  </div>
                </details>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <script>
  (function(){
    var input = document.getElementById('wmSiteSearch');
    var clearBtn = document.getElementById('wmSiteSearchClear');
    var grid = document.getElementById('wmSiteGrid');
    var countEl = document.getElementById('wmSiteCount');
    var chips = Array.from(document.querySelectorAll('#wmSiteFilters button.chip[data-status]'));
    var healthChip = document.getElementById('wmHealthFailChip');
    if(!grid) return;

    var tiles = Array.from(grid.querySelectorAll('.wm-site-row'));
    var state = { status: 'all', healthFail: false };

    function apply(){
      var q = (input && input.value || '').trim().toLowerCase();
      var shown = 0;
      tiles.forEach(function(t){
        var hay = (t.dataset.name||'') + ' ' + (t.dataset.domains||'') + ' ' + (t.dataset.node||'');
        var ok = (!q) || hay.indexOf(q) !== -1;
        if(state.status && state.status !== 'all'){
          ok = ok && (t.dataset.status === state.status);
        }
        if(state.healthFail){
          ok = ok && (t.dataset.health === 'fail');
        }
        t.style.display = ok ? '' : 'none';
        if(ok) shown++;
      });

      if(countEl) countEl.textContent = String(shown);
      if(clearBtn) clearBtn.style.visibility = q ? 'visible' : 'hidden';
    }

    if(input) input.addEventListener('input', apply);
    if(clearBtn) clearBtn.addEventListener('click', function(){ if(input) input.value=''; apply(); });

    chips.forEach(function(chip){
      chip.addEventListener('click', function(){
        var st = chip.getAttribute('data-status') || 'all';
        state.status = st;
        chips.forEach(function(c){
          var on = (c.getAttribute('data-status') || 'all') === st;
          c.classList.toggle('active', on);
          c.setAttribute('aria-selected', on ? 'true' : 'false');
        });
        apply();
      });
    });

    if(healthChip){
      healthChip.addEventListener('click', function(){
        state.healthFail = !state.healthFail;
        healthChip.classList.toggle('active', state.healthFail);
        healthChip.setAttribute('aria-selected', state.healthFail ? 'true' : 'false');
        apply();
      });
    }

    apply();
  })();
      </script>
    {% else %}
      <div class="muted" style="margin-top:10px;">还没有站点。建议先创建业务入口，再逐步配置 SSL 与健康巡检。</div>
      <div class="row" style="margin-top:12px;">
        <button
          class="btn"
          type="button"
          data-action="open-site-create"
          {% if not nodes %}disabled title="请先接入并设置网站机节点"{% endif %}
        >新建站点</button>
      </div>
    {% endif %}
  </section>

  <aside class="card wm-card">
    <div class="wm-card-head">
      <div>
        <div class="wm-card-title">网站机节点</div>
        <div class="wm-card-sub">查看环境能力并执行安装/卸载等运维操作。</div>
      </div>
      <div class="wm-card-tools">
        <span class="pill xs ghost">{{ nodes|length }} 台</span>
      </div>
    </div>

    {% if nodes %}
      <div class="wm-node-list">
        {% for n in nodes %}
          {% set caps = namespace(list=[]) %}
          {% if n.capabilities %}
            {% for k, v in n.capabilities.items() %}
              {% if v %}{% set caps.list = caps.list + [k] %}{% endif %}
            {% endfor %}
          {% endif %}

          <div class="wm-node-row">
            <div style="min-width:0;">
              <div class="wm-node-name">{{ n.name }}</div>
              <div class="wm-node-url mono" title="{{ (n.base_url|mask_url) if n.base_url else '-' }}">{{ (n.base_url|mask_url) if n.base_url else '-' }}</div>
              <div class="wm-node-meta">根目录基准：<span class="mono">{{ n.website_root_base or '/www' }}</span></div>

              {% if caps.list %}
                <div class="wm-node-badges">
                  {% for c in caps.list[:3] %}
                    <span class="pill xs ghost">{{ c }}</span>
                  {% endfor %}
                  {% if (caps.list|length) > 3 %}
                    <span class="pill xs ghost">+{{ (caps.list|length) - 3 }}</span>
                  {% endif %}
                </div>
              {% else %}
                <div class="muted sm" style="margin-top:8px;">暂未收到能力信息，可能仍在安装中，请稍后刷新查看。</div>
              {% endif %}

              {% set et = n.latest_env_task %}
              {% if et %}
                {% set est = (et.status or '')|lower %}
                {% set ecls = 'warn' if est in ['queued','running'] else ('ok' if est in ['success','done'] else ('bad' if est in ['failed','error'] else 'ghost')) %}
                {% set etype = '安装环境' if (et.type or '') == 'website_env_ensure' else ('卸载环境' if (et.type or '') == 'website_env_uninstall' else (et.type or '环境任务')) %}
                <div class="wm-node-meta" style="margin-top:8px;">
                  最近任务：
                  <span class="pill xs {{ ecls }}">{{ etype }} · {{ est or 'unknown' }}</span>
                  <span class="muted sm">#{{ et.id }} · {{ et.progress or 0 }}%</span>
                </div>
                {% if et.error %}
                  <div class="muted sm mono" style="margin-top:6px;overflow-wrap:anywhere;" title="{{ et.error }}">{{ et.error }}</div>
                {% endif %}
              {% endif %}

              <div class="wm-node-quick">
                <form method="post" action="/websites/nodes/{{ n.id }}/env/ensure">
                  <input type="hidden" name="include_php" value="1">
                  <button class="btn xs ghost" type="submit">安装环境</button>
                </form>
                <form method="post" action="/websites/nodes/{{ n.id }}/env/uninstall" onsubmit="return confirm('确定卸载该节点的网站环境吗？');">
                  <button class="btn xs ghost" type="submit">卸载环境</button>
                </form>
              </div>
            </div>

            <div class="wm-node-actions">
              <a class="btn icon xs secondary" href="/nodes/{{ n.id }}" title="进入">↗</a>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="muted" style="margin-top:10px;">暂无网站机节点。请先在“节点管理”中接入节点并设置为网站机角色。</div>
    {% endif %}
  </aside>

</div>

<div id="wmFavoriteModal" class="modal" style="display:none;">
  <div class="modal-inner modal-pro wm-favorite-modal-inner">
    <div class="modal-head">
      <div class="title-wrap">
        <div class="h2" id="wmFavoriteTitle">收藏项</div>
        <div class="muted sm" id="wmFavoriteSub">弹窗内直接管理文件或目录</div>
      </div>
      <div class="row" style="gap:8px;">
        <a class="btn xs ghost" id="wmFavoriteOpenPage" href="#" target="_blank" rel="noopener">新窗口</a>
        <button class="btn xs ghost" type="button" id="wmFavoriteCloseTop">关闭</button>
      </div>
    </div>
    <div class="modal-body wm-favorite-modal-body">
      <iframe id="wmFavoriteFrame" class="wm-favorite-frame" src="about:blank" loading="lazy"></iframe>
    </div>
  </div>
</div>

<div id="wmCreateModal" class="modal wm-create-modal" style="display:none;" data-auto-open="{{ 1 if open_create else 0 }}">
  <div class="modal-inner modal-pro wm-create-inner">
    <div class="modal-head wm-create-head">
      <div class="title-wrap">
        <div class="h2">新建站点</div>
        <div class="muted sm">完成节点选择、入口定义与发布参数配置，提交后自动执行环境校验与健康探测。</div>
      </div>
      <button class="btn xs ghost" type="button" data-action="close-site-create">关闭</button>
    </div>

    <div class="modal-body wm-create-body">
      <form method="post" action="/websites/new" class="form" id="wmCreateForm">
        <div class="form-section wm-create-section">
          <div class="section-head">
            <div>
              <div class="section-title">基础信息</div>
              <div class="section-sub">站点名称仅用于面板展示，部署策略由下方入口配置决定。</div>
            </div>
          </div>

          <div class="form-grid wm-create-grid">
            <div class="col">
              <label class="label">网站机节点</label>
              <select class="select" name="node_id" required>
                {% for n in nodes %}
                  <option value="{{ n.id }}">{{ n.name }} · {{ (n.base_url|mask_url) if n.base_url else '-' }}</option>
                {% endfor %}
              </select>
              {% if not nodes %}
                <div class="help" style="color:var(--bad);">暂无网站机节点，请先在节点管理中启用网站机角色。</div>
              {% endif %}
            </div>

            <div class="col">
              <label class="label">站点名称（可选）</label>
              <input class="input" name="name" placeholder="例如：官网 / 商城 / 客户A" />
              <div class="help">留空时默认使用主域名作为站点名称。</div>
            </div>
          </div>
        </div>

        <div class="form-section wm-create-section">
          <div class="section-head">
            <div>
              <div class="section-title">入口与类型</div>
              <div class="section-sub">先定义访问入口（域名）与服务模式，反向代理目标按类型自动显隐。</div>
            </div>
          </div>

          <div class="form-grid wm-create-grid">
            <div class="col" style="grid-column:1 / -1;">
              <label class="label">域名（支持多个）</label>
              <input class="input" name="domains" placeholder="example.com, www.example.com" required />
              <div class="help">多个域名可用逗号、分号或空格分隔，建议将主域名放在第一位。</div>
            </div>

            <div class="col">
              <label class="label">站点类型</label>
              <select class="select" name="site_type" id="wmCreateType">
                <option value="static">静态站点</option>
                <option value="php">PHP 站点</option>
                <option value="reverse_proxy">反向代理</option>
              </select>
            </div>

            <div class="col" id="wmCreateProxyRow">
              <label class="label">反向代理目标</label>
              <input class="input" id="wmCreateProxyInput" name="proxy_target" placeholder="127.0.0.1:8080 或 https://upstream.example.com" />
              <div class="help">仅反向代理模式需要填写，支持主机端口或完整 URL。</div>
            </div>
          </div>
        </div>

        <details class="advanced-details" id="wmCreateAdvanced">
          <summary>
            <div class="adv-summary-left">
              <div class="adv-title">高级选项</div>
              <div class="adv-hint">运行配置与 Nginx 模板扩展</div>
            </div>
            <div class="adv-summary-right">
              <span class="pill xs ghost">可选</span>
            </div>
          </summary>

          <div class="adv-body">
            <div class="adv-grid">
              <div class="col">
                <label class="label">Web 服务栈</label>
                <select class="select" name="web_server">
                  <option value="nginx">nginx</option>
                </select>
                <div class="help">当前发布链路已针对 nginx 做稳定性优化。</div>
              </div>

              <div class="col" id="wmCreateRootRow">
                <label class="label">站点根目录</label>
                <input class="input" name="root_path" placeholder="默认：/www/wwwroot/<domain>" />
                <div class="help">静态/PHP 推荐显式指定；反向代理留空也可自动创建验证目录。</div>
              </div>
            </div>

            <div class="row" style="gap:14px; flex-wrap:wrap;">
              <label class="help"><input type="checkbox" name="https_redirect" style="transform:translateY(1px);"> 证书签发后自动强制 HTTPS</label>
              <label class="help"><input type="checkbox" name="gzip_enabled" checked style="transform:translateY(1px);"> 启用 Gzip 压缩</label>
            </div>

            <div>
              <label class="label">自定义 Nginx 模板（可选）</label>
              <textarea class="textarea mono" name="nginx_tpl" rows="12" placeholder="# 留空则使用内置模板"></textarea>
              <div class="help compact">
                可用变量：<span class="mono">{{'{{'}}SERVER_NAME{{'}}'}}</span>、<span class="mono">{{'{{'}}ROOT_PATH{{'}}'}}</span>、<span class="mono">{{'{{'}}PROXY_TARGET{{'}}'}}</span>、<span class="mono">{{'{{'}}SSL_CERT{{'}}'}}</span>、<span class="mono">{{'{{'}}SSL_KEY{{'}}'}}</span>、<span class="mono">{{'{{'}}GZIP_CONF{{'}}'}}</span>。
              </div>
            </div>
          </div>
        </details>

        <div class="wm-create-actions">
          <button class="btn sm ghost" type="button" data-action="close-site-create">取消</button>
          <button class="btn sm" id="wmCreateSubmit" type="submit" {% if not nodes %}disabled{% endif %}>创建并部署</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  var grid = document.getElementById('wmFavGrid');
  var countEl = document.getElementById('wmFavCount');
  var favModal = document.getElementById('wmFavoriteModal');
  var favFrame = document.getElementById('wmFavoriteFrame');
  var favTitle = document.getElementById('wmFavoriteTitle');
  var favSub = document.getElementById('wmFavoriteSub');
  var favOpenPage = document.getElementById('wmFavoriteOpenPage');
  var favCloseTop = document.getElementById('wmFavoriteCloseTop');

  function favItems(){
    if(!grid) return [];
    return Array.from(grid.querySelectorAll('.wm-fav-item'));
  }

  function syncFavCount(){
    var n = favItems().length;
    if(countEl){
      countEl.textContent = String(n) + ' 项';
    }
    var empty = document.getElementById('wmFavEmpty');
    if(n <= 0){
      if(!empty && grid){
        empty = document.createElement('div');
        empty.className = 'wm-fav-empty';
        empty.id = 'wmFavEmpty';
        empty.textContent = '暂未收藏文件或目录。可在文件管理里点击“☆/★”收藏常用项。';
        grid.appendChild(empty);
      }
    }else if(empty && empty.parentNode){
      empty.parentNode.removeChild(empty);
    }
  }

  function favUrl(siteId, path, type, modal){
    var sid = parseInt(siteId || 0, 10) || 0;
    var p = String(path || '');
    var t = String(type || 'file');
    var base = t === 'dir'
      ? '/websites/' + sid + '/files?path=' + encodeURIComponent(p)
      : '/websites/' + sid + '/files/edit?path=' + encodeURIComponent(p);
    if(!modal){
      return base;
    }
    return base + '&modal=1';
  }

  function findFavCard(siteId, path){
    var sid = parseInt(siteId || 0, 10) || 0;
    var p = String(path || '').replace(/^\/+/, '').trim();
    if(!sid || !p){
      return null;
    }
    var list = favItems();
    for(var i=0; i<list.length; i++){
      var it = list[i];
      var csid = parseInt(it.getAttribute('data-site-id') || '0', 10) || 0;
      var cp = String(it.getAttribute('data-path') || '').replace(/^\/+/, '').trim();
      if(csid === sid && cp === p){
        return it;
      }
    }
    return null;
  }

  function removeFavCard(siteId, path){
    var card = findFavCard(siteId, path);
    if(card && card.parentNode){
      card.parentNode.removeChild(card);
      syncFavCount();
    }
  }

  function siteMetaById(siteId){
    var sid = parseInt(siteId || 0, 10) || 0;
    if(!sid){
      return {siteName:'', siteDomain:''};
    }
    var row = document.querySelector('.wm-site-row[data-site-id="' + sid + '"]');
    if(!row){
      return {siteName:'', siteDomain:''};
    }
    return {
      siteName: String(row.getAttribute('data-site-name') || '').trim(),
      siteDomain: String(row.getAttribute('data-site-domain') || '').trim()
    };
  }

  function makeFavCard(data){
    var sid = parseInt(data && data.siteId || 0, 10) || 0;
    var path = String(data && data.path || '').replace(/^\/+/, '').trim();
    var isDir = !!(data && data.isDir);
    var type = isDir ? 'dir' : 'file';
    var name = String(data && data.name || path.split('/').pop() || path);
    var siteName = String(data && data.siteName || ('站点#' + sid));
    var siteDomain = String(data && data.siteDomain || '');

    var card = document.createElement('div');
    card.className = 'wm-fav-item';
    card.setAttribute('data-site-id', String(sid));
    card.setAttribute('data-path', path);
    card.setAttribute('data-type', type);
    card.setAttribute('data-name', name);

    var main = document.createElement('button');
    main.className = 'wm-fav-main';
    main.type = 'button';
    main.setAttribute('data-action', 'open-favorite');

    var top = document.createElement('div');
    top.className = 'wm-fav-main-top';

    var star = document.createElement('span');
    star.className = 'wm-fav-star';
    star.textContent = '★';
    top.appendChild(star);

    var nameEl = document.createElement('span');
    nameEl.className = 'wm-fav-name';
    nameEl.title = name;
    nameEl.textContent = name;
    top.appendChild(nameEl);

    var badge = document.createElement('span');
    badge.className = 'pill xs ghost';
    badge.textContent = isDir ? '目录' : '文件';
    top.appendChild(badge);

    var pathEl = document.createElement('div');
    pathEl.className = 'wm-fav-path mono';
    pathEl.title = path;
    pathEl.textContent = path;

    var meta = document.createElement('div');
    meta.className = 'wm-fav-meta';
    var siteNameEl = document.createElement('span');
    siteNameEl.textContent = siteName;
    meta.appendChild(siteNameEl);
    if(siteDomain){
      var siteDomainEl = document.createElement('span');
      siteDomainEl.className = 'mono';
      siteDomainEl.textContent = siteDomain;
      meta.appendChild(siteDomainEl);
    }

    main.appendChild(top);
    main.appendChild(pathEl);
    main.appendChild(meta);

    var actions = document.createElement('div');
    actions.className = 'wm-fav-actions';
    var openBtn = document.createElement('button');
    openBtn.className = 'btn xs ghost';
    openBtn.type = 'button';
    openBtn.setAttribute('data-action', 'open-favorite');
    openBtn.textContent = '打开';
    actions.appendChild(openBtn);
    var unstarBtn = document.createElement('button');
    unstarBtn.className = 'btn xs ghost wm-fav-unstar';
    unstarBtn.type = 'button';
    unstarBtn.setAttribute('data-action', 'unstar-favorite');
    unstarBtn.textContent = '取消收藏';
    actions.appendChild(unstarBtn);

    card.appendChild(main);
    card.appendChild(actions);
    return card;
  }

  function upsertFavCard(data){
    if(!grid) return;
    var sid = parseInt(data && data.siteId || 0, 10) || 0;
    var path = String(data && data.path || '').replace(/^\/+/, '').trim();
    if(!sid || !path){
      return;
    }
    var old = findFavCard(sid, path);
    if(old && old.parentNode){
      old.parentNode.removeChild(old);
    }
    var card = makeFavCard(data || {});
    var first = grid.querySelector('.wm-fav-item');
    if(first){
      grid.insertBefore(card, first);
    }else{
      grid.appendChild(card);
    }
    syncFavCount();
  }

  function openFavorite(card){
    if(!card || !favModal || !favFrame) return;
    var siteId = parseInt(card.getAttribute('data-site-id') || '0', 10) || 0;
    var path = String(card.getAttribute('data-path') || '').replace(/^\/+/, '').trim();
    var type = String(card.getAttribute('data-type') || 'file').trim().toLowerCase();
    var name = String(card.getAttribute('data-name') || path.split('/').pop() || path);
    if(siteId <= 0 || !path){
      return;
    }
    var modalUrl = favUrl(siteId, path, type, true);
    var fullUrl = favUrl(siteId, path, type, false);
    favFrame.src = modalUrl;
    if(favOpenPage){
      favOpenPage.href = fullUrl;
    }
    if(favTitle){
      favTitle.textContent = (type === 'dir' ? '目录管理' : '文件编辑') + ' · ' + name;
    }
    if(favSub){
      favSub.textContent = path;
    }
    favModal.style.display = 'flex';
    document.body.classList.add('modal-open');
  }

  function closeFavorite(){
    if(!favModal) return;
    favModal.style.display = 'none';
    if(favFrame){
      favFrame.src = 'about:blank';
    }
    var createModal = document.getElementById('wmCreateModal');
    if(!(createModal && createModal.style.display !== 'none')){
      document.body.classList.remove('modal-open');
    }
  }

  async function unstarFavorite(card){
    if(!card) return;
    var siteId = parseInt(card.getAttribute('data-site-id') || '0', 10) || 0;
    var path = String(card.getAttribute('data-path') || '').replace(/^\/+/, '').trim();
    var type = String(card.getAttribute('data-type') || 'file').trim().toLowerCase();
    if(siteId <= 0 || !path){
      return;
    }
    var btn = card.querySelector('[data-action="unstar-favorite"]');
    if(btn) btn.disabled = true;
    try{
      var resp = await fetch('/websites/' + siteId + '/files/favorite', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify({path: path, type: type, favorite: false})
      });
      var data = await resp.json().catch(function(){ return {ok:false,error:'取消收藏失败'}; });
      if(!data.ok){
        throw new Error(data.error || '取消收藏失败');
      }
      removeFavCard(siteId, path);
    }catch(err){
      alert(String(err));
      if(btn) btn.disabled = false;
    }
  }

  grid?.addEventListener('click', function(e){
    var trigger = e.target && e.target.closest ? e.target.closest('[data-action]') : null;
    if(!trigger) return;
    var action = String(trigger.getAttribute('data-action') || '');
    var card = trigger.closest('.wm-fav-item');
    if(!card) return;
    if(action === 'open-favorite'){
      e.preventDefault();
      openFavorite(card);
      return;
    }
    if(action === 'unstar-favorite'){
      e.preventDefault();
      unstarFavorite(card);
    }
  });

  favCloseTop?.addEventListener('click', closeFavorite);
  favModal?.addEventListener('click', function(e){
    if(e.target === favModal){
      closeFavorite();
    }
  });

  window.addEventListener('message', function(e){
    if(e.origin !== window.location.origin){
      return;
    }
    var data = e.data || {};
    if(data.type !== 'nexus-file-favorite-updated'){
      return;
    }
    var sid = parseInt(data.siteId || 0, 10) || 0;
    var p = String(data.path || '').replace(/^\/+/, '').trim();
    if(!sid || !p) return;
    if(data.favorite === false){
      removeFavCard(sid, p);
      return;
    }
    if(data.favorite === true){
      var meta = siteMetaById(sid);
      upsertFavCard({
        siteId: sid,
        siteName: String(data.siteName || meta.siteName || ('站点#' + sid)),
        siteDomain: String(data.siteDomain || meta.siteDomain || ''),
        path: p,
        name: String(data.name || p.split('/').pop() || p),
        isDir: !!data.isDir
      });
    }
  });

  document.addEventListener('keydown', function(e){
    if(e.key === 'Escape' && favModal && favModal.style.display !== 'none'){
      closeFavorite();
    }
  });

  syncFavCount();
})();
</script>

<script>
(function(){
  var modal = document.getElementById('wmCreateModal');
  if(!modal) return;

  var openBtns = Array.from(document.querySelectorAll('[data-action="open-site-create"]'));
  var closeBtns = Array.from(modal.querySelectorAll('[data-action="close-site-create"]'));
  var siteType = document.getElementById('wmCreateType');
  var proxyRow = document.getElementById('wmCreateProxyRow');
  var proxyInput = document.getElementById('wmCreateProxyInput');

  function isOpen(){
    return modal.style.display !== 'none';
  }

  function syncType(){
    var t = (siteType && siteType.value) || 'static';
    var showProxy = t === 'reverse_proxy';
    if(proxyRow){
      proxyRow.style.display = showProxy ? 'block' : 'none';
      proxyRow.setAttribute('aria-hidden', showProxy ? 'false' : 'true');
    }
    if(proxyInput) proxyInput.required = !!showProxy;
  }

  function openModal(){
    modal.style.display = 'flex';
    document.body.classList.add('modal-open');
    syncType();
    try{
      var first = modal.querySelector('select[name="node_id"], input[name="domains"]');
      if(first) first.focus();
    }catch(_e){}
  }

  function closeModal(){
    modal.style.display = 'none';
    var favModal = document.getElementById('wmFavoriteModal');
    if(!(favModal && favModal.style.display !== 'none')){
      document.body.classList.remove('modal-open');
    }
  }

  openBtns.forEach(function(btn){
    btn.addEventListener('click', function(){
      if(btn.disabled) return;
      openModal();
    });
  });

  closeBtns.forEach(function(btn){
    btn.addEventListener('click', closeModal);
  });

  if(siteType){
    siteType.addEventListener('change', syncType);
  }

  modal.addEventListener('click', function(e){
    if(e.target === modal) closeModal();
  });

  document.addEventListener('keydown', function(e){
    if(e.key === 'Escape' && isOpen()) closeModal();
  });

  if(String(modal.getAttribute('data-auto-open') || '') === '1'){
    openModal();
  }else{
    syncType();
  }
})();
</script>

{% endblock %}
