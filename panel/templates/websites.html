{% extends "base.html" %}
{% block content %}

{# ---- Stats ---- #}
{% set stats = namespace(running=0, creating=0, error=0, health_fail=0) %}
{% for s in sites %}
  {% if (s.status or '') == 'running' %}
    {% set stats.running = stats.running + 1 %}
  {% elif (s.status or '') in ['creating','pending'] %}
    {% set stats.creating = stats.creating + 1 %}
  {% elif (s.status or '') == 'error' %}
    {% set stats.error = stats.error + 1 %}
  {% endif %}
  {% if (s.health_status or '') == 'fail' %}
    {% set stats.health_fail = stats.health_fail + 1 %}
  {% endif %}
{% endfor %}

<div class="page-head">
  <div class="page-title">
    <h1 class="h1">网站管理</h1>
    <div class="meta">
      <span class="meta-item">站点部署 / SSL / 监测 / 文件，一处集中管理。</span>
      <span class="meta-item">· 站点 <strong>{{ sites|length }}</strong></span>
      <span class="meta-item">· 网站机 <strong>{{ nodes|length }}</strong></span>
    </div>
  </div>
  <div class="right">
    <a class="btn sm" href="/websites/new">新建站点</a>
  </div>
</div>

{# ---- Main layout ---- #}
<div class="wm-layout">

  <section class="card wm-card">
    <div class="wm-card-head">
      <div>
        <div class="wm-card-title">站点</div>
        <div class="wm-card-sub">管理部署 / SSL / 监测与文件。</div>
      </div>
      <div class="wm-card-tools">
        <span class="pill xs ghost">共 {{ sites|length }} 个</span>
      </div>
    </div>

    {% if sites %}
      <div class="wm-toolbar" id="wmToolbar">
        <div class="dash-filters" id="wmSiteFilters" role="tablist" aria-label="站点筛选">
          <button class="chip active" type="button" data-status="all" aria-selected="true">全部 <strong>{{ sites|length }}</strong></button>
          <button class="chip" type="button" data-status="running">运行 <strong>{{ stats.running }}</strong></button>
          <button class="chip" type="button" data-status="creating">创建 <strong>{{ stats.creating }}</strong></button>
          <button class="chip" type="button" data-status="error">异常 <strong>{{ stats.error }}</strong></button>
          <button class="chip" type="button" id="wmHealthFailChip" data-health="fail">健康异常 <strong>{{ stats.health_fail }}</strong></button>
        </div>

        <div class="dash-search" role="search">
          <span class="dash-search-ico" aria-hidden="true">⌕</span>
          <input id="wmSiteSearch" class="dash-search-input" placeholder="搜索站点 / 域名 / 节点" autocomplete="off" />
          <button id="wmSiteSearchClear" class="dash-search-clear" type="button" title="清空">×</button>
        </div>
      </div>

      <div class="wm-countline">
        显示 <strong><span id="wmSiteCount">{{ sites|length }}</span></strong> / <strong>{{ sites|length }}</strong>
      </div>

      <div class="wm-sites" id="wmSiteGrid" style="margin-top:10px;">
        {% for s in sites %}
          {% set st = (s.status or '') %}
          {% set st_norm = 'creating' if st in ['creating','pending'] else st %}
          {% set st_class = 'ok' if st == 'running' else ('warn' if st in ['creating','pending'] else ('bad' if st == 'error' else 'ghost')) %}
          {% set type_map = {'static':'静态', 'php':'PHP', 'reverse_proxy':'反向代理'} %}
          {% set h = (s.health_status or '') %}
          {% set hcls = 'ok' if h == 'ok' else ('bad' if h == 'fail' else 'ghost') %}
          {% set domains = s.domains or [] %}
          {% set primary_domain = domains[0] if domains else '-' %}
          {% set extra = (domains|length - 1) %}

          <div class="wm-site-row"
               data-name="{{ (s.name or '')|lower }}"
               data-domains="{{ (s.domains_text or '')|lower }}"
               data-node="{{ (s.node.name if s.node else '-')|lower }}"
               data-status="{{ st_norm }}"
               data-health="{{ h }}">
            <div class="wm-site-left">
              <div class="wm-site-line1">
                <div class="wm-site-name" title="{{ s.name }}">{{ s.name }}</div>
                <span class="pill xs {{ st_class }}" title="运行状态">{{ st or 'unknown' }}</span>
                <span class="pill xs {{ hcls }}" title="健康状态">{{ h or 'unknown' }}</span>
              </div>

              <div class="wm-site-line2">
                <span class="mono wm-site-domain" title="{{ s.domains_text }}">
                  {{ primary_domain }}{% if extra > 0 %}<span class="muted"> · +{{ extra }}</span>{% endif %}
                </span>
                <span class="wm-site-hint">· {{ type_map.get(s.type, s.type) }}</span>
                {% if s.node %}<span class="wm-site-hint">· {{ s.node.name }}</span>{% endif %}
              </div>
            </div>

            <div class="wm-site-right">
              <div class="wm-site-kpis mono">
                <span class="wm-kpi">HTTP {{ s.health_code or '-' }}</span>
                <span class="wm-kpi">{{ s.health_latency_ms or 0 }}ms</span>
                <span class="wm-kpi">{{ s.health_checked_at or '-' }}</span>
              </div>

              <div class="wm-site-actions">
                <a class="btn icon xs secondary" href="/websites/{{ s.id }}" title="进入">↗</a>
                <details class="menu">
                  <summary class="btn icon xs ghost" title="更多">⋯</summary>
                  <div class="menu-pop">
                    <a class="menu-item" href="/websites/{{ s.id }}/edit">编辑</a>
                    <a class="menu-item" href="/websites/{{ s.id }}/diagnose">诊断</a>
                    {% if s.type != 'reverse_proxy' and s.root_path %}
                      <a class="menu-item" href="/websites/{{ s.id }}/files">文件管理</a>
                    {% endif %}
                  </div>
                </details>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <script>
  (function(){
    var input = document.getElementById('wmSiteSearch');
    var clearBtn = document.getElementById('wmSiteSearchClear');
    var grid = document.getElementById('wmSiteGrid');
    var countEl = document.getElementById('wmSiteCount');
    var chips = Array.from(document.querySelectorAll('#wmSiteFilters button.chip[data-status]'));
    var healthChip = document.getElementById('wmHealthFailChip');
    if(!grid) return;

    var tiles = Array.from(grid.querySelectorAll('.wm-site-row'));
    var state = { status: 'all', healthFail: false };

    function apply(){
      var q = (input && input.value || '').trim().toLowerCase();
      var shown = 0;
      tiles.forEach(function(t){
        var hay = (t.dataset.name||'') + ' ' + (t.dataset.domains||'') + ' ' + (t.dataset.node||'');
        var ok = (!q) || hay.indexOf(q) !== -1;
        if(state.status && state.status !== 'all'){
          ok = ok && (t.dataset.status === state.status);
        }
        if(state.healthFail){
          ok = ok && (t.dataset.health === 'fail');
        }
        t.style.display = ok ? '' : 'none';
        if(ok) shown++;
      });

      if(countEl) countEl.textContent = String(shown);
      if(clearBtn) clearBtn.style.visibility = q ? 'visible' : 'hidden';
    }

    if(input) input.addEventListener('input', apply);
    if(clearBtn) clearBtn.addEventListener('click', function(){ if(input) input.value=''; apply(); });

    chips.forEach(function(chip){
      chip.addEventListener('click', function(){
        var st = chip.getAttribute('data-status') || 'all';
        state.status = st;
        chips.forEach(function(c){
          var on = (c.getAttribute('data-status') || 'all') === st;
          c.classList.toggle('active', on);
          c.setAttribute('aria-selected', on ? 'true' : 'false');
        });
        apply();
      });
    });

    if(healthChip){
      healthChip.addEventListener('click', function(){
        state.healthFail = !state.healthFail;
        healthChip.classList.toggle('active', state.healthFail);
        healthChip.setAttribute('aria-selected', state.healthFail ? 'true' : 'false');
        apply();
      });
    }

    apply();
  })();
      </script>
    {% else %}
      <div class="muted" style="margin-top:10px;">还没有站点。点击右上角“新建站点”开始部署。</div>
      <div class="row" style="margin-top:12px;">
        <a class="btn" href="/websites/new">新建站点</a>
      </div>
    {% endif %}
  </section>

  <aside class="card wm-card">
    <div class="wm-card-head">
      <div>
        <div class="wm-card-title">网站机节点</div>
        <div class="wm-card-sub">环境信息与快速操作（更完整能力可在节点详情页处理）。</div>
      </div>
      <div class="wm-card-tools">
        <span class="pill xs ghost">{{ nodes|length }} 台</span>
      </div>
    </div>

    {% if nodes %}
      <div class="wm-node-list">
        {% for n in nodes %}
          {% set caps = namespace(list=[]) %}
          {% if n.capabilities %}
            {% for k, v in n.capabilities.items() %}
              {% if v %}{% set caps.list = caps.list + [k] %}{% endif %}
            {% endfor %}
          {% endif %}

          <div class="wm-node-row">
            <div style="min-width:0;">
              <div class="wm-node-name">{{ n.name }}</div>
              <div class="wm-node-url mono" title="{{ n.base_url }}">{{ n.base_url }}</div>
              <div class="wm-node-meta">根目录基准：<span class="mono">{{ n.website_root_base or '/www' }}</span></div>

              {% if caps.list %}
                <div class="wm-node-badges">
                  {% for c in caps.list[:3] %}
                    <span class="pill xs ghost">{{ c }}</span>
                  {% endfor %}
                  {% if (caps.list|length) > 3 %}
                    <span class="pill xs ghost">+{{ (caps.list|length) - 3 }}</span>
                  {% endif %}
                </div>
              {% else %}
                <div class="muted sm" style="margin-top:8px;">能力信息未上报或未安装环境。</div>
              {% endif %}

              <div class="wm-node-quick">
                <form method="post" action="/websites/nodes/{{ n.id }}/env/ensure">
                  <input type="hidden" name="include_php" value="1">
                  <button class="btn xs ghost" type="submit">安装环境</button>
                </form>
                <form method="post" action="/websites/nodes/{{ n.id }}/env/uninstall" onsubmit="return confirm('确定卸载该节点的网站环境吗？');">
                  <button class="btn xs ghost" type="submit">卸载环境</button>
                </form>
              </div>
            </div>

            <div class="wm-node-actions">
              <a class="btn icon xs secondary" href="/nodes/{{ n.id }}" title="进入">↗</a>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="muted" style="margin-top:10px;">暂无网站机节点。请先在“节点管理”中接入并设置为网站机角色。</div>
    {% endif %}
  </aside>

</div>

{% endblock %}
