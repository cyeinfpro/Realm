{% extends "base.html" %}
{% block content %}
{% set stats = namespace(running=0, creating=0, error=0, health_fail=0) %}
{% for s in sites %}
  {% if (s.status or '') == 'running' %}
    {% set stats.running = stats.running + 1 %}
  {% elif (s.status or '') in ['creating','pending'] %}
    {% set stats.creating = stats.creating + 1 %}
  {% elif (s.status or '') == 'error' %}
    {% set stats.error = stats.error + 1 %}
  {% endif %}
  {% if (s.health_status or '') == 'fail' %}
    {% set stats.health_fail = stats.health_fail + 1 %}
  {% endif %}
{% endfor %}

<div class="hero-card">
  <div class="hero-left">
    <span class="pill xs ghost">Website Ops</span>
    <div class="hero-title">网站管理中心</div>
    <div class="hero-sub">统一管理网站机、站点运行与证书。更清晰的状态、路径与操作入口。</div>
    <div class="hero-metrics">
      <span class="pill">站点 {{ sites|length }}</span>
      <span class="pill">网站机 {{ nodes|length }}</span>
      <span class="pill ok">运行 {{ stats.running }}</span>
      <span class="pill warn">处理中 {{ stats.creating }}</span>
      <span class="pill bad">异常 {{ stats.error }}</span>
      <span class="pill bad">健康异常 {{ stats.health_fail }}</span>
    </div>
  </div>
  <div class="hero-right">
    <a class="btn sm" href="/websites/new">新建站点</a>
    <a class="btn sm ghost" href="/nodes">节点管理</a>
  </div>
</div>

<div class="websites-layout">
  <div class="card">
    <div class="section-head">
      <div>
        <div class="section-title">站点总览</div>
        <div class="section-sub">域名、健康状态与管理入口。</div>
      </div>
      <div class="muted sm">{{ sites|length }} 个</div>
    </div>
    {% if sites %}
    <div class="site-list">
      {% for s in sites %}
      {% set st = (s.status or '') %}
      {% set st_class = 'ok' if st == 'running' else ('warn' if st in ['creating','pending'] else ('bad' if st == 'error' else 'ghost')) %}
      {% set type_map = {'static':'静态', 'php':'PHP', 'reverse_proxy':'反向代理'} %}
      {% set h = (s.health_status or '') %}
      {% set hcls = 'ok' if h == 'ok' else ('bad' if h == 'fail' else 'ghost') %}
      <div class="site-row">
        <div class="site-main">
          <div class="site-title">{{ s.name }}</div>
          <div class="site-domains mono">{{ s.domains_text }}</div>
          <div class="site-meta">
            <span class="pill xs {{ st_class }}">{{ st or 'unknown' }}</span>
            <span class="pill xs {{ hcls }}">{{ h or 'unknown' }}</span>
            <span class="pill xs ghost">{{ type_map.get(s.type, s.type) }}</span>
            <span class="pill xs ghost">{{ s.web_server }}</span>
          </div>
        </div>
        <div class="site-side">
          <div class="site-node">节点：{{ s.node.name if s.node else '-' }}</div>
          <div class="site-id muted sm">ID #{{ s.id }}</div>
          <div class="site-actions">
            <a class="btn xs" href="/websites/{{ s.id }}">管理</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
      <div class="muted">暂无站点</div>
    {% endif %}
  </div>

  <div class="card">
    <div class="section-head">
      <div>
        <div class="section-title">网站机节点</div>
        <div class="section-sub">环境状态与安装操作。</div>
      </div>
      <div class="muted sm">{{ nodes|length }} 台</div>
    </div>
    {% if nodes %}
      <div class="node-list">
        {% for n in nodes %}
        <div class="node-card">
          <div class="node-head">
            <div>
              <div class="node-title">{{ n.name }}</div>
              <div class="node-sub mono">{{ n.base_url }}</div>
              <div class="node-sub">根目录基准：<span class="mono">{{ n.website_root_base or '/www' }}</span></div>
            </div>
            <div>
              <a class="btn xs ghost" href="/nodes/{{ n.id }}">节点详情</a>
            </div>
          </div>
          {% if n.capabilities %}
            <div class="pill-group">
              {% for k, v in n.capabilities.items() %}
                {% if v %}
                  <span class="pill xs ghost">{{ k }}</span>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
          <div class="node-actions">
            <form method="post" action="/websites/nodes/{{ n.id }}/env/ensure" class="toolbar">
              <label class="help"><input type="checkbox" name="include_php" checked style="transform:translateY(1px);"> 含 PHP</label>
              <button class="btn xs secondary" type="submit">安装环境</button>
            </form>
            <form method="post" action="/websites/nodes/{{ n.id }}/env/uninstall" class="toolbar" onsubmit="return confirm('确定卸载该节点的网站环境吗？');">
              <label class="help"><input type="checkbox" name="purge_data" style="transform:translateY(1px);"> 删除网站数据</label>
              <label class="help"><input type="checkbox" name="deep_uninstall" style="transform:translateY(1px);"> 深度卸载</label>
              <button class="btn xs ghost" type="submit">卸载环境</button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="muted">暂无网站机节点，请先在接入节点时勾选“网站机”。</div>
    {% endif %}
  </div>
</div>
{% endblock %}
