{% extends "base.html" %}
{% block content %}
{% set st = (site.status or '') %}
{% set st_class = 'ok' if st == 'running' else ('warn' if st in ['creating','pending'] else ('bad' if st == 'error' else 'ghost')) %}
{% set type_map = {'static':'静态', 'php':'PHP', 'reverse_proxy':'反向代理'} %}
{% set h = (site.health_status or '') %}
{% set hclass = 'ok' if h == 'ok' else ('bad' if h == 'fail' else 'ghost') %}
{% set ssl = namespace(has_any=false, has_valid=false) %}
{% for c in certs %}
  {% set ssl.has_any = true %}
  {% if (c.status or '') == 'valid' %}
    {% set ssl.has_valid = true %}
  {% endif %}
{% endfor %}

<div class="hero-card">
  <div class="hero-left">
    <span class="pill xs ghost">Site</span>
    <div class="hero-title">{{ site.name }}</div>
    <div class="hero-sub">节点：{{ node.name if node else "-" }} · 域名：<span class="mono">{{ (site.domains or [])|join(', ') }}</span></div>
    <div class="hero-metrics">
      <span class="pill xs {{ st_class }}">{{ st or 'unknown' }}</span>
      <span class="pill xs {{ hclass }}">{{ h or 'unknown' }}</span>
      <span class="pill xs ghost">{{ type_map.get(site.type, site.type) }}</span>
      <span class="pill xs ghost">{{ site.web_server }}</span>
    </div>
  </div>
  <div class="hero-right">
    <a class="btn sm ghost" href="/websites">返回管理</a>
  </div>
</div>

<div class="site-detail-grid">
  <div class="site-col">
    <div class="card action-card">
      <div class="section-head">
        <div>
          <div class="section-title">快速操作</div>
          <div class="section-sub">常用入口已精简。</div>
        </div>
      </div>
      <div class="action-grid">
        <a class="btn sm secondary" href="/websites/{{ site.id }}/files">文件管理</a>
        <a class="btn sm ghost" href="/websites/{{ site.id }}/diagnose">诊断</a>
        <a class="btn sm ghost" href="/websites/{{ site.id }}/edit">编辑站点</a>
        {% if not ssl.has_any %}
          <form method="post" action="/websites/{{ site.id }}/ssl/issue">
            <button class="btn sm" type="submit">申请 SSL</button>
          </form>
        {% elif ssl.has_valid %}
          <form method="post" action="/websites/{{ site.id }}/ssl/renew">
            <button class="btn sm" type="submit">续期 SSL</button>
          </form>
        {% else %}
          <form method="post" action="/websites/{{ site.id }}/ssl/issue">
            <button class="btn sm" type="submit">重新申请 SSL</button>
          </form>
        {% endif %}
      </div>
      <div class="help">证书按钮会根据当前状态自动切换。</div>
    </div>

    <div class="card">
      <div class="section-head">
        <div>
          <div class="section-title">站点概览</div>
          <div class="section-sub">核心配置与运行信息。</div>
        </div>
        <span class="pill xs {{ st_class }}">{{ st or 'unknown' }}</span>
      </div>
      <div class="kv-grid" style="margin-top:10px;">
        <div class="kv-item">
          <div class="kv-label">站点类型</div>
          <div class="kv-value">{{ type_map.get(site.type, site.type) }}</div>
        </div>
        <div class="kv-item">
          <div class="kv-label">Web 服务器</div>
          <div class="kv-value">{{ site.web_server }}</div>
        </div>
        <div class="kv-item">
          <div class="kv-label">根目录</div>
          <div class="kv-value mono">{{ site.root_path or "-" }}</div>
        </div>
        <div class="kv-item">
          <div class="kv-label">反向代理</div>
          <div class="kv-value mono">{{ site.proxy_target or "-" }}</div>
        </div>
        <div class="kv-item">
          <div class="kv-label">HTTPS 跳转</div>
          <div class="kv-value">{{ "启用" if site.https_redirect else "关闭" }}</div>
        </div>
        <div class="kv-item">
          <div class="kv-label">Gzip</div>
          <div class="kv-value">{{ "启用" if site.gzip_enabled else "关闭" }}</div>
        </div>
        <div class="kv-item">
          <div class="kv-label">自定义模板</div>
          <div class="kv-value">{{ "已配置" if site.nginx_tpl else "未配置" }}</div>
        </div>
        <div class="kv-item">
          <div class="kv-label">创建时间</div>
          <div class="kv-value">{{ site.created_at }}</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-head">
        <div>
          <div class="section-title">健康监测</div>
          <div class="section-sub">最近检查与错误提示。</div>
        </div>
      </div>
      <div class="kv-grid" style="margin-top:10px;">
        <div class="kv-item">
          <div class="kv-label">当前状态</div>
          <div class="kv-value"><span class="pill xs {{ hclass }}">{{ h or 'unknown' }}</span></div>
        </div>
        <div class="kv-item">
          <div class="kv-label">延迟</div>
          <div class="kv-value">{{ site.health_latency_ms or 0 }} ms</div>
        </div>
        <div class="kv-item">
          <div class="kv-label">HTTP 状态</div>
          <div class="kv-value">{{ site.health_code or "-" }}</div>
        </div>
        <div class="kv-item">
          <div class="kv-label">最近检查</div>
          <div class="kv-value">{{ site.health_checked_at or "-" }}</div>
        </div>
        <div class="kv-item" style="grid-column:1 / -1;">
          <div class="kv-label">错误</div>
          <div class="kv-value mono">{{ site.health_error or "-" }}</div>
        </div>
      </div>
      {% if checks %}
        <div class="stack-scroll" style="margin-top:12px;">
          <div class="stack-list">
            {% for c in checks[:12] %}
              {% set ok = (c.ok or 0) %}
              <div class="stack-row">
                <span class="pill xs {{ 'ok' if ok else 'bad' }}">{{ 'ok' if ok else 'fail' }}</span>
                <div class="stack-main">
                  <span class="mono">{{ c.checked_at }}</span>
                  <span class="muted sm">HTTP {{ c.status_code or '-' }}</span>
                  <span class="muted sm">{{ c.latency_ms or 0 }} ms</span>
                </div>
              </div>
              {% if c.error %}
                <div class="stack-sub mono">{{ c.error }}</div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        {% if checks|length > 12 %}
          <div class="muted sm" style="margin-top:8px;">仅展示最近 12 条，更多请前往「诊断」。</div>
        {% endif %}
      {% else %}
        <div class="muted" style="margin-top:10px;">暂无检查记录</div>
      {% endif %}
    </div>
  </div>

  <div class="site-col">
    <div class="card">
      <div class="section-head">
        <div>
          <div class="section-title">SSL 证书</div>
          <div class="section-sub">证书状态与续期信息。</div>
        </div>
      </div>
      {% if certs %}
        <div class="stack-list" style="margin-top:10px;">
          {% for c in certs %}
            {% set cst = (c.status or '') %}
            {% set cst_class = 'ok' if cst == 'valid' else ('warn' if cst in ['pending'] else ('bad' if cst in ['failed','expired'] else 'ghost')) %}
            <div class="stack-row">
              <span class="pill xs {{ cst_class }}">{{ cst or 'unknown' }}</span>
              <div class="stack-main">
                <span class="mono">{{ c.domains_text }}</span>
                <span class="muted sm">{{ c.not_before or "-" }} → {{ c.not_after or "-" }}</span>
                <span class="muted sm">续期：{{ c.renew_at or "-" }}</span>
              </div>
            </div>
            {% if c.last_error %}
              <div class="stack-sub mono">{{ c.last_error }}</div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        <div class="muted" style="margin-top:10px;">暂无证书</div>
      {% endif %}
    </div>

    <div class="card">
      <div class="section-head">
        <div>
          <div class="section-title">变更历史</div>
          <div class="section-sub">创建、证书、健康等操作记录。</div>
        </div>
      </div>
      {% if events %}
        <div class="stack-scroll" style="margin-top:10px;">
          <div class="stack-list">
            {% for e in events[:12] %}
              {% set es = (e.status or '') %}
              {% set ecls = 'ok' if es == 'success' else ('warn' if es == 'running' else ('bad' if es in ['failed','error'] else 'ghost')) %}
              <div class="stack-row">
                <span class="pill xs {{ ecls }}">{{ es or 'unknown' }}</span>
                <div class="stack-main">
                  <span class="mono">{{ e.created_at }}</span>
                  <span class="muted sm">{{ e.action }}</span>
                  <span class="muted sm">{{ e.actor or '-' }}</span>
                </div>
              </div>
              {% if e.error %}
                <div class="stack-sub mono">{{ e.error }}</div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        {% if events|length > 12 %}
          <div class="muted sm" style="margin-top:8px;">仅展示最近 12 条。</div>
        {% endif %}
      {% else %}
        <div class="muted" style="margin-top:10px;">暂无变更记录</div>
      {% endif %}
    </div>

    <div class="card">
      <div class="section-head">
        <div>
          <div class="section-title">风险操作</div>
          <div class="section-sub">删除站点会移除面板记录，可选清理节点文件与证书。</div>
        </div>
      </div>
      <form method="post" action="/websites/{{ site.id }}/delete" class="form" onsubmit="return confirm('确定删除该站点吗？');">
        <label class="help"><input type="checkbox" name="delete_files" style="transform:translateY(1px);"> 删除站点目录数据</label>
        <label class="help"><input type="checkbox" name="delete_cert" style="transform:translateY(1px);"> 删除证书文件</label>
        <button class="btn sm danger" type="submit" style="margin-top:8px;">删除站点</button>
      </form>
    </div>
  </div>
</div>
{% endblock %}
