{% extends "base.html" %}
{% block content %}

<div class="page-head">
  <div class="page-title">
    <h1 class="h1">新建站点</h1>
    <div class="meta">
      <span class="meta-item">一次性填写核心配置。系统会先确保环境，再写入 Nginx 配置并自动验证。</span>
    </div>
    <div class="meta" style="margin-top:8px;">
      <span class="pill xs ghost">可用网站机 <strong>{{ nodes|length }}</strong></span>
      <span class="pill xs ghost">支持：静态 / PHP / 反向代理</span>
    </div>
  </div>
  <div class="right">
    <a class="btn sm ghost" href="/websites">返回管理</a>
  </div>
</div>

<div class="wizard-layout">
  <aside class="card wizard-side">
    <div class="section-head">
      <div>
        <div class="section-title">创建步骤</div>
        <div class="section-sub">建议按顺序检查每一项，避免后续 SSL/访问异常。</div>
      </div>
    </div>

    <div class="wizard-steps">
      <div class="wizard-step">
        <div class="n">1</div>
        <div>
          <div class="t">选择网站机</div>
          <div class="d">选择要部署的节点（必须为网站机角色）。</div>
        </div>
      </div>
      <div class="wizard-step">
        <div class="n">2</div>
        <div>
          <div class="t">域名与类型</div>
          <div class="d">支持多域名；反向代理必须填写目标地址。</div>
        </div>
      </div>
      <div class="wizard-step">
        <div class="n">3</div>
        <div>
          <div class="t">运行配置</div>
          <div class="d">静态/PHP 使用根目录；HTTPS 跳转会在证书就绪后生效。</div>
        </div>
      </div>
      <div class="wizard-step">
        <div class="n">4</div>
        <div>
          <div class="t">模板扩展</div>
          <div class="d">可选自定义 Nginx 模板；需自行保证 challenge 可访问。</div>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:12px;">
      <div class="panel-head">
        <div class="col">
          <div class="panel-title">小贴士</div>
          <div class="panel-sub">创建后可在站点详情页申请 SSL、查看健康状态与诊断。</div>
        </div>
      </div>
    </div>
  </aside>

  <section class="card">
    <form method="post" action="/websites/new" class="form" style="margin-top:0;">
      <div class="form-section">
        <div class="section-head">
          <div>
            <div class="section-title">步骤 1 · 选择网站机</div>
            <div class="section-sub">选择要部署站点的节点。</div>
          </div>
        </div>

        <div class="form-grid">
          <div class="col">
            <label class="label">网站机节点</label>
            <select class="select" name="node_id" required>
              {% for n in nodes %}
                <option value="{{ n.id }}">{{ n.name }} · {{ (n.base_url|mask_url) if n.base_url else '-' }}</option>
              {% endfor %}
            </select>
            {% if not nodes %}
              <div class="help" style="color:var(--bad);">暂无网站机节点，请先在接入节点时勾选“网站机”。</div>
            {% endif %}
          </div>
          <div class="col">
            <label class="label">站点名称</label>
            <input class="input" name="name" placeholder="例如：官网 / 客户A">
            <div class="help">用于面板展示，留空默认使用主域名。</div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="section-head">
          <div>
            <div class="section-title">步骤 2 · 域名与类型</div>
            <div class="section-sub">支持多域名、静态/PHP/反向代理。</div>
          </div>
        </div>
        <div class="form-grid">
          <div class="col">
            <label class="label">域名（支持多个）</label>
            <input class="input" name="domains" placeholder="example.com, www.example.com" required>
            <div class="help">多个域名用逗号或空格分隔。</div>
          </div>
          <div class="col">
            <label class="label">站点类型</label>
            <select class="select" name="site_type" id="site_type">
              <option value="static">静态站点</option>
              <option value="php">PHP 站点</option>
              <option value="reverse_proxy">反向代理</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="section-head">
          <div>
            <div class="section-title">步骤 3 · 运行配置</div>
            <div class="section-sub">目录与代理目标。反向代理会自动补全 <span class="mono">http://</span>。</div>
          </div>
        </div>
        <div class="form-grid">
          <div class="col">
            <label class="label">Web 服务器</label>
            <select class="select" name="web_server">
              <option value="nginx">nginx</option>
            </select>
          </div>
          <div class="col" id="root_row">
            <label class="label">根目录</label>
            <input class="input" name="root_path" placeholder="默认：/www/wwwroot/<domain>">
            <div class="help">静态/PHP 站点生效；反向代理可留空。</div>
          </div>
          <div class="col" id="proxy_row">
            <label class="label">反向代理目标</label>
            <input class="input" name="proxy_target" placeholder="127.0.0.1:8080 或 http://127.0.0.1:8080">
            <div class="help">仅反向代理需要填写。</div>
          </div>
        </div>
        <div class="row" style="gap:12px;margin-top:6px;flex-wrap:wrap;">
          <label class="help"><input type="checkbox" name="https_redirect" style="transform:translateY(1px);"> 证书就绪后强制 HTTPS</label>
          <label class="help"><input type="checkbox" name="gzip_enabled" checked style="transform:translateY(1px);"> 启用 Gzip</label>
        </div>
      </div>

      <div class="form-section">
        <div class="section-head">
          <div>
            <div class="section-title">步骤 4 · 模板扩展</div>
            <div class="section-sub">可选自定义 Nginx 配置模板。</div>
          </div>
        </div>
        <label class="label">自定义 Nginx 模板（可选）</label>
        <textarea class="textarea" name="nginx_tpl" rows="10" placeholder="支持变量：{{ '{{SERVER_NAME}}' }} {{ '{{ROOT_PATH}}' }} {{ '{{PROXY_TARGET}}' }} {{ '{{SSL_CERT}}' }} {{ '{{SSL_KEY}}' }} {{ '{{GZIP_CONF}}' }}"></textarea>
        <div class="help">留空则使用内置模板；自定义模板需自行处理 80/443 与 SSL。</div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="col">
          <a href="/websites" class="btn ghost">返回</a>
        </div>
        <div class="col right">
          <button class="btn" type="submit" {% if not nodes %}disabled{% endif %}>创建站点</button>
        </div>
      </div>
    </form>
  </section>
</div>

<script>
(function(){
  const sel = document.getElementById('site_type');
  const proxyRow = document.getElementById('proxy_row');
  function toggle(){
    const t = (sel && sel.value) || 'static';
    if(proxyRow){
      proxyRow.style.display = (t === 'reverse_proxy') ? '' : 'none';
    }
  }
  if(sel){
    sel.addEventListener('change', toggle);
  }
  toggle();
})();
</script>

{% endblock %}
