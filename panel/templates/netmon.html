{% extends "base.html" %}
{% block content %}
<div id="toast" class="toast" style="display:none;"></div>

<div class="page-head">
  <div class="page-title">
    <h1 class="h1">网络波动监控</h1>
    <div class="meta">
      <span class="meta-item">后台持续采集 · 打开页面可直接查看历史曲线（时间-延迟坐标图）。每个目标一张图，多节点同图对比。支持：滚轮缩放、拖拽平移、十字线对齐多节点数值、点击/双击图例控制曲线、Shift+拖拽框选缩放、底部时间导航条（mini-map）快速选窗；历史模式会出现“回到实时”按钮；双击图表可重置视图；一键导出 PNG、复制分享链接。</span>
    </div>
  </div>
  <div class="right" style="display:flex; gap:10px;">
    <button class="btn sm" type="button" id="netmonNewBtn">新建监控</button>
    <a class="btn sm secondary" href="/">返回控制台</a>
  </div>
</div>

<div class="card netmon-toolbar">
  <div class="row" style="gap:12px; flex-wrap:wrap; align-items:flex-end;">
    <div class="col" style="max-width:180px;">
      <label class="label">展示窗口</label>
      <input class="input" id="netmonViewWindow" type="number" min="1" max="1440" value="10">
      <div class="help">单位：分钟（仅影响图表展示，不影响后台采集）</div>
    </div>
    <div class="col" style="max-width:200px;">
      <label class="label">自动刷新</label>
      <select class="select" id="netmonAutoRefresh">
        <option value="on">开启（2s）</option>
        <option value="off">关闭</option>
      </select>
    </div>
    <div class="col" style="max-width:240px;">
      <label class="label">快速搜索</label>
      <input class="input" id="netmonSearch" placeholder="按目标/ID 搜索…">
      <div class="help">支持模糊匹配</div>
    </div>
    <div class="col" style="max-width:220px;">
      <label class="label">筛选</label>
      <select class="select" id="netmonFilter">
        <option value="all">全部</option>
        <option value="abnormal">仅异常（WARN/CRIT）</option>
        <option value="crit">仅严重（CRIT）</option>
        <option value="enabled">仅启用</option>
        <option value="disabled">仅停用</option>
      </select>
    </div>
    <div class="col" style="max-width:200px;">
      <button class="btn sm ghost" type="button" id="netmonRefreshBtn">立即刷新</button>
    </div>
    <div class="col" style="min-width:220px;">
      <div class="muted sm" id="netmonStatus">加载中…</div>
    </div>
  </div>
</div>

<div id="netmonCharts" class="netmon-charts"></div>

<div class="card netmon-empty" id="netmonEmpty" style="display:none;">
  <div class="card-title">暂无监控</div>
  <div class="card-sub">点击右上角「新建监控」，为某个目标配置监控节点与探测方式。</div>
</div>

<!-- Create/Edit Monitor Modal -->
<div id="netmonMonitorModal" class="modal" style="display:none;">
  <div class="modal-inner" style="max-width:720px;">
    <div class="row" style="align-items:center;">
      <div class="col"><div class="h2" id="netmonModalTitle">新建监控</div></div>
      <div class="col right"><button class="btn xs ghost" type="button" onclick="closeNetMonMonitorModal()">关闭</button></div>
    </div>

    <div class="form" style="margin-top:10px;">
      <label class="label">目标 IP / 域名</label>
      <input class="input mono" id="netmonMTarget" placeholder="例如：1.1.1.1 或 example.com 或 example.com:443">
      <div class="help">tcping 支持“host:port”；若未写端口，将使用默认端口。</div>

      <div class="row" style="gap:10px; margin-top:10px;">
        <div class="col" style="max-width:190px;">
          <label class="label">探测方式</label>
          <select class="select" id="netmonMMode">
            <option value="ping">ping（ICMP）</option>
            <option value="tcping">tcping（TCP 握手）</option>
          </select>
        </div>
        <div class="col" style="max-width:170px;" id="netmonMTcpPortBox">
          <label class="label">默认端口</label>
          <input class="input" id="netmonMTcpPort" type="number" min="1" max="65535" value="443">
        </div>
        <div class="col" style="max-width:170px;">
          <label class="label">采集间隔</label>
          <input class="input" id="netmonMInterval" type="number" min="1" max="3600" value="5">
          <div class="help">单位：秒</div>
        </div>
      </div>

      <div class="row" style="gap:10px; margin-top:10px;">
        <div class="col" style="max-width:170px;">
          <label class="label">告警阈值（Warn）</label>
          <input class="input" id="netmonMWarn" type="number" min="0" max="600000" value="0">
          <div class="help">单位：ms；0 表示关闭</div>
        </div>
        <div class="col" style="max-width:170px;">
          <label class="label">严重阈值（Crit）</label>
          <input class="input" id="netmonMCrit" type="number" min="0" max="600000" value="0">
          <div class="help">单位：ms；0 表示关闭</div>
        </div>
        <div class="col" style="flex:1;">
          <div class="help" style="margin-top:24px;">两者都设置时将自动保持 Warn ≤ Crit；图表会显示阈值线与超阈背景。</div>
        </div>
      </div>

      <div class="row" style="align-items:center; justify-content:space-between; margin-top:12px;">
        <div class="label" style="margin:0;">选择监控节点</div>
        <div class="row" style="gap:8px;">
          <button class="btn xs ghost" type="button" id="netmonMSelectAll">全选</button>
          <button class="btn xs ghost" type="button" id="netmonMSelectNone">全不选</button>
        </div>
      </div>

      <div id="netmonMNodes" class="netmon-nodes"></div>

      <div id="netmonModalError" class="muted" style="margin-top:10px; color:var(--bad);"></div>
      <div class="row" style="gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn sm ghost" type="button" id="netmonModalCancel">取消</button>
        <button class="btn sm" type="button" id="netmonModalSubmit">保存</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="/static/app.js?v=56.0"></script>
<script>
window.__NETMON_NODE_GROUPS__ = {{ (node_groups or [])|tojson }};
window.addEventListener('DOMContentLoaded', ()=>{
  initNetMonPage();
});
</script>
{% endblock %}
