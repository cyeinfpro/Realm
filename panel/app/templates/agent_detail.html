{% extends "base.html" %}
{% set header_title = 'Agent：' ~ agent.name %}

{% block top_actions %}
  <a class="btn ghost" href="/">返回</a>
  <button class="btn" id="btnAddRule">新增规则</button>
  <button class="btn ghost" id="btnApply">应用配置</button>
{% endblock %}

{% block content %}
<div id="agentPage" data-agent="{{ agent.id }}">
<div class="card" style="margin-bottom: 16px;">
  <div class="row between">
    <div>
      <div class="h2">{{ agent.name }}</div>
      <div class="muted">ID：{{ agent.id }} · API：{{ agent.api_url }}</div>
    </div>
    <div class="chip" id="agentOnline">检查中…</div>
  </div>
  <div class="hr"></div>
  <div class="row gap">
    <button class="btn ghost" id="btnRefresh">刷新状态</button>
    <button class="btn ghost" id="btnLogsRealm">查看 realm 日志</button>
    <button class="btn ghost" id="btnLogsAgent">查看 agent 日志</button>
  </div>
</div>

<div class="card">
  <div class="row between">
    <div>
      <div class="h2">规则列表</div>
      <div class="muted">支持：编辑 / 启停 / 删除 / 负载均衡 / WSS 客户端/服务端</div>
    </div>
    <div class="muted" id="ruleCount">—</div>
  </div>
  <div class="hr"></div>

  <div id="rulesWrap" class="rules">
    <div class="muted">正在加载…</div>
  </div>
</div>

<!-- Modals -->
<div class="modal" id="modalPair" hidden></div>

<div class="modal" id="modalRule" hidden>
  <div class="modal-card">
    <div class="row between">
      <div class="h2" id="modalRuleTitle">新增规则</div>
      <button class="btn ghost" onclick="UI.close('modalRule')">关闭</button>
    </div>
    <div class="hr"></div>

    <form id="ruleForm" class="form">
      <div class="grid2">
        <label class="field">
          <span>规则名称</span>
          <input name="name" placeholder="例如：端口 443" required />
        </label>
        <label class="field">
          <span>规则类型</span>
          <select name="type">
            <option value="tcp_udp">TCP/UDP</option>
            <option value="wss_client">WSS 客户端（本机监听 → 远端 WSS）</option>
            <option value="wss_server">WSS 服务端（WSS 接收 → 内网转发）</option>
          </select>
        </label>

        <label class="field">
          <span>监听（listen）</span>
          <input name="listen" placeholder="0.0.0.0:443" required />
        </label>
        <label class="field">
          <span>协议</span>
          <select name="protocol">
            <option value="tcp+udp">TCP+UDP</option>
            <option value="tcp">TCP</option>
            <option value="udp">UDP</option>
          </select>
        </label>
      </div>

      <label class="field">
        <span>目标地址（可多行，支持负载均衡）</span>
        <textarea name="remotes" rows="4" placeholder="203.0.113.10:443\n198.51.100.8:443"></textarea>
        <small class="muted">第一行作为主目标，其余作为额外目标。多目标会自动启用负载均衡（可选算法）。</small>
      </label>

      <div class="grid2">
        <label class="field">
          <span>负载均衡算法</span>
          <select name="balance">
            <option value="roundrobin">轮询 Round Robin</option>
            <option value="iphash">IP Hash</option>
          </select>
        </label>
        <label class="field">
          <span>启用规则</span>
          <select name="enabled">
            <option value="true">启用</option>
            <option value="false">暂停</option>
          </select>
        </label>
      </div>

      <div class="card subtle">
        <div class="h3">WSS 参数（仅在 WSS 规则类型下生效）</div>
        <div class="grid2" style="margin-top: 10px;">
          <label class="field">
            <span>Host</span>
            <input name="wss_host" placeholder="例如：www.bing.com（回车=随机）" />
          </label>
          <label class="field">
            <span>Path</span>
            <input name="wss_path" placeholder="例如：/ws（回车=随机）" />
          </label>
          <label class="field">
            <span>SNI（可空）</span>
            <input name="wss_sni" placeholder="默认同 Host" />
          </label>
          <label class="field">
            <span>客户端跳过证书校验</span>
            <select name="wss_insecure">
              <option value="true">是</option>
              <option value="false">否</option>
            </select>
          </label>
        </div>
      </div>

      <div class="row gap">
        <button class="btn" type="submit" id="btnSaveRule">保存</button>
        <button class="btn ghost" type="button" onclick="UI.close('modalRule')">取消</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="modalLogs" hidden>
  <div class="modal-card" style="max-width: 980px;">
    <div class="row between">
      <div class="h2" id="logsTitle">日志</div>
      <button class="btn ghost" onclick="UI.close('modalLogs')">关闭</button>
    </div>
    <div class="hr"></div>
    <pre class="logs" id="logsBox">加载中…</pre>
  </div>
</div>

</div>
{% endblock %}

{% block scripts %}
<script>
  window.__AGENT_ID__ = "{{ agent.id }}";
</script>
{% endblock %}
