{% extends "base.html" %}
{% block content %}
<div id="toast" class="toast"></div>

<div class="split-layout">
  <!-- Left: nodes list -->
  <aside class="card node-sidebar">
    <div class="card-header">
      <div style="min-width:0;">
        <div class="card-title">节点列表</div>
        <div class="card-sub">切换查看该节点的转发规则</div>
      </div>
      <div class="right" style="flex:0 0 auto;">
        <button class="btn xs" type="button" onclick="openAddNodeModal()">接入节点</button>
      </div>
    </div>
    <div class="node-list">
      {% for n in nodes %}
      <a class="node-item{% if n.id == node.id %} active{% endif %}" href="/nodes/{{ n.id }}">
        <span class="dot {% if n.online %}online{% else %}offline{% endif %}"></span>
        <div class="node-info">
          <div class="node-name">{{ n.name or n.display_ip or ('节点-' ~ n.id) }}</div>
          <div class="node-meta mono">{{ n.display_ip or '-' }}</div>
          <div class="muted sm">{{ n.group_name or '默认分组' }}</div>
        </div>
      </a>
      {% endfor %}
    </div>
    <div class="sidebar-foot">
      <a class="btn xs ghost w100" href="/">返回控制台</a>
    </div>
  </aside>

  <!-- Right: current node rules -->
  <main class="node-main">
    <section>
      <div class="card">
        <div class="card-header node-head" style="align-items:flex-start;">
          <div class="node-head-left" style="min-width:0;">
            <div class="card-title">
              <span class="node-title">{{ node.name or node.display_ip }}</span>
              <span class="pill xs {% if node.online %}ok{% else %}ghost{% endif %}">{% if node.online %}在线{% else %}离线{% endif %}</span>
              <span id="nodeDisplayIp" class="muted sm">· {{ node.display_ip or '-' }}</span>
            </div>
            <div class="meta" style="margin-top:6px;">
              {% if node.agent_version %}<span class="meta-item">Agent：{{ node.agent_version }}</span>{% endif %}
              <span class="meta-item">心跳 <span id="nodeLastSeen" class="mono" data-last-seen-mode="full" data-last-seen="{{ node.last_seen_at or '' }}" >{{ node.last_seen_at or "-" }}</span></span>
              <span class="meta-item">分组 <span id="nodeGroupPill" class="pill xs ghost">{{ node.group_name or '默认分组' }}</span></span>
            </div>
            <div class="card-sub" style="margin-top:8px;">支持 TCP/UDP/WSS · WSS 自动同步（生成规则锁定）</div>
          </div>
          <div class="right node-tools node-head-right" style="gap:10px; flex:0 0 auto; flex-wrap:wrap; justify-content:flex-end;">
            <div class="search-pill">
              <span class="muted">🔎</span>
              <input class="input sm" id="ruleSearch" placeholder="搜索监听/目标…" oninput="setRuleFilter(this.value)">
            </div>
            <button class="btn sm" type="button" onclick="newRule()">+ 创建转发</button>
            <button class="btn sm ghost" type="button" id="autoRefreshBtn" onclick="toggleAutoRefresh()">⟳ 自动刷新：开</button>

            <details class="menu">
              <summary class="btn sm ghost">更多 ▾</summary>
              <div class="menu-pop">
                <button class="menu-item" type="button" onclick="openEditNodeModal()">编辑节点 <span class="muted sm">名称/地址/分组</span></button>
                <div class="menu-sep"></div>
                <button class="menu-item" type="button" onclick="openCommandModal('一键接入命令', window.__INSTALL_CMD__)">
                  接入命令 <span class="muted sm">复制</span>
                </button>
                <button class="menu-item" type="button" onclick="openCommandModal('一键卸载 Agent', window.__UNINSTALL_CMD__)">
                  卸载 Agent <span class="muted sm">复制</span>
                </button>
                <div class="menu-sep"></div>
                <a class="menu-item" href="/api/nodes/{{ node.id }}/backup">备份规则 <span class="muted sm">下载</span></a>
                <button class="menu-item" type="button" id="restoreRulesBtn" onclick="triggerRestore()">恢复规则 <span class="muted sm">粘贴</span></button>
                <div class="menu-sep"></div>
                <form method="post" action="/nodes/{{ node.id }}/delete" style="margin:0;">
                  <button class="menu-item" type="submit" onclick="return confirm('确认移除该节点？

仅移除面板记录，不影响节点 Agent。')" style="color:var(--bad);">
                    移除节点 <span class="muted sm">危险</span>
                  </button>
                </form>
              </div>
            </details>
          </div>
        </div>

        <div id="nodeSummary" class="summary-bar" style="display:none;"></div>

        <!-- Node system info removed (shown only in 控制台 cards) -->

        <div id="rulesLoading" class="muted">正在加载规则…</div>

        <!-- Mobile: card list (table is desktop only) -->
        <div id="rulesMobile" class="rules-mobile" style="display:none;"></div>

        <div class="table-wrap">
          <table id="rulesTable" class="table rules-table" style="display:none;">
            <thead>
              <tr>
                <th>#</th>
                <th>状态</th>
                <th class="listen">监听</th>
                <th class="health">连通</th>
                <th class="stat">活跃</th>
                <th class="stat">流量</th>
                <th class="actions">操作</th>
              </tr>
            </thead>
            <tbody id="rulesBody"></tbody>
          </table>
        </div>

        <div id="statsLoading" class="muted">正在加载流量统计…</div>
      </div>
    </section>
  </main>
</div>

<!-- Add Node Modal (for quick switching / onboarding) -->
<!-- Add Node Modal -->
<div id="addNodeModal" class="modal" style="display:none;">
  <div class="modal-inner" style="max-width:560px;">
    <div class="row" style="align-items:center;">
      <div class="col"><div class="h2">接入节点</div></div>
      <div class="col right"><button class="btn xs ghost" type="button" onclick="closeAddNodeModal()">关闭</button></div>
    </div>

    <div class="form" style="margin-top:10px;">
      <div class="row" style="gap:12px;">
        <div class="col">
          <label class="label">节点名称（可选）</label>
          <input class="input" id="addNodeName" placeholder="例如：香港-01 / US-Edge">
        </div>
        <div class="col" style="max-width:180px;">
          <label class="label">协议</label>
          <select class="select" id="addNodeScheme">
            <option value="http">http</option>
            <option value="https">https</option>
          </select>
        </div>
      </div>

      <label class="label">分组名称</label>
      <input class="input" id="addNodeGroup" placeholder="例如：香港 / 美国 / 客户A" value="默认分组">
      <div class="help">仅用于面板分类；不影响规则与转发。</div>

      <label class="label">IP/域名</label>
      <input class="input" id="addNodeIp" placeholder="例如：1.2.3.4 或 node.example.com">

      <div class="row" style="gap:12px;align-items:center;margin-top:6px;">
        <div class="col">
          <label class="help"><input type="checkbox" id="addNodeVerifyTls" style="transform:translateY(1px);"> 验证 TLS 证书（https 才需要）</label>
        </div>
      </div>

      <div id="addNodeError" class="muted" style="margin-top:8px;color:#ffb3b3;"></div>

      <div class="row" style="gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn xs ghost" type="button" onclick="closeAddNodeModal()">取消</button>
        <button class="btn xs" id="addNodeSubmit" type="button" onclick="createNodeFromModal()">创建并进入</button>
      </div>
    </div>
  </div>
</div>


<!-- Edit Node Modal -->
<div id="editNodeModal" class="modal" style="display:none;">
  <div class="modal-inner" style="max-width:560px;">
    <div class="row" style="align-items:center;">
      <div class="col"><div class="h2">编辑节点</div></div>
      <div class="col right"><button class="btn xs ghost" type="button" onclick="closeEditNodeModal()">关闭</button></div>
    </div>

    <div class="form" style="margin-top:10px;">
      <label class="label">节点名称</label>
      <input class="input" id="editNodeName" placeholder="例如：香港-01 / US-Edge">

      <div class="row" style="gap:12px; margin-top:10px;">
        <div class="col" style="max-width:180px;">
          <label class="label">协议</label>
          <select class="select" id="editNodeScheme">
            <option value="http">http</option>
            <option value="https">https</option>
          </select>
        </div>
        <div class="col">
          <label class="label">分组名称</label>
          <input class="input" id="editNodeGroup" placeholder="例如：香港 / 美国 / 客户A">
        </div>
      </div>

      <label class="label" style="margin-top:10px;">IP/域名</label>
      <input class="input" id="editNodeIp" placeholder="例如：1.2.3.4 或 node.example.com">
      <div class="help">端口无需单独填写，默认 18700；如需自定义可在地址中写 host:port（保存后仍不在列表展示端口）。</div>

      <div class="row" style="gap:12px;align-items:center;margin-top:6px;">
        <div class="col">
          <label class="help"><input type="checkbox" id="editNodeVerifyTls" style="transform:translateY(1px);"> 验证 TLS 证书（https 才需要）</label>
        </div>
      </div>

      <div id="editNodeError" class="muted" style="margin-top:8px;color:#ffb3b3;"></div>

      <div class="row" style="gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn xs ghost" type="button" onclick="closeEditNodeModal()">取消</button>
        <button class="btn xs" id="editNodeSubmit" type="button" onclick="saveEditNode()">保存</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div id="modal" class="modal" style="display:none;">
  <div class="modal-inner">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div class="col"><div class="h2" id="modalTitle">编辑规则</div></div>
      <div class="right"><button class="btn xs ghost" type="button" onclick="closeModal()">关闭</button></div>
    </div>

    <div class="form">
      <div class="row" style="gap:12px;">
        <div class="col">
          <label class="label">监听（例如 0.0.0.0:443）</label>
          <input class="input" id="f_listen" placeholder="0.0.0.0:443">
        </div>
        <div class="col" style="max-width:220px;">
          <label class="label">状态</label>
          <select class="select" id="f_disabled">
            <option value="0">启用</option>
            <option value="1">暂停</option>
          </select>
        </div>
      </div>

      <label class="label">目标地址（Remote，每行一个 host:port）</label>
      <textarea class="textarea" id="f_remotes" rows="5" placeholder="203.0.113.10:443\n198.51.100.8:443"></textarea>

      <div class="row" style="gap:12px;">
        <div class="col" style="max-width:220px;">
          <label class="label">策略</label>
          <select class="select" id="f_balance">
            <option value="roundrobin">轮询</option>
            <option value="iphash">IP Hash</option>
          </select>
        </div>
        <div class="col">
          <label class="label">权重（与 Remote 行数一致，逗号分隔，可空）</label>
          <input class="input" id="f_weights" placeholder="1,1,2">
        </div>
        <div class="col" style="max-width:220px;">
          <label class="label">协议</label>
          <select class="select" id="f_protocol">
            <option value="tcp">TCP</option>
            <option value="udp">UDP</option>
            <option value="tcp+udp">TCP+UDP</option>
          </select>
        </div>
      </div>

      <label class="label">隧道模式</label>
      <select class="select" id="f_type">
        <option value="tcp">TCP/UDP</option>
        <option value="wss">WSS 隧道</option>
      </select>

      <div id="wssBox" style="display:none;">

        <div id="wssAutoSyncBox" class="row" style="gap:12px;">
          <div class="col">
            <label class="label">接收机节点（自动同步）</label>
            <select class="select" id="f_wss_receiver_node">
              <option value="">请选择接收机…</option>
            </select>
            <div class="help">保存/删除将同步至接收机；同步生成的规则为只读。</div>
          </div>
          <div class="col" style="max-width:240px;">
            <label class="label">接收机监听端口</label>
            <input class="input" id="f_wss_receiver_port" placeholder="留空 = 与发送机 Listen 一致">
            <div class="help">留空=沿用发送机端口；如冲突自动避让。</div>
          </div>
        </div>

        <div class="row" style="gap:12px;margin-top:10px;">
          <div class="col">
            <label class="label">WSS Host</label>
            <input class="input" id="f_wss_host" placeholder="www.bing.com">
          </div>
          <div class="col">
            <label class="label">WSS Path</label>
            <input class="input" id="f_wss_path" placeholder="/ws">
          </div>
        </div>

        <div class="row" style="gap:12px;align-items:center;">
          <div class="col">
            <div class="help">Host/Path/SNI 建议与证书域名一致；兼容模式可启用「跳过校验」。</div>
          </div>
          <div class="right" style="flex:0 0 auto;">
            <button class="btn xs ghost" type="button" onclick="randomizeWss()">随机生成参数</button>
          </div>
        </div>

        <div class="row" style="gap:12px;">
          <div class="col">
            <label class="label">SNI</label>
            <input class="input" id="f_wss_sni" placeholder="www.bing.com">
          </div>
          <div class="col" style="max-width:220px;">
            <label class="label">TLS</label>
            <select class="select" id="f_wss_tls">
              <option value="1">启用</option>
              <option value="0">关闭</option>
            </select>
          </div>
          <div class="col" style="max-width:220px;">
            <label class="label" style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="f_wss_insecure" checked style="width:auto;margin:0;">
              跳过证书校验
            </label>
            <div class="help">兼容性更好，但安全性降低。</div>
          </div>
        </div>

      </div>

      <div class="row" style="gap:10px; justify-content:flex-end;">
        <button class="btn xs ghost" type="button" onclick="closeModal()">取消</button>
        <button class="btn xs" type="button" onclick="saveRule()">保存</button>
      </div>

      <div id="modalMsg" class="form-error" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

<div id="restoreModal" class="modal" style="display:none;">
  <div class="modal-inner" style="max-width:860px;">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div class="col"><div class="h2">恢复规则</div></div>
      <div class="right"><button class="btn xs ghost" type="button" onclick="closeRestoreModal()">关闭</button></div>
    </div>
    <div class="form">
      <label class="label">粘贴备份文件内容（JSON）</label>
      <textarea class="textarea" id="restoreText" rows="14" placeholder='{
  "ok": true,
  "pool": {
    "endpoints": []
  }
}'></textarea>
      <div class="row" style="gap:10px;justify-content:flex-end;margin-top:12px;">
        <button class="btn xs ghost" type="button" onclick="closeRestoreModal()">取消</button>
        <button class="btn xs" type="button" onclick="restoreFromText()">开始恢复</button>
      </div>
    </div>
  </div>
</div>

<div id="commandModal" class="modal" style="display:none;">
  <div class="modal-inner">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div class="col"><div class="h2" id="commandTitle">命令</div></div>
      <div class="right"><button class="btn xs ghost" type="button" onclick="closeCommandModal()">关闭</button></div>
    </div>
    <p class="muted" style="margin-top:8px;">在目标节点执行以下命令即可。</p>
    <pre class="code-block" id="commandText"></pre>
    <div class="row" style="justify-content:flex-end;">
      <button class="btn xs" data-copy-target="commandText">复制命令</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/app.js?v=41.4"></script>
<script>
window.__NODE_ID__ = {{ node.id }};
window.__NODE_IP__ = {{ (node.display_ip or node.name)|tojson }};
window.__NODE_NAME__ = {{ (node.name or '')|tojson }};
window.__NODE_BASE_URL__ = {{ (node.base_url or '')|tojson }};
window.__NODE_VERIFY_TLS__ = {{ (1 if node.verify_tls else 0) }};
window.__NODE_GROUP__ = {{ (node.group_name or '默认分组')|tojson }};
window.__INSTALL_CMD__ = {{ install_cmd|tojson }};
window.__UNINSTALL_CMD__ = {{ uninstall_cmd|tojson }};
window.__AUTO_OPEN_EDIT_NODE__ = {{ (1 if show_edit_node else 0) }};
window.addEventListener('DOMContentLoaded', () => {
  initNodePage();
});

document.querySelectorAll('[data-copy-target]').forEach((btn)=>{
  btn.addEventListener('click', async ()=>{
    const id = btn.getAttribute('data-copy-target');
    const text = document.getElementById(id).textContent.trim();
    try{
      await navigator.clipboard.writeText(text);
      const original = btn.dataset._orig || btn.textContent;
      btn.dataset._orig = original;
      btn.textContent = '已复制';
      setTimeout(()=>{ btn.textContent = original; }, 1200);
    }catch(e){
      alert('复制失败：浏览器不允许访问剪贴板，请手动复制。');
    }
  });
});

{% if show_install_cmd %}
openCommandModal('一键接入命令', window.__INSTALL_CMD__);
{% endif %}
</script>
{% endblock %}
