{% extends "base.html" %}
{% block title %}Realm Pro Panel - 节点{% endblock %}
{% block content %}

<div class="grid" style="grid-template-columns: 1.2fr 0.8fr;">
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="title">节点列表</div>
        <div class="small">一个面板管理多个 Agent。Agent 通过 Token 鉴权；面板访问需登录验证（安装时设置）。</div>
      </div>
      <div class="row" style="gap:8px;">
        <a class="btn" href="/">刷新</a>
      </div>
    </div>

    <div id="agentsList" class="table" style="margin-top:14px;">
      <table>
        <thead>
          <tr>
            <th>名称</th>
            <th>API 地址</th>
            <th>状态</th>
            <th>最后在线</th>
            <th style="text-align:right;">操作</th>
          </tr>
        </thead>
        <tbody>
        {% for n in nodes %}
          <tr data-node-row="{{n.id}}">
            <td>
              <a class="link" href="/nodes/{{n.id}}">{{n.name}}</a>
              <div class="small mono">{{n.id}}</div>
            </td>
            <td class="mono">{{n.base_url}}</td>
            <td class="agent-status" data-node-status="{{n.id}}">
              <span class="badge"><span class="dot"></span>加载中</span>
            </td>
            <td class="small" data-node-last="{{n.id}}">-</td>
            <td style="text-align:right;">
              <form method="post" action="/nodes/{{n.id}}/delete" style="display:inline" onsubmit="return confirm('确定删除该节点？')">
                <button class="btn" type="submit">删除</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        {% if nodes|length == 0 %}
          <tr>
            <td colspan="5" class="small">暂无节点。请右侧添加 Agent。</td>
          </tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="title">添加 Agent</div>
    <div class="small" style="margin-top:4px;">在被控机运行 realm_agent.sh 安装后，会输出 Token。
      将 Token 填到这里即可管理。</div>

    {% if error %}
      <div class="error" style="margin-top:12px;">{{error}}</div>
    {% endif %}

    <form method="post" action="/nodes/add" style="margin-top:12px;" autocomplete="off">
      <div class="grid" style="grid-template-columns: 1fr; gap:10px;">
        <div>
          <label>名称</label>
          <input name="name" placeholder="例如：HK-1" required />
        </div>
        <div>
          <label>API 地址</label>
          <input name="base_url" placeholder="http://10.0.0.2:6080" required />
          <div class="small">支持 http / https。若 Agent 开启 TLS，请写 https。</div>
        </div>
        <div>
          <label>Token</label>
          <input name="api_key" placeholder="粘贴 Agent Token" required />
        </div>
        <div class="row" style="justify-content:space-between;">
          <label class="row" style="gap:8px; align-items:center;">
            <input type="checkbox" name="verify_tls" value="1" />
            <span class="small">验证 Agent TLS 证书</span>
          </label>
          <button class="btn primary" type="submit">添加</button>
        </div>
      </div>
    </form>

    <div class="notice" style="margin-top:14px;">
      <div class="small">
        <b>说明：</b>面板登录用于保护访问权限；节点仍然通过 Token 对接。<br/>
        <b>配对码仅用于 WSS 规则</b>：在 WSS 服务端创建规则后生成对接码，
        在 WSS 客户端创建规则时输入对接码即可自动同步参数。
      </div>
    </div>
  </div>
</div>

{% endblock %}
