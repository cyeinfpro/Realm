{% extends "base.html" %}
{% block title %}Realm Pro Panel - {{agent.name}}{% endblock %}
{% block body %}

<div data-agent-id="{{agent.id}}"></div>

<div class="row" style="justify-content:space-between; align-items:flex-start;">
  <div>
    <div class="title">{{agent.name}}</div>
    <div class="small mono">{{agent.api_url}} · {{agent.id}}</div>
  </div>
  <div class="row" style="gap:8px;">
    <a class="btn" href="/">返回</a>
    <button id="btnAddRule" class="btn primary" type="button">新增规则</button>
    <button id="btnApply" class="btn" type="button">一键应用</button>
  </div>
</div>

{% if error %}
  <div class="error" style="margin-top:12px;">{{error}}</div>
{% endif %}

<div class="grid" style="margin-top:14px; grid-template-columns: 1fr 1fr;">
  <div class="card">
    <div class="title">服务状态</div>
    <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap">
      <div class="stat">
        <div class="small">在线</div>
        <div id="svOnline" class="mono">-</div>
      </div>
      <div class="stat">
        <div class="small">realm</div>
        <div id="svRealm" class="mono">-</div>
      </div>
      <div class="stat">
        <div class="small">realm-monitor</div>
        <div id="svMon" class="mono">-</div>
      </div>
      <div class="stat">
        <div class="small">规则数</div>
        <div id="svRules" class="mono">-</div>
      </div>
    </div>
    <div class="small" style="margin-top:10px;">最后更新：<span id="svUpdated" class="mono">-</span></div>
  </div>

  <div class="card">
    <div class="title">安装与对接</div>
    <div class="small" style="margin-top:8px;">Agent Token 已保存在面板。若需要重新部署，可在目标机运行：</div>
    <div class="mono" style="margin-top:10px; padding:12px; background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:14px; overflow:auto;">
      curl -fsSL {{repo_base}}/realm_agent.sh | bash
    </div>
    <div class="small" style="margin-top:8px;">提示：此安装脚本会自动生成 Token 并输出。你可以把新 Token 更新到节点配置里。</div>
  </div>
</div>

<div class="card" style="margin-top:14px;">
  <div class="row" style="justify-content:space-between; align-items:center;">
    <div>
      <div class="title">规则与监控</div>
      <div class="small">支持 TCP/UDP、负载均衡、WSS 服务端/客户端。暂停规则将立即生效（iptables + realm 配置）。</div>
    </div>
    <div class="row" style="gap:8px;">
      <button class="btn" type="button" onclick="refreshAgentDetail()">刷新</button>
    </div>
  </div>

  <div id="rulesWrap" style="margin-top:14px;">
    <div class="small">加载中…</div>
  </div>
</div>

<!-- Modal: Add Rule -->
<div id="ruleModal" class="modal hidden">
  <div class="backdrop" id="modalBackdrop"></div>
  <div class="modal-card">
    <div class="modal-head">
      <h2>新增规则</h2>
      <button class="btn" id="btnCloseModal" type="button">关闭</button>
    </div>

    <div id="pairResult" class="notice hidden"></div>

    <form id="ruleForm" style="margin-top:12px;">
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
          <label>规则名称</label>
          <input name="name" placeholder="例如：HTTPS" required />
        </div>
        <div>
          <label>监听端口</label>
          <input name="listen_port" type="number" min="1" max="65535" placeholder="443" required />
        </div>
        <div>
          <label>类型</label>
          <select name="type" id="ruleType">
            <option value="tcp_udp">TCP/UDP</option>
            <option value="wss_server">WSS 服务端</option>
            <option value="wss_client">WSS 客户端</option>
          </select>
        </div>
        <div id="lbBox" class="hidden">
          <label>负载均衡算法</label>
          <select name="balance">
            <option value="round_robin">Round Robin</option>
            <option value="ip_hash">IP Hash</option>
          </select>
          <div class="small">当目标有多个时生效。</div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>目标地址（每行一个 host:port）</label>
        <textarea name="targets" rows="5" placeholder="203.0.113.10:443\n198.51.100.8:443" required></textarea>
      </div>

      <div id="wssBox" class="hidden" style="margin-top:10px;">
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
          <div id="pairCodeBox" class="hidden">
            <label>对接码（用于自动获取参数）</label>
            <input name="wss_pair_code" placeholder="例如：482913" />
            <div class="small">在 WSS 服务端创建规则后会生成对接码。</div>
          </div>
          <div>
            <label>WSS Host</label>
            <input name="wss_host" placeholder="www.bing.com" />
          </div>
          <div>
            <label>WSS Path</label>
            <input name="wss_path" placeholder="/ws" />
          </div>
          <div>
            <label>SNI</label>
            <input name="wss_sni" placeholder="www.bing.com" />
          </div>
          <div class="row" style="align-items:center; gap:10px;">
            <label class="row" style="gap:8px; align-items:center;">
              <input type="checkbox" name="wss_insecure" value="1" checked />
              <span class="small">忽略 TLS 校验（自签证书时建议勾选）</span>
            </label>
          </div>
        </div>

        <div class="notice" style="margin-top:10px;">
          <div class="small"><b>WSS 配对逻辑：</b>先在服务端创建规则 → 复制对接码 → 客户端创建规则时输入对接码 → Host/Path/SNI 自动同步。</div>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end; gap:10px; margin-top:14px;">
        <button class="btn" type="button" id="btnCancel">取消</button>
        <button class="btn primary" type="submit">创建</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}
